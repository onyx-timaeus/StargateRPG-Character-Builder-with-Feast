<!DOCTYPE html>

<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Stargate RPG Character Editor</title>
    <script crossorigin src="https://unpkg.com/react@18/umd/react.development.js"></script>
    <script crossorigin src="https://unpkg.com/react-dom@18/umd/react-dom.development.js"></script>
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        /* Custom styles for better appearance */
        body {
            margin: 0;
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', 'Roboto', 'Oxygen', 'Ubuntu', 'Cantarell', 'Fira Sans', 'Droid Sans', 'Helvetica Neue', sans-serif;
        }

    /* Simple icon replacements using CSS */
    .icon {
        display: inline-block;
        width: 1rem;
        height: 1rem;
        background-size: contain;
        vertical-align: middle;
    }
    
    .icon-target::before { content: "üéØ"; }
    .icon-user::before { content: "üë§"; }
    .icon-shield::before { content: "üõ°Ô∏è"; }
    .icon-heart::before { content: "‚ù§Ô∏è"; }
    .icon-zap::before { content: "‚ö°"; }
    .icon-brain::before { content: "üß†"; }
    .icon-activity::before { content: "üìà"; }
    .icon-download::before { content: "üíæ"; }
    .icon-alert::before { content: "‚ö†Ô∏è"; }
    .icon-info::before { content: "‚ÑπÔ∏è"; }
    .icon-sparkles::before { content: "‚ú®"; }
    .icon-chevron-down::before { content: "‚ñº"; }
    .icon-star::before { content: "‚≠ê"; }
    .icon-check::before { content: "‚úÖ"; }
    .icon-x::before { content: "‚ùå"; }
    .icon-coins::before { content: "ü™ô"; }
</style>
</head>
<body>
    <div id="root"></div>

<script type="text/babel">
    const { useState, useEffect } = React;

    const StargateCharacterEditor = () => {
        // Character state
        const [character, setCharacter] = useState({
            name: '',
            race: '',
            subrace: '',
            abilityChoice: '',
            origins: [],
            originChoices: {},
            raceChoices: {},
            class: '',
            level: 1,
            classFeats: [],
            generalFeats: [],
            bonusFeats: [],
            totalMP: 0,
            spentMP: 0,
            abilityScoreImprovements: {},
            abilityScores: {
                strength: 10,
                dexterity: 10,
                constitution: 10,
                intelligence: 10,
                wisdom: 10,
                charisma: 10
            },
            hp: 0,
            maxHp: 0,
            determinationPoints: 0,
            armorClass: 10,
            speed: 6,
            initiative: 0,
            moxie: 0,
            proficiencies: {
                armor: [],
                weapons: [],
                tools: [],
                saves: [],
                skills: []
            }
        });

        // State for feat category selection
        const [selectedFeatCategory, setSelectedFeatCategory] = useState('general');

        // Complete feat database (simplified for testing)
        const featCategories = {
            general: {
                name: "General Feats",
                description: "Broad abilities available to all characters, covering various aspects of character development.",
                feats: [
                    { name: 'Ability Score Increase', mpCost: 7, requirements: [], description: 'An ability score of your choice is increased by +1. No ability score can be raised above 20 this way.' },
                    { name: 'Advanced Training: Diplomat', mpCost: 9, requirements: ['Charisma 13+', 'Persuasion'], description: 'You gain the Diplomat\'s Inspire ability.' },
                    { name: 'Advanced Training: Engineer', mpCost: 9, requirements: ['Intelligence 13+', 'Engineering'], description: 'You gain the Engineer\'s Jury Rig ability.' },
                    { name: 'Airborne School', mpCost: 3, requirements: ['Athletics'], description: 'You gain resistance to falling damage. You gain advantage on any check to open a parachute at altitudes below 1km.' },
                    { name: 'Determined', mpCost: 3, requirements: [], description: 'You increase your base Determination Points by +1. This feat may be purchased multiple times.' }
                ]
            },
            combat: {
                name: "Combat Feats",
                description: "Specialized combat abilities that enhance fighting effectiveness in various situations.",
                feats: [
                    { name: 'Attack Specialist', mpCost: 4, requirements: ['Level 5'], description: 'Choose one weapon proficiency. When making attacks with that proficiency you roll twice as many weapon damage dice as normal.' },
                    { name: 'Attack Veteran', mpCost: 4, requirements: ['Level 11', 'Attack Specialist'], description: 'Choose one weapon proficiency you have Attack Specialist for. You now roll triple damage dice instead of double.' },
                    { name: 'Attack Ace', mpCost: 4, requirements: ['Level 17', 'Attack Veteran'], description: 'Choose one weapon proficiency you have Attack Veteran for. You now roll quadruple damage dice instead of triple.' },
                    { name: 'Critical Focus', mpCost: 5, requirements: ['Proficient with chosen weapon'], description: 'Choose a weapon proficiency. When you score a critical hit with that type of weapon, add your Proficiency bonus to the damage dealt.' },
                    { name: 'Dodge', mpCost: 5, requirements: ['Dexterity 13+'], description: 'You add +1 to your AC when wearing light or no armor.' }
                ]
            },
            inspiration: {
                name: "Inspiration Feats",
                description: "Team support abilities that enhance allies through the Inspire ability. Most desired by Diplomats.",
                feats: [
                    { name: 'Calm and Collected', mpCost: 5, requirements: ['Inspire ability'], description: 'During a long rest, choose Intelligence, Wisdom, or Charisma. Inspired characters gain advantage on the chosen save until your next long rest.' },
                    { name: 'Clear Focus', mpCost: 5, requirements: ['Inspire ability'], description: 'During a long rest, choose a skill in which you are proficient. Inspired characters gain advantage on the chosen skill until your next long rest.' },
                    { name: 'Defensive Motivation', mpCost: 5, requirements: ['Inspire ability'], description: 'Inspired characters gain +1 AC.' }
                ]
            },
            modification: {
                name: "Modification Feats", 
                description: "Equipment enhancement abilities that improve team gear. Most desired by Engineers.",
                feats: [
                    { name: 'Armorer', mpCost: 5, requirements: ['Jury Rig ability'], description: 'During a long rest, you may choose one character\'s armor. It gains +1 AC until your next long rest. Can be taken multiple times.' },
                    { name: 'Grenadier', mpCost: 5, requirements: ['Jury Rig ability'], description: 'Grenades from your kit deal +1d6 damage when used by you. Can be taken multiple times for additional +1d6 damage.' },
                    { name: 'Comms Tech', mpCost: 5, requirements: ['Jury Rig ability'], description: 'Your team\'s tactical radio equipment has a range of 20km (instead of 5km). Communications balloon duration increases to 15d6 hours.' }
                ]
            }
        };

        // Complete race data matching official Stargate RPG rules
        const races = {
            'Human': {
                subraces: {
                    'Standard Human': {
                        hitPoints: 10,
                        abilityIncrease: { type: 'choice', options: ['intelligence', 'charisma'], value: 2 },
                        abilities: [
                            'Recovery: Regain +TD HP on short rest',
                            'Galactic Seeds: Advantage on Persuasion/Deception during first contact'
                        ],
                        proficiencies: {
                            skills: { type: 'choice', count: 2, options: 'any' }
                        }
                    },
                    'Abydonian': {
                        hitPoints: 10,
                        abilityIncrease: { type: 'choice', options: ['constitution', 'charisma'], value: 2 },
                        abilities: [
                            'Recovery: Regain +TD HP on short rest',
                            'Free from Ra: Advantage on saves against Goa\'uld technology'
                        ],
                        proficiencies: {
                            skills: { type: 'choice', count: 1, options: 'any' },
                            weapons: { type: 'choice', count: 1, options: 'any' }
                        }
                    },
                    'Tollan': {
                        hitPoints: 8,
                        abilityIncrease: { type: 'choice', options: ['intelligence', 'wisdom'], value: 2 },
                        abilities: [
                            'Phase-Shift: Add phase device to base kit',
                            'Advanced Technology: +TD to Engineering checks for Tech Level 4+'
                        ],
                        proficiencies: {
                            skills: {
                                type: 'mixed',
                                fixed: ['Science'],
                                additionalChoice: { count: 1, options: 'any' }
                            }
                        }
                    }
                }
            },
            'Jaffa': {
                subraces: {
                    'Jaffa (With Symbiote)': {
                        hitPoints: 12,
                        abilityIncrease: { type: 'choice', options: ['strength', 'dexterity'], value: 2 },
                        abilities: [
                            'Symbiote: Advantage on physical saves (once per Proficiency bonus per long rest)',
                            'Kelno\'reem: Heal damage as if HD rolled max during long rest',
                            'Proficiency with Jaffa weapons'
                        ],
                        proficiencies: {
                            weapons: { type: 'fixed', list: ['Jaffa Weapons'] },
                            skills: { type: 'choice', count: 1, options: 'any' }
                        }
                    },
                    'Free Jaffa (Tretonin)': {
                        hitPoints: 10,
                        abilityIncrease: { type: 'choice', options: ['dexterity', 'wisdom'], value: 2 },
                        abilities: [
                            'Resistance Training: Half proficiency bonus to attack rolls with non-proficient weapons',
                            'Tretonin Prescription: Advantage on saves vs disease, suffer 1d4 Con damage daily without drug',
                            'Proficiency with Jaffa weapons'
                        ],
                        proficiencies: {
                            weapons: { type: 'fixed', list: ['Jaffa Weapons'] },
                            skills: { type: 'choice', count: 1, options: ['skill', 'equipment'] }
                        }
                    }
                }
            }
        };

        // Helper function to describe proficiencies for preview
        const getProficiencyDescription = (proficiencies) => {
            const descriptions = [];

            if (proficiencies?.skills) {
                if (proficiencies.skills.type === 'choice') {
                    descriptions.push(`Choose ${proficiencies.skills.count} skill${proficiencies.skills.count > 1 ? 's' : ''}`);
                } else if (proficiencies.skills.type === 'mixed') {
                    const fixedSkills = proficiencies.skills.fixed.join(', ');
                    descriptions.push(`${fixedSkills} (fixed)`);
                    if (proficiencies.skills.additionalChoice) {
                        descriptions.push(`Choose ${proficiencies.skills.additionalChoice.count} additional skill${proficiencies.skills.additionalChoice.count > 1 ? 's' : ''}`);
                    }
                }
            }

            if (proficiencies?.weapons) {
                if (proficiencies.weapons.type === 'choice') {
                    descriptions.push(`Choose ${proficiencies.weapons.count} weapon proficiency`);
                } else if (proficiencies.weapons.type === 'fixed') {
                    descriptions.push(`${proficiencies.weapons.list.join(', ')} (fixed)`);
                }
            }

            return descriptions;
        };

        // Class data
        const classes = {
            'Diplomat': {
                hitDie: 8,
                hpPerLevel: 5,
                determinationBonus: 2,
                proficiencies: {
                    armor: ['Light Armor'],
                    weapons: ['Common Weapons', 'Sidearms'],
                    tools: ['Research Kit'],
                    saves: ['Wisdom', 'Charisma'],
                    skills: ['Culture', 'Deception', 'Insight', 'Persuasion']
                },
                abilities: {
                    1: ['Inspire (1d6 temp HP to team during long rest)', 'Choose Inspiration feat'],
                    2: ['Pep Talk (restore 1d4 DP to team once per mission)', 'Word In An Ear (inspire single target)'],
                    3: ['Force of Will (use Inspire on short/long rest)', 'Choose 2nd Inspiration feat'],
                    4: ['Diplomatic Expertise (double proficiency)', 'Ability Score Improvement'],
                    5: ['Strong Personality (Inspire die to 1d8)', 'Choose 3rd Inspiration feat']
                },
                featChoices: {
                    1: { type: 'inspiration', count: 1 },
                    3: { type: 'inspiration', count: 1 },
                    5: { type: 'inspiration', count: 1 }
                }
            },
            'Engineer': {
                hitDie: 8,
                hpPerLevel: 5,
                determinationBonus: 2,
                proficiencies: {
                    armor: ['Light Armor'],
                    weapons: ['Common Weapons', 'Sidearms', 'Longarms'],
                    tools: ['Engineering Kit', 'Explosives', 'Fabrication Kit'],
                    saves: ['Dexterity', 'Intelligence'],
                    skills: ['Engineering', 'Pilot', 'Perception']
                },
                abilities: {
                    1: ['Jury Rig (2d8 repair, action repair)', 'Choose Modification feat'],
                    2: ['Hold Together (resistance with cover)', 'Whack-It (1d6 temp HP bonus action)'],
                    3: ['Tune-Up (+Int to repairs)', 'Choose 2nd Modification feat'],
                    4: ['Broad Spectrum Scanners (Int for Perception)', 'Ability Score Improvement'],
                    5: ['Xeno-Tech Specialist (reduce R&D time)', 'Choose 3rd Modification feat']
                },
                featChoices: {
                    1: { type: 'modification', count: 1 },
                    3: { type: 'modification', count: 1 },
                    5: { type: 'modification', count: 1 }
                }
            },
            'Soldier': {
                hitDie: 10,
                hpPerLevel: 6,
                determinationBonus: 1,
                proficiencies: {
                    armor: ['Light Armor', 'Heavy Armor'],
                    weapons: ['Common Weapons', 'Martial Arts', 'Sidearms', 'Longarms'],
                    tools: ['Camo Kit', 'Explosives'],
                    saves: ['Strength', 'Constitution'],
                    skills: ['Athletics', 'Intimidation', 'Pilot']
                },
                abilities: {
                    1: ['Tactical Flexibility (activate unknown tactic)', 'Choose Tactic feat'],
                    2: ['Surge (extra action, once per rest)', 'Rally (heal TD HP when wounded at combat start)'],
                    3: ['Martial Training (min d8 melee damage)', 'Improved Critical (19-20 with chosen weapon)'],
                    4: ['Ability Score Improvement', 'Choose 2nd Tactic feat'],
                    5: ['Tactical Superiority (two tactics active)']
                },
                featChoices: {
                    1: { type: 'tactic', count: 1 },
                    4: { type: 'tactic', count: 1 }
                }
            }
        };

        // Available options
        const availableSkills = [
            'Acrobatics', 'Athletics', 'Culture', 'Deception', 'Engineering',
            'Insight', 'Intimidation', 'Investigation', 'Medicine', 'Nature',
            'Perception', 'Performance', 'Persuasion', 'Pilot', 'Science',
            'Sleight of Hand', 'Stealth', 'Survival'
        ];

        const availableWeapons = [
            'Common Weapons', 'Bows', 'Martial Arts', 'Sidearms',
            'Shotguns', 'Longarms', 'Grenades', 'Heavy Ordinance',
            'Jaffa Weapons'
        ];

        const availableArmor = [
            'Light Armor', 'Medium Armor', 'Heavy Armor', 'Shields'
        ];

        const availableTools = [
            'Camo Kit', 'Explosives', 'Med Kit', 'Research Kit',
            'Surgical Kit', 'Translator', 'Thieves\' Tools',
            'Tok\'ra tunneling crystals', 'Engineering tools'
        ];

        // Origins data
        const origins = {
            biome: [
                { name: 'Lunar', attribute: 'Dexterity +1', ability: 'Eager Astronomer: Advantage on Science checks pertaining to astronomy' },
                { name: 'Arboreal', attribute: 'Strength +1', ability: 'Natural Climber: Climb speed of 6m' },
                { name: 'Mountainous', attribute: 'Strength +1', ability: 'Vertical Drop: Half falling damage' },
                { name: 'Artificial', attribute: 'Wisdom +1', ability: 'Life or Death Repairs: Advantage on engineering when failure would deal damage' },
                { name: 'Oceanic', attribute: 'Wisdom +1', ability: 'Gifted Swimmer: Swim speed of 6m' },
                { name: 'Desert', attribute: 'Charisma +1', ability: 'Heat Acclimated: Resistance to fire damage' },
                { name: 'Rainforest', attribute: 'Charisma +1', ability: 'Tropics Adept: No disadvantage from rain or fog' },
                { name: 'Grasslands', attribute: 'Constitution +1', ability: 'Natural Sprinter: +1m movement speed' },
                { name: 'Starship', attribute: 'Dexterity +1', ability: 'Void Adept: Use Wis for Science checks' },
                { name: 'Terraformed', attribute: 'Intelligence +1', ability: 'Strange World: 1/day reaction for advantage on save' },
                { name: 'Swamp', attribute: 'Wisdom +1', ability: 'Patient Hunter: Use Wis for Stealth checks' },
                { name: 'Toxic', attribute: 'Constitution +1', ability: 'Toxic Resistance: Resist poison or necrotic (choose one)' },
                { name: 'Urban', attribute: 'Intelligence +1', ability: 'Melting Pot: Use Cha for Culture checks' },
                { name: 'Tundra', attribute: 'Constitution +1', ability: 'Cold Acclimated: Resistance to cold damage' },
                { name: 'Volcanic', attribute: 'Strength +1', ability: 'Heat Acclimated: Resistance to fire damage' },
                { name: 'Subterranean', attribute: 'Dexterity +1', ability: 'Improved Vision: Dim light counts as bright' }
            ],
            background: [
                { name: 'Enforcement', proficiency: 'Intimidation', ability: 'Air of Authority: Others have disadvantage to intimidate you' },
                { name: 'Aviator', proficiency: 'Pilot', ability: 'Crash Landing: Resistance to damage when vehicle crashes' },
                { name: 'Driver', proficiency: 'Animal Handling', ability: 'Speedster: Vehicles/animals you control gain +1 AC' },
                { name: 'Enslaved', proficiency: { type: 'choice', options: ['Tool'] }, ability: 'Friend to Toil: Suffer 1 less exhaustion level (min 1)' },
                { name: 'Former Host', proficiency: 'None', ability: 'Naquadah Blooded: Can use Goa\'uld tech, advantage vs symbiotes' },
                { name: 'Entertainer', proficiency: 'Performance', ability: 'Zeitgeist: Use Cha for art/performance understanding' },
                { name: 'Freedom Fighter', proficiency: 'Stealth', ability: 'Last Resorts: Disadvantage on Moxie, advantage on Initiative' },
                { name: 'Healer', proficiency: 'Medicine', ability: 'Soothe: Team heals +Prof bonus on rest' },
                { name: 'Military', proficiency: { type: 'choice', options: ['Weapon', 'Armor'] }, ability: 'Drills: +1 HP per level' }
            ],
            racial: {
                'Human': [
                    { name: 'Tau\'ri Military', attribute: 'None', proficiency: { type: 'choice', options: ['Martial Arts', 'Longarms', 'Heavy Armor'] }, ability: 'Basic Training: Chosen proficiency from military service' }
                ],
                'Jaffa': [
                    { name: 'Jaffa Renegade', attribute: 'Wisdom +1', ability: 'Rebel: Advantage on saves vs Goa\'uld and Jaffa' },
                    { name: 'Student of Bra\'tac', attribute: 'Dexterity +1', ability: 'Ma\'tok Mastery: Ma\'tok gains finesse property' }
                ]
            }
        };

        // Calculate ability modifier
        const getModifier = (score) => {
            return Math.floor((score - 10) / 2);
        };

        // Calculate bonuses for each ability score
        const getAbilityBonuses = (ability) => {
            let racialBonus = 0;
            let originBonus = 0;
            let asiBonus = 0;

            // Racial bonus
            const raceData = races[character.race]?.subraces[character.subrace];
            if (raceData && raceData.abilityIncrease) {
                if (raceData.abilityIncrease.type === 'choice' && character.abilityChoice === ability) {
                    racialBonus = raceData.abilityIncrease.value;
                } else if (!raceData.abilityIncrease.type && raceData.abilityIncrease[ability]) {
                    racialBonus = raceData.abilityIncrease[ability];
                }
            }

            // Origin bonuses
            character.origins.forEach(originName => {
                const biomeOrigin = origins.biome.find(o => o.name === originName);
                const racialOrigin = Object.values(origins.racial).flat().find(o => o.name === originName);
                
                if (biomeOrigin && biomeOrigin.attribute !== 'None') {
                    const [attr, val] = biomeOrigin.attribute.split(' +');
                    if (attr.toLowerCase() === ability) {
                        originBonus += parseInt(val);
                    }
                }
                
                if (racialOrigin && racialOrigin.attribute !== 'None') {
                    const [attr, val] = racialOrigin.attribute.split(' +');
                    if (attr.toLowerCase() === ability) {
                        originBonus += parseInt(val);
                    }
                }
            });

            // Ability Score Improvements at level 4
            if (character.level >= 4 && character.abilityScoreImprovements) {
                Object.values(character.abilityScoreImprovements).forEach(improvement => {
                    if (improvement === ability) {
                        asiBonus += 1;
                    } else if (improvement === `${ability}_2`) {
                        asiBonus += 2;
                    }
                });
            }

            return { racialBonus, originBonus, asiBonus };
        };

        // Get final ability scores with racial modifiers
        const getFinalAbilityScores = () => {
            const finalScores = { ...character.abilityScores };

            Object.keys(finalScores).forEach(ability => {
                const { racialBonus, originBonus, asiBonus } = getAbilityBonuses(ability);
                finalScores[ability] += racialBonus + originBonus + asiBonus;
            });

            return finalScores;
        };

        // Calculate HP with breakdown
        const getHPBreakdown = () => {
            const breakdown = {
                classBase: 0,
                conModifier: 0,
                raceBonus: 0,
                levelBonus: 0,
                militaryBonus: 0,
                total: 0
            };

            if (!character.race || !character.subrace || !character.class) return breakdown;

            const raceData = races[character.race]?.subraces[character.subrace];
            const classData = classes[character.class];
            const finalScores = getFinalAbilityScores();
            const conMod = getModifier(finalScores.constitution);

            breakdown.classBase = classData.hitDie;
            breakdown.conModifier = conMod;
            breakdown.raceBonus = raceData.hitPoints;

            // Check for Military origin bonus
            if (character.origins.includes('Military')) {
                breakdown.militaryBonus = character.level;
            }

            // Calculate level bonus
            if (character.level > 1) {
                breakdown.levelBonus = (character.level - 1) * (classData.hpPerLevel + conMod);
            }

            breakdown.total = Math.max(1, 
                breakdown.classBase + 
                breakdown.conModifier + 
                breakdown.raceBonus + 
                breakdown.levelBonus +
                breakdown.militaryBonus
            );

            return breakdown;
        };

        // Calculate determination with breakdown
        const getDeterminationBreakdown = () => {
            const breakdown = {
                base: Math.floor((character.level + 4) / 5) * 2,
                classBonus: 0,
                total: 0
            };

            if (character.class) {
                breakdown.classBonus = classes[character.class].determinationBonus;
            }

            breakdown.total = breakdown.base + breakdown.classBonus;
            return breakdown;
        };

        // Calculate AC with breakdown
        const getACBreakdown = () => {
            const finalScores = getFinalAbilityScores();
            const dexMod = getModifier(finalScores.dexterity);

            const breakdown = {
                base: 10,
                dexModifier: dexMod,
                armorBonus: 0,
                total: 10 + dexMod
            };

            return breakdown;
        };

        // Calculate Initiative with breakdown
        const getInitiativeBreakdown = () => {
            const finalScores = getFinalAbilityScores();
            const dexMod = getModifier(finalScores.dexterity);
            const wisMod = getModifier(finalScores.wisdom);

            return {
                dexModifier: dexMod,
                wisModifier: wisMod,
                total: Math.max(dexMod, wisMod)
            };
        };

        // Calculate Moxie with breakdown
        const getMoxieBreakdown = () => {
            const finalScores = getFinalAbilityScores();
            const intMod = getModifier(finalScores.intelligence);
            const chaMod = getModifier(finalScores.charisma);

            return {
                intModifier: intMod,
                chaModifier: chaMod,
                total: Math.max(intMod, chaMod)
            };
        };

        // FIXED: Calculate Mission Points (MP) - Simple formula: (level-5) * 10
        const calculateMP = () => {
            if (character.level <= 5) return { total: 0, available: 0, spent: 0 };
            
            const totalMP = (character.level - 5) * 10;
            
            const spentMP = character.generalFeats.reduce((sum, featName) => {
                for (const category of Object.values(featCategories)) {
                    const feat = category.feats.find(f => f.name === featName);
                    if (feat) return sum + feat.mpCost;
                }
                return sum;
            }, 0);

            return { 
                total: totalMP, 
                spent: spentMP,
                available: totalMP - spentMP 
            };
        };

        // Get automatic bonus feats based on level
        const getBonusFeats = () => {
            const bonusFeats = [];
            if (character.level >= 5) bonusFeats.push('Attack Specialist');
            if (character.level >= 11) bonusFeats.push('Attack Veteran'); 
            if (character.level >= 17) bonusFeats.push('Attack Ace');
            return bonusFeats;
        };

        // Check feat requirements
        const checkFeatRequirements = (feat) => {
            const finalScores = getFinalAbilityScores();
            const unmetRequirements = [];

            for (const requirement of feat.requirements) {
                let isMet = false;

                if (requirement.includes('13+')) {
                    const ability = requirement.replace(' 13+', '').toLowerCase();
                    if (finalScores[ability] && finalScores[ability] >= 13) {
                        isMet = true;
                    }
                } else if (requirement.includes('Level')) {
                    const requiredLevel = parseInt(requirement.replace('Level ', ''));
                    if (character.level >= requiredLevel) {
                        isMet = true;
                    }
                } else if (requirement.includes('ability')) {
                    if (character.class) {
                        const classData = classes[character.class];
                        for (let level = 1; level <= character.level; level++) {
                            if (classData.abilities[level]) {
                                if (classData.abilities[level].some(ability => ability.includes(requirement.replace(' ability', '')))) {
                                    isMet = true;
                                    break;
                                }
                            }
                        }
                    }
                } else if (availableSkills.includes(requirement) || availableTools.includes(requirement) || availableWeapons.includes(requirement)) {
                    isMet = true;
                } else if (feat.requirements.length === 0) {
                    isMet = true;
                }

                if (!isMet && requirement !== '') {
                    unmetRequirements.push(requirement);
                }
            }

            return {
                canTake: unmetRequirements.length === 0,
                unmetRequirements
            };
        };

        // Get required number of feats based on class and level
        const getRequiredFeatCount = () => {
            if (!character.class) return 0;
            const classData = classes[character.class];
            if (!classData.featChoices) return 0;

            let totalFeats = 0;
            Object.entries(classData.featChoices).forEach(([level, choice]) => {
                if (parseInt(level) <= character.level) {
                    totalFeats += choice.count;
                }
            });

            return totalFeats;
        };

        // Get available feat type for the class
        const getClassFeatType = () => {
            if (!character.class) return null;
            const classData = classes[character.class];
            if (!classData.featChoices) return null;

            const firstChoice = Object.values(classData.featChoices)[0];
            return firstChoice ? firstChoice.type : null;
        };

        // Update derived stats
        useEffect(() => {
            const hpBreakdown = getHPBreakdown();
            const finalScores = getFinalAbilityScores();
            const dexMod = getModifier(finalScores.dexterity);
            const wisMod = getModifier(finalScores.wisdom);
            const intMod = getModifier(finalScores.intelligence);
            const chaMod = getModifier(finalScores.charisma);

            let speed = 6;
            if (character.origins.includes('Grasslands')) {
                speed = 7;
            }

            const mpData = calculateMP();
            const bonusFeats = getBonusFeats();

            setCharacter(prev => ({
                ...prev,
                hp: hpBreakdown.total,
                maxHp: hpBreakdown.total,
                initiative: Math.max(dexMod, wisMod),
                moxie: Math.max(intMod, chaMod),
                armorClass: 10 + dexMod,
                speed: speed,
                determinationPoints: getDeterminationBreakdown().total,
                totalMP: mpData.total,
                spentMP: mpData.spent,
                bonusFeats: bonusFeats
            }));
        }, [character.race, character.subrace, character.class, character.level, character.abilityScores, character.abilityChoice, character.origins, character.abilityScoreImprovements, character.generalFeats]);

        // Point buy system
        const pointBuyCost = {
            8: 0, 9: 1, 10: 2, 11: 3, 12: 4, 13: 5, 14: 7, 15: 9
        };

        const getPointsSpent = () => {
            return Object.values(character.abilityScores).reduce((sum, score) => {
                return sum + (pointBuyCost[score] || 0);
            }, 0);
        };

        const updateAbilityScore = (ability, value) => {
            const newValue = Math.max(8, Math.min(15, value));
            setCharacter(prev => ({
                ...prev,
                abilityScores: {
                    ...prev.abilityScores,
                    [ability]: newValue
                }
            }));
        };

        // Check if we need ability choice
        const needsAbilityChoice = () => {
            const raceData = races[character.race]?.subraces[character.subrace];
            return raceData?.abilityIncrease?.type === 'choice' && !character.abilityChoice;
        };

        // Check if all required choices are made
        const allChoicesMade = () => {
            const raceData = races[character.race]?.subraces[character.subrace];
            if (raceData?.proficiencies) {
                if (raceData.proficiencies.skills?.type === 'choice') {
                    const required = raceData.proficiencies.skills.count;
                    const chosen = character.raceChoices.skills?.length || 0;
                    if (chosen < required) return false;
                }

                if (raceData.proficiencies.skills?.type === 'mixed' && raceData.proficiencies.skills.additionalChoice) {
                    const required = raceData.proficiencies.skills.additionalChoice.count;
                    const chosen = character.raceChoices.additionalSkills?.length || 0;
                    if (chosen < required) return false;
                }
                
                if (raceData.proficiencies.weapons?.type === 'choice') {
                    const required = raceData.proficiencies.weapons.count;
                    const chosen = character.raceChoices.weapons?.length || 0;
                    if (chosen < required) return false;
                }
            }

            for (const originName of character.origins) {
                const backgroundOrigin = origins.background.find(o => o.name === originName);
                if (backgroundOrigin?.proficiency?.type === 'choice' && !character.originChoices[originName]) {
                    return false;
                }
                
                const racialOrigin = origins.racial[character.race]?.find(o => o.name === originName);
                if (racialOrigin?.proficiency?.type === 'choice' && !character.originChoices[originName]) {
                    return false;
                }
            }

            const requiredFeats = getRequiredFeatCount();
            const selectedFeats = character.classFeats.length;
            if (selectedFeats < requiredFeats) return false;

            if (character.level >= 4 && (!character.abilityScoreImprovements || Object.keys(character.abilityScoreImprovements).length === 0)) {
                return false;
            }

            return true;
        };

        return (
            <div className="min-h-screen bg-gradient-to-br from-gray-900 via-blue-900 to-purple-900 p-4">
                <div className="max-w-6xl mx-auto">
                    <div className="bg-gray-800/90 backdrop-blur-sm rounded-lg shadow-2xl border border-blue-500/30">
                        {/* Header */}
                        <div className="bg-gradient-to-r from-blue-600 to-purple-600 p-6 rounded-t-lg">
                            <h1 className="text-3xl font-bold text-white flex items-center gap-3">
                                <div className="w-10 h-10 bg-white/20 rounded-full flex items-center justify-center">
                                    <span className="icon-target"></span>
                                </div>
                                Stargate RPG Character Editor
                            </h1>
                            <p className="text-blue-100 mt-2">Create your Phoenix Site operative</p>
                        </div>

                        <div className="p-6 space-y-6">
                            {/* Character Name */}
                            <div className="bg-gray-700/50 rounded-lg p-4">
                                <label className="block text-sm font-medium text-gray-300 mb-2">
                                    Character Name
                                </label>
                                <input
                                    type="text"
                                    value={character.name}
                                    onChange={(e) => setCharacter(prev => ({ ...prev, name: e.target.value }))}
                                    className="w-full px-4 py-2 bg-gray-800 border border-gray-600 rounded-lg text-white focus:border-blue-500 focus:outline-none"
                                    placeholder="Enter character name..."
                                />
                            </div>

                            {/* Race Selection */}
                            <div className="bg-gray-700/50 rounded-lg p-4">
                                <label className="block text-sm font-medium text-gray-300 mb-2">
                                    Select Race
                                </label>
                                <div className="grid grid-cols-2 gap-3">
                                    {Object.keys(races).map(race => (
                                        <button
                                            key={race}
                                            onClick={() => setCharacter(prev => ({ 
                                                ...prev, 
                                                race, 
                                                subrace: '',
                                                abilityChoice: '',
                                                raceChoices: {}
                                            }))}
                                            className={`p-3 rounded-lg border-2 transition-all ${
                                                character.race === race
                                                    ? 'border-blue-500 bg-blue-500/20 text-white'
                                                    : 'border-gray-600 bg-gray-800 text-gray-300 hover:border-gray-500'
                                            }`}
                                        >
                                            <div className="font-semibold">{race}</div>
                                            <div className="text-xs mt-1 opacity-75">
                                                {Object.keys(races[race].subraces).length} variant(s)
                                            </div>
                                        </button>
                                    ))}
                                </div>
                            </div>

                            {/* Subrace Selection */}
                            {character.race && (
                                <div className="bg-gray-700/50 rounded-lg p-4">
                                    <label className="block text-sm font-medium text-gray-300 mb-2">
                                        Select {character.race} Variant
                                    </label>
                                    <div className="space-y-3">
                                        {Object.entries(races[character.race].subraces).map(([subraceName, subraceData]) => {
                                            const proficiencyDesc = getProficiencyDescription(subraceData.proficiencies);
                                            
                                            return (
                                                <div
                                                    key={subraceName}
                                                    onClick={() => setCharacter(prev => ({ 
                                                        ...prev, 
                                                        subrace: subraceName,
                                                        abilityChoice: '',
                                                        raceChoices: {}
                                                    }))}
                                                    className={`p-4 rounded-lg border-2 cursor-pointer transition-all ${
                                                        character.subrace === subraceName
                                                            ? 'border-green-500 bg-green-500/20'
                                                            : 'border-gray-600 bg-gray-800 hover:border-gray-500'
                                                    }`}
                                                >
                                                    <div className="font-semibold text-white mb-2">{subraceName}</div>
                                                    <div className="text-xs text-gray-400 space-y-1">
                                                        <div>HP Bonus: +{subraceData.hitPoints}</div>
                                                        <div className="flex items-start gap-1">
                                                            <span>Ability Increase:</span>
                                                            <span className={subraceData.abilityIncrease.type === 'choice' ? 'text-yellow-300' : 'text-gray-400'}>
                                                                {subraceData.abilityIncrease.type === 'choice' ? (
                                                                    <span>
                                                                        <span className="icon-alert"></span>
                                                                        Choose ONE: +{subraceData.abilityIncrease.value} to {subraceData.abilityIncrease.options.join(' OR ')}
                                                                    </span>
                                                                ) : (
                                                                    Object.entries(subraceData.abilityIncrease)
                                                                        .filter(([key]) => key !== 'type')
                                                                        .map(([key, val]) => `${key}: +${val}`)
                                                                        .join(', ')
                                                                )}
                                                            </span>
                                                        </div>
                                                        
                                                        <div className="mt-2">
                                                            <span className="font-semibold text-gray-300">Abilities:</span>
                                                            <ul className="ml-2 mt-1">
                                                                {subraceData.abilities.map((ability, idx) => (
                                                                    <li key={idx} className="text-xs">‚Ä¢ {ability}</li>
                                                                ))}
                                                            </ul>
                                                        </div>
                                                    </div>
                                                </div>
                                            );
                                        })}
                                    </div>
                                </div>
                            )}

                            {/* Ability Score Choice */}
                            {character.race && character.subrace && 
                             races[character.race]?.subraces[character.subrace]?.abilityIncrease?.type === 'choice' && (
                                <div className={`rounded-lg p-4 ${!character.abilityChoice ? 'bg-yellow-500/20 border-2 border-yellow-500' : 'bg-gray-700/50'}`}>
                                    <label className="block text-sm font-medium mb-2 flex items-center gap-2">
                                        {!character.abilityChoice && <span className="icon-alert"></span>}
                                        <span className={!character.abilityChoice ? 'text-yellow-300' : 'text-gray-300'}>
                                            Choose ONE Ability Score Increase (+{races[character.race].subraces[character.subrace].abilityIncrease.value})
                                        </span>
                                    </label>
                                    <div className="grid grid-cols-2 md:grid-cols-3 gap-2">
                                        {races[character.race].subraces[character.subrace].abilityIncrease.options.map(ability => (
                                            <button
                                                key={ability}
                                                onClick={() => setCharacter(prev => ({ ...prev, abilityChoice: ability }))}
                                                className={`p-3 rounded capitalize transition-all font-semibold ${
                                                    character.abilityChoice === ability
                                                        ? 'bg-purple-500/20 border-2 border-purple-500 text-white'
                                                        : 'bg-gray-800 border-2 border-gray-600 text-gray-300 hover:border-gray-500'
                                                }`}
                                            >
                                                {ability}
                                                {character.abilityChoice === ability && (
                                                    <div className="text-xs mt-1 text-purple-300">‚úì Selected</div>
                                                )}
                                            </button>
                                        ))}
                                    </div>
                                </div>
                            )}

                            {/* Origins Selection */}
                            <div className="bg-gray-700/50 rounded-lg p-4">
                                <label className="block text-sm font-medium text-gray-300 mb-2">
                                    Select Origins (Choose 2 from different categories)
                                </label>
                                
                                <div className="space-y-4">
                                    {/* Biome Origins */}
                                    <div>
                                        <h3 className="text-sm font-semibold text-gray-400 mb-2">Biome Origins</h3>
                                        <div className="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-2 max-h-48 overflow-y-auto p-1">
                                            {origins.biome.slice(0, 6).map(origin => (
                                                <button
                                                    key={origin.name}
                                                    onClick={() => {
                                                        if (character.origins.length < 2 && !character.origins.some(o => origins.biome.find(b => b.name === o))) {
                                                            setCharacter(prev => ({
                                                                ...prev,
                                                                origins: [...prev.origins, origin.name]
                                                            }));
                                                        }
                                                    }}
                                                    disabled={character.origins.includes(origin.name) || (character.origins.length >= 2 || character.origins.some(o => origins.biome.find(b => b.name === o)))}
                                                    className={`p-3 text-left rounded border transition-all ${
                                                        character.origins.includes(origin.name)
                                                            ? 'border-blue-500 bg-blue-500/20'
                                                            : 'border-gray-600 bg-gray-800 hover:border-gray-500 disabled:opacity-50'
                                                    }`}
                                                >
                                                    <div className="font-semibold text-sm text-white">{origin.name}</div>
                                                    <div className="text-xs text-green-400 mt-1">{origin.attribute}</div>
                                                    <div className="text-xs text-gray-400">{origin.ability}</div>
                                                </button>
                                            ))}
                                        </div>
                                    </div>

                                    {/* Background Origins */}
                                    <div>
                                        <h3 className="text-sm font-semibold text-gray-400 mb-2">Background Origins</h3>
                                        <div className="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-2 max-h-48 overflow-y-auto p-1">
                                            {origins.background.slice(0, 6).map(origin => (
                                                <button
                                                    key={origin.name}
                                                    onClick={() => {
                                                        if (origin.name === 'Former Host' && character.race === 'Jaffa') {
                                                            return;
                                                        }
                                                        if (character.origins.length < 2 && !character.origins.some(o => origins.background.find(b => b.name === o))) {
                                                            setCharacter(prev => ({
                                                                ...prev,
                                                                origins: [...prev.origins, origin.name]
                                                            }));
                                                        }
                                                    }}
                                                    disabled={
                                                        character.origins.includes(origin.name) || 
                                                        (character.origins.length >= 2 || character.origins.some(o => origins.background.find(b => b.name === o))) ||
                                                        (origin.name === 'Former Host' && character.race === 'Jaffa')
                                                    }
                                                    className={`p-3 text-left rounded border transition-all ${
                                                        character.origins.includes(origin.name)
                                                            ? 'border-blue-500 bg-blue-500/20'
                                                            : (origin.name === 'Former Host' && character.race === 'Jaffa')
                                                            ? 'border-red-600 bg-red-900/20 opacity-50 cursor-not-allowed'
                                                            : 'border-gray-600 bg-gray-800 hover:border-gray-500 disabled:opacity-50'
                                                    }`}
                                                >
                                                    <div className="font-semibold text-sm text-white">{origin.name}</div>
                                                    <div className="text-xs text-green-400 mt-1">
                                                        Prof: {origin.proficiency?.type === 'choice' ? 'Choose' : origin.proficiency}
                                                    </div>
                                                    <div className="text-xs text-gray-400">{origin.ability}</div>
                                                </button>
                                            ))}
                                        </div>
                                    </div>

                                    {/* Racial Origins */}
                                    {character.race && origins.racial[character.race] && (
                                        <div>
                                            <h3 className="text-sm font-semibold text-gray-400 mb-2">Racial Origins ({character.race})</h3>
                                            <div className="grid grid-cols-1 md:grid-cols-2 gap-2">
                                                {origins.racial[character.race].map(origin => (
                                                    <button
                                                        key={origin.name}
                                                        onClick={() => {
                                                            if (character.origins.length < 2) {
                                                                setCharacter(prev => ({
                                                                    ...prev,
                                                                    origins: [...prev.origins, origin.name]
                                                                }));
                                                            }
                                                        }}
                                                        disabled={character.origins.includes(origin.name) || character.origins.length >= 2}
                                                        className={`p-3 text-left rounded border transition-all ${
                                                            character.origins.includes(origin.name)
                                                                ? 'border-blue-500 bg-blue-500/20'
                                                                : 'border-gray-600 bg-gray-800 hover:border-gray-500 disabled:opacity-50'
                                                        }`}
                                                    >
                                                        <div className="font-semibold text-sm text-white">{origin.name}</div>
                                                        <div className="text-xs text-green-400 mt-1">{origin.attribute}</div>
                                                        <div className="text-xs text-gray-400">{origin.ability}</div>
                                                    </button>
                                                ))}
                                            </div>
                                        </div>
                                    )}
                                </div>

                                {character.origins.length > 0 && (
                                    <div className="mt-3 flex gap-2 flex-wrap">
                                        <span className="text-xs text-gray-400">Selected:</span>
                                        {character.origins.map(origin => (
                                            <span
                                                key={origin}
                                                className="text-xs px-2 py-1 bg-blue-500/20 text-blue-300 rounded cursor-pointer hover:bg-red-500/20 hover:text-red-300"
                                                onClick={() => setCharacter(prev => ({
                                                    ...prev,
                                                    origins: prev.origins.filter(o => o !== origin)
                                                }))}
                                            >
                                                {origin} √ó
                                            </span>
                                        ))}
                                    </div>
                                )}
                            </div>

                            {/* Class Selection */}
                            <div className="bg-gray-700/50 rounded-lg p-4">
                                <label className="block text-sm font-medium text-gray-300 mb-2">
                                    Select Class
                                </label>
                                <div className="grid grid-cols-2 md:grid-cols-3 gap-3">
                                    {Object.keys(classes).map(className => (
                                        <button
                                            key={className}
                                            onClick={() => setCharacter(prev => ({ 
                                                ...prev, 
                                                class: className, 
                                                classFeats: [], 
                                                abilityScoreImprovements: {} 
                                            }))}
                                            className={`p-3 rounded-lg border-2 transition-all ${
                                                character.class === className
                                                    ? 'border-purple-500 bg-purple-500/20 text-white'
                                                    : 'border-gray-600 bg-gray-800 text-gray-300 hover:border-gray-500'
                                            }`}
                                        >
                                            <div className="font-semibold">{className}</div>
                                            <div className="text-xs mt-1 opacity-75">
                                                HD: d{classes[className].hitDie}, DP: +{classes[className].determinationBonus}
                                            </div>
                                        </button>
                                    ))}
                                </div>
                            </div>

                            {/* Level Selection - EXTENDED TO 20 */}
                            <div className="bg-gray-700/50 rounded-lg p-4">
                                <label className="block text-sm font-medium text-gray-300 mb-2">
                                    Character Level
                                </label>
                                <div className="grid grid-cols-4 md:grid-cols-5 lg:grid-cols-10 gap-2">
                                    {Array.from({length: 20}, (_, i) => i + 1).map(level => (
                                        <button
                                            key={level}
                                            onClick={() => setCharacter(prev => ({ ...prev, level }))}
                                            className={`px-3 py-2 rounded-lg border-2 transition-all text-sm ${
                                                character.level === level
                                                    ? 'border-green-500 bg-green-500/20 text-white'
                                                    : 'border-gray-600 bg-gray-800 text-gray-300 hover:border-gray-500'
                                            }`}
                                        >
                                            {level}
                                        </button>
                                    ))}
                                </div>
                                
                                {/* Show MP calculation for levels 6+ */}
                                {character.level > 5 && (
                                    <div className="mt-4 p-3 bg-blue-500/10 rounded border border-blue-500/30">
                                        <div className="flex items-center gap-2 text-blue-300 mb-2">
                                            <span className="icon-coins"></span>
                                            <span className="text-sm font-semibold">Mission Points (Level 6+)</span>
                                        </div>
                                        <div className="text-xs text-gray-300 space-y-1">
                                            {(() => {
                                                const mpData = calculateMP();
                                                return (
                                                    <>
                                                        <div>Total MP: {mpData.total} (Level {character.level} = {character.level - 5} √ó 10)</div>
                                                        <div>MP Spent on Feats: {mpData.spent}</div>
                                                        <div className="text-green-400 font-semibold">Available MP: {mpData.available}</div>
                                                    </>
                                                );
                                            })()}
                                        </div>
                                    </div>
                                )}

                                {/* Show bonus feats for levels 5, 11, 17 */}
                                {character.level >= 5 && (
                                    <div className="mt-4 p-3 bg-yellow-500/10 rounded border border-yellow-500/30">
                                        <div className="flex items-center gap-2 text-yellow-300 mb-2">
                                            <span className="icon-star"></span>
                                            <span className="text-sm font-semibold">Bonus Feats (Automatic)</span>
                                        </div>
                                        <div className="text-xs text-gray-300">
                                            {getBonusFeats().map((feat, idx) => (
                                                <div key={idx}>
                                                    Level {feat === 'Attack Specialist' ? 5 : feat === 'Attack Veteran' ? 11 : 17}: {feat}
                                                </div>
                                            ))}
                                        </div>
                                    </div>
                                )}
                            </div>

                            {/* COMPLETELY NEW: Category-Based Feat Selection for Level 6+ */}
                            {character.level > 5 && (
                                <div className="bg-gray-700/50 rounded-lg p-4">
                                    <h3 className="text-lg font-semibold text-gray-300 mb-4 flex items-center gap-2">
                                        <span className="icon-star"></span>
                                        Feat Selection (Level 6+)
                                    </h3>
                                    
                                    <div className="mb-4 p-3 bg-blue-500/10 rounded border border-blue-500/30">
                                        <div className="flex items-center justify-between text-blue-300 mb-2">
                                            <span className="text-sm font-semibold flex items-center gap-2">
                                                <span className="icon-coins"></span>
                                                Mission Points Available
                                            </span>
                                            <span className="text-lg font-bold">{calculateMP().available} / {calculateMP().total} MP</span>
                                        </div>
                                        <p className="text-xs text-gray-300">Select a category below to browse and purchase feats with your Mission Points.</p>
                                    </div>

                                    {/* Category Selection Tabs */}
                                    <div className="mb-6">
                                        <div className="flex flex-wrap gap-2 mb-4">
                                            {Object.entries(featCategories).map(([categoryKey, category]) => (
                                                <button
                                                    key={categoryKey}
                                                    onClick={() => setSelectedFeatCategory(categoryKey)}
                                                    className={`px-4 py-2 rounded-lg text-sm font-medium transition-all ${
                                                        selectedFeatCategory === categoryKey
                                                            ? 'bg-purple-500 text-white border-2 border-purple-300'
                                                            : 'bg-gray-800 border border-gray-600 text-gray-300 hover:border-gray-500'
                                                    }`}
                                                >
                                                    {category.name}
                                                </button>
                                            ))}
                                        </div>

                                        {/* Selected Category Description */}
                                        <div className="p-4 bg-gray-800/50 rounded-lg mb-4">
                                            <h4 className="text-md font-semibold text-white mb-2">
                                                {featCategories[selectedFeatCategory].name}
                                            </h4>
                                            <p className="text-sm text-gray-300">
                                                {featCategories[selectedFeatCategory].description}
                                            </p>
                                        </div>

                                        {/* Feat Grid for Selected Category */}
                                        <div className="grid grid-cols-1 md:grid-cols-2 gap-4">
                                            {featCategories[selectedFeatCategory].feats.map(feat => {
                                                const isSelected = character.generalFeats.includes(feat.name);
                                                const requirementCheck = checkFeatRequirements(feat);
                                                const canAfford = calculateMP().available >= feat.mpCost;
                                                const canSelect = !isSelected && requirementCheck.canTake && canAfford;

                                                return (
                                                    <button
                                                        key={feat.name}
                                                        onClick={() => {
                                                            if (isSelected) {
                                                                // Remove feat
                                                                setCharacter(prev => ({
                                                                    ...prev,
                                                                    generalFeats: prev.generalFeats.filter(f => f !== feat.name)
                                                                }));
                                                            } else if (canSelect) {
                                                                // Add feat
                                                                setCharacter(prev => ({
                                                                    ...prev,
                                                                    generalFeats: [...prev.generalFeats, feat.name]
                                                                }));
                                                            }
                                                        }}
                                                        disabled={!isSelected && !canSelect}
                                                        className={`text-left p-4 rounded-lg border-2 transition-all ${
                                                            isSelected
                                                                ? 'border-green-500 bg-green-500/20 text-white'
                                                                : canSelect
                                                                ? 'border-gray-600 bg-gray-800 hover:border-purple-500 hover:bg-purple-500/10 text-white'
                                                                : 'border-gray-700 bg-gray-900/30 opacity-60 cursor-not-allowed text-gray-400'
                                                        }`}
                                                    >
                                                        <div className="flex justify-between items-start mb-2">
                                                            <div className="flex items-center gap-2">
                                                                <span className="font-semibold text-sm">{feat.name}</span>
                                                                {isSelected && <span className="icon-check text-green-400"></span>}
                                                            </div>
                                                            <div className="flex items-center gap-2">
                                                                <span className="text-xs px-2 py-1 bg-blue-500/30 text-blue-300 rounded">
                                                                    {feat.mpCost} MP
                                                                </span>
                                                                {!canAfford && !isSelected && <span className="icon-coins text-red-400"></span>}
                                                            </div>
                                                        </div>
                                                        
                                                        <div className="text-xs text-gray-300 mb-3">{feat.description}</div>
                                                        
                                                        {feat.requirements.length > 0 && (
                                                            <div className="text-xs mb-2">
                                                                <span className="text-yellow-300">Requirements:</span>
                                                                <span className={`ml-1 ${requirementCheck.canTake ? 'text-green-400' : 'text-red-400'}`}>
                                                                    {feat.requirements.join(', ')}
                                                                </span>
                                                                {!requirementCheck.canTake && (
                                                                    <div className="text-red-300 mt-1">
                                                                        Missing: {requirementCheck.unmetRequirements.join(', ')}
                                                                    </div>
                                                                )}
                                                            </div>
                                                        )}
                                                        
                                                        {!canAfford && !isSelected && (
                                                            <div className="text-xs text-red-400">
                                                                Need {feat.mpCost} MP (Have {calculateMP().available})
                                                            </div>
                                                        )}
                                                    </button>
                                                );
                                            })}
                                        </div>
                                    </div>
                                </div>
                            )}

                            {/* Ability Scores (Point Buy) */}
                            <div className="bg-gray-700/50 rounded-lg p-4">
                                <div className="flex justify-between items-center mb-4">
                                    <label className="text-sm font-medium text-gray-300">
                                        Ability Scores (Point Buy) - Base Values
                                    </label>
                                    <span className={`text-sm px-3 py-1 rounded-full ${
                                        getPointsSpent() > 27 ? 'bg-red-500/20 text-red-300' : 'bg-green-500/20 text-green-300'
                                    }`}>
                                        Points: {getPointsSpent()}/27
                                    </span>
                                </div>
                                
                                <div className="grid grid-cols-2 md:grid-cols-3 gap-4">
                                    {Object.entries(character.abilityScores).map(([ability, score]) => {
                                        const { racialBonus, originBonus, asiBonus } = getAbilityBonuses(ability);
                                        const totalBonus = racialBonus + originBonus + asiBonus;
                                        const finalScore = score + totalBonus;
                                        
                                        return (
                                            <div key={ability} className="bg-gray-800 rounded-lg p-3">
                                                <div className="flex justify-between items-center mb-2">
                                                    <span className="text-xs text-gray-400 capitalize">{ability}</span>
                                                    <span className="text-xs text-blue-300">
                                                        Final: {finalScore} ({getModifier(finalScore) >= 0 ? '+' : ''}{getModifier(finalScore)})
                                                    </span>
                                                </div>
                                                <div className="flex items-center gap-2">
                                                    <button
                                                        onClick={() => updateAbilityScore(ability, score - 1)}
                                                        className="w-8 h-8 bg-gray-700 hover:bg-gray-600 rounded text-white"
                                                        disabled={score <= 8}
                                                    >
                                                        -
                                                    </button>
                                                    <div className="flex-1 text-center">
                                                        <div className="text-lg font-bold text-white">{score}</div>
                                                        {totalBonus !== 0 && (
                                                            <div className="text-xs text-green-400">+{totalBonus}</div>
                                                        )}
                                                    </div>
                                                    <button
                                                        onClick={() => updateAbilityScore(ability, score + 1)}
                                                        className="w-8 h-8 bg-gray-700 hover:bg-gray-600 rounded text-white"
                                                        disabled={score >= 15 || getPointsSpent() >= 27}
                                                    >
                                                        +
                                                    </button>
                                                </div>
                                            </div>
                                        );
                                    })}
                                </div>
                            </div>

                            {/* Combat Statistics */}
                            <div className="bg-gray-700/50 rounded-lg p-4">
                                <h3 className="text-lg font-semibold text-gray-300 mb-4">Combat Statistics</h3>
                                
                                <div className="grid grid-cols-2 md:grid-cols-3 gap-4">
                                    <div className="bg-gray-800 rounded-lg p-3">
                                        <div className="flex items-center gap-2 text-red-400 mb-1">
                                            <span className="icon-heart"></span>
                                            <span className="text-xs">Hit Points</span>
                                        </div>
                                        <div className="text-2xl font-bold text-white">{character.hp || 0}</div>
                                    </div>
                                    
                                    <div className="bg-gray-800 rounded-lg p-3">
                                        <div className="flex items-center gap-2 text-blue-400 mb-1">
                                            <span className="icon-shield"></span>
                                            <span className="text-xs">Armor Class</span>
                                        </div>
                                        <div className="text-2xl font-bold text-white">{character.armorClass}</div>
                                    </div>
                                    
                                    <div className="bg-gray-800 rounded-lg p-3">
                                        <div className="flex items-center gap-2 text-yellow-400 mb-1">
                                            <span className="icon-zap"></span>
                                            <span className="text-xs">Initiative</span>
                                        </div>
                                        <div className="text-2xl font-bold text-white">
                                            {character.initiative >= 0 ? '+' : ''}{character.initiative}
                                        </div>
                                    </div>
                                    
                                    <div className="bg-gray-800 rounded-lg p-3">
                                        <div className="flex items-center gap-2 text-purple-400 mb-1">
                                            <span className="icon-brain"></span>
                                            <span className="text-xs">Determination</span>
                                        </div>
                                        <div className="text-2xl font-bold text-white">{character.determinationPoints}</div>
                                    </div>
                                    
                                    <div className="bg-gray-800 rounded-lg p-3">
                                        <div className="flex items-center gap-2 text-green-400 mb-1">
                                            <span className="icon-activity"></span>
                                            <span className="text-xs">Speed</span>
                                        </div>
                                        <div className="text-2xl font-bold text-white">{character.speed}m</div>
                                    </div>
                                    
                                    <div className="bg-gray-800 rounded-lg p-3">
                                        <div className="flex items-center gap-2 text-cyan-400 mb-1">
                                            <span className="icon-user"></span>
                                            <span className="text-xs">Moxie</span>
                                        </div>
                                        <div className="text-2xl font-bold text-white">
                                            {character.moxie >= 0 ? '+' : ''}{character.moxie}
                                        </div>
                                    </div>
                                </div>
                            </div>

                            {/* Selected Feats Summary */}
                            {(character.generalFeats.length > 0 || character.bonusFeats.length > 0) && (
                                <div className="bg-gray-700/50 rounded-lg p-4">
                                    <h3 className="text-lg font-semibold text-gray-300 mb-4">Selected Feats</h3>
                                    
                                    {character.bonusFeats.length > 0 && (
                                        <div className="mb-4">
                                            <h4 className="text-sm font-semibold text-yellow-300 mb-2">Bonus Feats (Automatic)</h4>
                                            <div className="grid grid-cols-1 md:grid-cols-2 gap-2">
                                                {character.bonusFeats.map(featName => (
                                                    <div key={featName} className="bg-yellow-500/10 border border-yellow-500/30 p-2 rounded text-sm text-white">
                                                        <span className="icon-star text-yellow-400 mr-2"></span>
                                                        {featName}
                                                        <span className="text-xs text-yellow-300 ml-2">(Level Bonus)</span>
                                                    </div>
                                                ))}
                                            </div>
                                        </div>
                                    )}
                                    
                                    {character.generalFeats.length > 0 && (
                                        <div>
                                            <h4 className="text-sm font-semibold text-purple-300 mb-2">Purchased Feats</h4>
                                            <div className="grid grid-cols-1 md:grid-cols-2 gap-2">
                                                {character.generalFeats.map(featName => {
                                                    let mpCost = 0;
                                                    for (const category of Object.values(featCategories)) {
                                                        const feat = category.feats.find(f => f.name === featName);
                                                        if (feat) {
                                                            mpCost = feat.mpCost;
                                                            break;
                                                        }
                                                    }
                                                    return (
                                                        <div key={featName} className="bg-gray-800 p-2 rounded text-sm text-white flex justify-between items-center">
                                                            <span>
                                                                <span className="icon-check text-green-400 mr-2"></span>
                                                                {featName}
                                                            </span>
                                                            <span className="text-xs px-2 py-1 bg-blue-500/20 text-blue-300 rounded">
                                                                {mpCost} MP
                                                            </span>
                                                        </div>
                                                    );
                                                })}
                                            </div>
                                        </div>
                                    )}
                                </div>
                            )}
                        </div>
                    </div>
                </div>
            </div>
        );
    };

    ReactDOM.render(<StargateCharacterEditor />, document.getElementById('root'));
</script>
</body>
</html>
