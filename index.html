<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Stargate RPG Character Builder (Levels 1-20)</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        .transition-all { transition: all 0.3s ease; }
        .rotate-180 { transform: rotate(180deg); }
        ::-webkit-scrollbar { width: 8px; height: 8px; }
        ::-webkit-scrollbar-track { background: rgba(0, 0, 0, 0.2); border-radius: 4px; }
        ::-webkit-scrollbar-thumb { background: rgba(147, 51, 234, 0.5); border-radius: 4px; }
        ::-webkit-scrollbar-thumb:hover { background: rgba(147, 51, 234, 0.7); }
        .icon { display: inline-block; width: 1em; height: 1em; vertical-align: middle; fill: currentColor; }
        .icon-sm { width: 0.75rem; height: 0.75rem; }
        .icon-md { width: 1rem; height: 1rem; }
        .icon-lg { width: 1.25rem; height: 1.25rem; }
    </style>
</head>
<body class="min-h-screen bg-gradient-to-br from-gray-900 via-blue-900 to-purple-900 p-4">
    <div id="app"></div>
    <script>
        // Icons library
        const icons = {
            chevronDown: '<svg class="icon" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="m6 9 6 6 6-6"/></svg>',
            user: '<svg class="icon" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M19 21v-2a4 4 0 0 0-4-4H9a4 4 0 0 0-4 4v2"/><circle cx="12" cy="7" r="4"/></svg>',
            shield: '<svg class="icon" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M12 22s8-4 8-10V5l-8-3-8 3v7c0 6 8 10 8 10"/></svg>',
            heart: '<svg class="icon" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M19 14c1.49-1.46 3-3.21 3-5.5A5.5 5.5 0 0 0 16.5 3c-1.76 0-3 .5-4.5 2-1.5-1.5-2.74-2-4.5-2A5.5 5.5 0 0 0 2 8.5c0 2.3 1.5 4.05 3 5.5l7 7Z"/></svg>',
            zap: '<svg class="icon" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M13 2 3 14h9l-1 8 10-12h-9l1-8z"/></svg>',
            brain: '<svg class="icon" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M9.5 2A2.5 2.5 0 0 1 12 4.5v15a2.5 2.5 0 0 1-4.96.44 2.5 2.5 0 0 1-2.96-3.08 3 3 0 0 1-.34-5.58 2.5 2.5 0 0 1 1.32-4.24 2.5 2.5 0 0 1 1.44-5A2.5 2.5 0 0 1 9.5 2Z"/><path d="M14.5 2A2.5 2.5 0 0 0 12 4.5v15a2.5 2.5 0 0 0 4.96.44 2.5 2.5 0 0 0 2.96-3.08 3 3 0 0 0 .34-5.58 2.5 2.5 0 0 0-1.32-4.24 2.5 2.5 0 0 0-1.44-5A2.5 2.5 0 0 0 14.5 2Z"/></svg>',
            target: '<svg class="icon" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><circle cx="12" cy="12" r="10"/><circle cx="12" cy="12" r="6"/><circle cx="12" cy="12" r="2"/></svg>',
            activity: '<svg class="icon" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M22 12h-4l-3 9L9 3l-3 9H2"/></svg>',
            download: '<svg class="icon" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4"/><polyline points="7 10 12 15 17 10"/><line x1="12" x2="12" y1="15" y2="3"/></svg>',
            alertCircle: '<svg class="icon icon-sm" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><circle cx="12" cy="12" r="10"/><line x1="12" x2="12" y1="8" y2="12"/><line x1="12" x2="12.01" y1="16" y2="16"/></svg>',
            sparkles: '<svg class="icon" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="m12 3-1.912 5.813a2 2 0 0 1-1.275 1.275L3 12l5.813 1.912a2 2 0 0 1 1.275 1.275L12 21l1.912-5.813a2 2 0 0 1 1.275-1.275L21 12l-5.813-1.912a2 2 0 0 1-1.275-1.275L12 3Z"/><path d="M5 3v4"/><path d="M19 17v4"/><path d="M3 5h4"/><path d="M17 19h4"/></svg>',
            award: '<svg class="icon" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><circle cx="12" cy="8" r="6"/><path d="M15.477 12.89 17 22l-5-3-5 3 1.523-9.11"/></svg>',
            bookOpen: '<svg class="icon" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M2 3h6a4 4 0 0 1 4 4v14a3 3 0 0 0-3-3H2z"/><path d="M22 3h-6a4 4 0 0 0-4 4v14a3 3 0 0 1 3-3h7z"/></svg>',
            star: '<svg class="icon" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><polygon points="12 2 15.09 8.26 22 9.27 17 14.14 18.18 21.02 12 17.77 5.82 21.02 7 14.14 2 9.27 8.91 8.26 12 2"/></svg>',
        };

        // COMPREHENSIVE GAME DATA
        const gameData = {
            fieldHackFeats: [
                {name:'Camouflage',cost:5,requirements:'Stealth',baseRequirement:'Survivalist',description:'Using elements of the natural environment, you grant your team advantage on Stealth checks after a short or long rest in an environment.'},
                {name:'Camp Security',cost:5,requirements:'Perception',baseRequirement:'Survivalist',description:'Your adept site preparation provides advantage on any Perception checks to notice approaching creatures while taking a short or long rest.'},
                {name:'Foraging',cost:5,requirements:'Stealth',baseRequirement:'Survivalist',description:'When in a natural environment you can feed a number of people up to your Proficiency bonus with a single hard (DC 20) Survival check and 1d4 hours of work.'},
                {name:'Hide Tracks',cost:5,requirements:'Stealth',baseRequirement:'Survivalist',description:'You travel in back of your team, hiding your tracks. Raise the DC to track your party by your Proficiency bonus or to DC 20 (hard difficulty), whichever result yields a higher DC.'},
                {name:'Ranger Tricks',cost:5,requirements:'',baseRequirement:'Survivalist',description:'During a Traversal encounter, if you succeed at a Terrain card\'s Navigation check, you navigate an additional 1d3 cards from the Journey deck instead of 1.'},
                {name:'Ration Optimization',cost:5,requirements:'',baseRequirement:'Survivalist',description:'By managing your team\'s rations and preparing meals with clever use of ingredients, you can keep spirits high. Your team members heal 1 DP during a short rest.'},
                {name:'Rope Tricks',cost:5,requirements:'Stealth',baseRequirement:'Survivalist',description:'Your expert knots and efficient use of rope allow your entire team to benefit from your Climbing Kit.'},
                {name:'Tracking',cost:5,requirements:'Perception',baseRequirement:'Survivalist',description:'You gain advantage on all Survival checks made to track.'},
                {name:'Xenosurvival',cost:5,requirements:'Constitution 13+',baseRequirement:'Survivalist',description:'Once you have taken a short or long rest in an environment, choose a number of additional characters up to your Proficiency bonus to benefit from your Survivalist ability while in the environment until your next rest.'}
            ],
            
            classFeatsByType: {
                inspiration: [
                    {name:'Calm and Collected',cost:5,requirements:'',baseRequirement:'Inspire',description:'During a long rest, choose either Intelligence, Wisdom, or Charisma. Inspired characters gain advantage on the chosen save until your next long rest.'},
                    {name:'Clear Focus',cost:5,requirements:'',baseRequirement:'Inspire',description:'During a long rest, choose a skill in which you are proficient. Inspired characters gain advantage on the chosen skill until your next long rest.'},
                    {name:'Coordinated Fire',cost:5,requirements:'',baseRequirement:'Inspire',description:'After you hit a target with an attack, you may take a bonus action to grant an inspired character advantage to their next attack roll made before your next turn against the same target.'},
                    {name:'Defensive Motivation',cost:5,requirements:'',baseRequirement:'Inspire',description:'Inspired characters gains +1 AC.'},
                    {name:'Enduring Inspirations',cost:5,requirements:'',baseRequirement:'Inspire',description:'At the beginning of combat (when Initiative is rolled) each inspired character gains a number of Inspire HP equal to a roll of the tension die. A character cannot have more Inspire HP than the maximum possible result of your Inspire die.'},
                    {name:'Grim Resolve',cost:5,requirements:'',baseRequirement:'Inspire',description:'When an inspired character loses their last Inspire HP, they gain resistance to bludgeoning, piercing, and slashing damage until their next turn.'},
                    {name:'Hard Day\'s Night',cost:5,requirements:'',baseRequirement:'Inspire',description:'Inspired characters reduce any exhaustion damage they suffer from environmental effects or exertion by 1 level (minimum 1 level). This does not affect attacks that deal exhaustion (such as tranquilizers).'},
                    {name:'Quippy Comebacks',cost:5,requirements:'',baseRequirement:'Inspire',description:'Once per Diplomatic Function, inspired characters may halve the amount of DP lost (rounding down) as a result of a failed Diplomatic Action check.'},
                    {name:'Skillful Explanations',cost:5,requirements:'',baseRequirement:'Inspire',description:'Once per short rest, when an inspired character fails a skill check that you are proficient in, you may allow the character to re-roll the result.'}
                ],
                modification: [
                    {name:'Armorer',cost:5,requirements:'',baseRequirement:'Jury Rig',description:'During a long rest, you may choose one character\'s armor. It gains +1 AC until your next long rest. You may choose this modification multiple times; each time you do you may apply the bonus to an additional armor.'},
                    {name:'Chem Thrower',cost:5,requirements:'',baseRequirement:'Jury Rig',description:'During a long rest you may choose one weapon with the line or cone quality. It gains +5m to its range until your next long rest. You may choose this modification multiple times; each time you do you may apply the bonus to an additional weapon.'},
                    {name:'Comms Tech',cost:5,requirements:'',baseRequirement:'Jury Rig',description:'Your team\'s tactical radio equipment has a range of 20km (instead of 5km). In addition, when you launch a communications balloon, its duration increases to 15d6 hours.'},
                    {name:'Grenadier',cost:5,requirements:'',baseRequirement:'Jury Rig',description:'Grenades from your kit deal +1d6 damage when used by you. You may choose this modification multiple times; each time you do your kit\'s grenades deal an additional +1d6 damage when used by you.'},
                    {name:'Longarm Calibrations',cost:5,requirements:'',baseRequirement:'Jury Rig',description:'During a long rest you may choose one character\'s Longarm. It gains a +1d4 to attack rolls against targets at long range until your next long rest. You may choose this modification multiple times; each time you do you may apply the bonus to an additional weapon.'},
                    {name:'Minefield Expert',cost:5,requirements:'Explosives',baseRequirement:'Jury Rig',description:'You can bury an explosive (such as C4 or a claymore mine) just below the dirt rigged to explode when a character enters the space. This process takes 2 minutes. The explosive affects all targets within a 2m radius. A character must succeed at a DC 20 Perception check to spot the mine before triggering it. Additionally, you gain advantage on all Perception checks to spot buried mines.'},
                    {name:'Montage',cost:5,requirements:'',baseRequirement:'Jury Rig',description:'During an episode R&D encounter, reduce the number of successes required by half your Proficiency bonus, to a minimum of 1.'},
                    {name:'Percussive Maintenance',cost:5,requirements:'',baseRequirement:'Jury Rig',description:'When a vehicle you are embarked within has the damaged condition, you can take an action to ignore the damaged condition for a number of rounds equal to a roll of the tension die.'},
                    {name:'Sidearm Calibrations',cost:5,requirements:'',baseRequirement:'Jury Rig',description:'During a long rest you may choose one character\'s sidearm. It provides a +1d4 to attack rolls against targets at short range until your next long rest. You may choose this modification multiple times, each time you do you may apply the bonus to an additional weapon.'}
                ],
                procedure: [
                    {name:'Biohazard Disposal',cost:5,requirements:'',baseRequirement:'First Aid',description:'You and your team are considered proficient in Constitution saves against diseases, toxins, and viruses. If a character is already proficient in Constitution saves, they gain no benefit from this procedure.'},
                    {name:'Controlled Stimulants',cost:5,requirements:'',baseRequirement:'First Aid',description:'As an action, you may use your Med Kit to heal 1d4 levels of exhaustion. A character may not benefit from this ability again until they have taken a long rest.'},
                    {name:'Crash Training',cost:5,requirements:'',baseRequirement:'First Aid',description:'You may use a Med Kit to revive a character who has been dead for a number of rounds up to your Proficiency bonus with a successful DC 25 Medicine check. You may attempt this check once per round.'},
                    {name:'Embolism',cost:5,requirements:'',baseRequirement:'First Aid',description:'You may use your Med Kit to make a melee attack that deals 1d3 Constitution damage.'},
                    {name:'Improvised Medicine',cost:5,requirements:'',baseRequirement:'First Aid',description:'When you do not have a Med Kit, you may still heal friendly targets as if you had a Med Kit but were not proficient with it.'},
                    {name:'Pharmaceuticals',cost:5,requirements:'',baseRequirement:'First Aid',description:'You may use your Med Kit to heal a character of 1d4 Intelligence, Wisdom, or Charisma damage during a short rest. A character may not benefit from this ability again until they have taken a long rest.'},
                    {name:'Sedatives',cost:5,requirements:'',baseRequirement:'First Aid',description:'You may administer a sedative to a living target as a melee attack using your Med Kit. If successful, the target must succeed at a Constitution save (DC equal to 10 + Proficiency bonus + Wisdom modifier) or suffer 1d6 levels of fatigue. A target brought to 6 levels of fatigue with this ability is unconscious instead of dead.'},
                    {name:'Urgent Care',cost:5,requirements:'',baseRequirement:'First Aid',description:'When you heal with a Med Kit, you may choose to replace all the healing dice rolled with the same number of Tension Dice.'},
                    {name:'Vital Organ Trauma',cost:5,requirements:'',baseRequirement:'First Aid',description:'When you critically hit, add your Wisdom modifier to the damage dealt.'}
                ],
                discovery: [
                    {name:'A Moment\'s Thought',cost:5,requirements:'',baseRequirement:'Eureka',description:'Whenever you take a short or long rest you may spend a Eureka point to re-roll an Intelligence or Wisdom skill check to learn information that you failed since your last rest.'},
                    {name:'Archaeologist',cost:5,requirements:'Culture',baseRequirement:'Eureka',description:'As an action you can spend a Eureka point to automatically locate any secret chambers or otherwise hidden rooms within a structure no larger than 20m square per Proficiency bonus. This does not indicate how the secret area may be accessed, only that one must exist (or doesn\'t exist) within the area. In addition, you gain advantage on any Perception checks to find hidden elements of architecture such as secret levers, trap triggers, or hidden doors.'},
                    {name:'Astronomer',cost:5,requirements:'Science',baseRequirement:'Eureka',description:'As a bonus action you may reduce the time it takes to activate an astronomical device (including a Stargate) by 1 round per Eureka point spent.'},
                    {name:'Biologist',cost:5,requirements:'Medicine',baseRequirement:'Eureka',description:'As an action you may spend any number of Eureka points to heal yourself or a character within 1m for 1d6 damage per Eureka point spent.'},
                    {name:'Chemist',cost:5,requirements:'Science',baseRequirement:'Eureka',description:'As an action you may use your Research Kit to make a ranged attack against a target within 5m. If the attack hits, you may spend any number of Eureka points to deal 1d6 acid damage per Eureka point spent. You are proficient with this attack and it uses your Intelligence modifier in place of your Dexterity. This damage increases to 1d8 per Eureka at level 5, 1d10 at level 11, and 1d12 at level 17.'},
                    {name:'Geologist',cost:5,requirements:'Science',baseRequirement:'Eureka',description:'When a friendly character within 5m makes an attack against a target in cover from a natural source (stones, trees, a hill), you may make a reaction and spend a Eureka point to negate the effects of that cover for the duration of the attack.'},
                    {name:'Hyper-Focus',cost:5,requirements:'',baseRequirement:'Eureka',description:'You may spend one Eureka point to add the tension die to an Intelligence or Wisdom check. You may declare this use of Eureka after learning the results of the roll.'},
                    {name:'Physicist',cost:5,requirements:'Science',baseRequirement:'Eureka',description:'When you make an attack with a ranged weapon, you may spend a Eureka to increase the weapon\'s range by half (+50%).'},
                    {name:'Social Sciences',cost:5,requirements:'Culture',baseRequirement:'Eureka',description:'Whenever you lose any number of wagered Determination Points, you gain one Eureka point.'}
                ],
                tactic: [
                    {name:'Ambush',cost:5,requirements:'',baseRequirement:'Tactical Flexibility',description:'You and your team members gain advantage on your first melee attack after any short or long rest.'},
                    {name:'Assault Coordination',cost:5,requirements:'',baseRequirement:'Tactical Flexibility',description:'When you hit a target with a ranged attack, the next successful ranged attack by one of your team members deals +1d6 damage.'},
                    {name:'Coordinated Response',cost:5,requirements:'',baseRequirement:'Tactical Flexibility',description:'When rolling for initiative, your team members may choose (before the rolls are made) to use your initiative result instead of their own.'},
                    {name:'Defensive Posture',cost:5,requirements:'',baseRequirement:'Tactical Flexibility',description:'Add +2 AC to other team members within 2m of you.'},
                    {name:'Distracting Attacks',cost:5,requirements:'',baseRequirement:'Tactical Flexibility',description:'When you deal damage to a single target with an attack, you may choose one friendly character not within 2m of you. The target of your attack suffers disadvantage on all attacks against the chosen character until the start of your next turn.'},
                    {name:'Hit and Run',cost:5,requirements:'',baseRequirement:'Tactical Flexibility',description:'As a bonus action on your turn you may allow a team member to take a Disengage action.'},
                    {name:'Overwatchers',cost:5,requirements:'',baseRequirement:'Tactical Flexibility',description:'During a firefight, when you and your team members take the Overwatch action you cover a 90° field instead of a 45° cone. In addition, you may make two Overwatch attacks (against different targets).'},
                    {name:'Response Shot',cost:5,requirements:'',baseRequirement:'Tactical Flexibility',description:'Once per encounter, you may use your reaction to make a ranged attack against an enemy who makes an attack against a team member other than yourself.'},
                    {name:'Rush',cost:5,requirements:'',baseRequirement:'Tactical Flexibility',description:'As a bonus action on your turn you may allow a team member to take a Dash action.'}
                ]
            },

            generalFeats: [
                {name:'Ability Score Increase',cost:7,requirements:'None',category:'General',description:'An ability score of your choice is increased by +1. No ability score can be raised above 20 in this way.'},
                {name:'Advanced Training: Diplomat',cost:9,requirements:'Charisma 13+, Persuasion',category:'Advanced Training',description:'You gain the Diplomat\'s Inspire ability.'},
                {name:'Advanced Training: Engineer',cost:9,requirements:'Intelligence 13+, Engineering',category:'Advanced Training',description:'You gain the Engineer\'s Jury Rig ability.'},
                {name:'Advanced Training: Medic',cost:9,requirements:'Wisdom 13+, Medicine',category:'Advanced Training',description:'You gain the Medic\'s First Aid ability.'},
                {name:'Advanced Training: Scientist',cost:9,requirements:'Intelligence 13+, Science',category:'Advanced Training',description:'You gain the Scientist\'s Eureka ability.'},
                {name:'Advanced Training: Scout',cost:9,requirements:'Constitution 13+, Survival',category:'Advanced Training',description:'You gain the Scout\'s Survivalist ability.'},
                {name:'Advanced Training: Soldier',cost:9,requirements:'Constitution 13+, Intimidation',category:'Advanced Training',description:'You gain the Soldier\'s Tactical Flexibility ability.'},
                {name:'Airborne School',cost:3,requirements:'Athletics',category:'General',description:'You gain resistance to falling damage. In addition, you gain advantage on any check to open a parachute at altitudes below 1km.'},
                {name:'Apt Analogy',cost:5,requirements:'Science',category:'General',description:'Once per short rest you may grant a friendly character a +TD bonus on an Intelligence or Wisdom skill check.'},
                {name:'Battlefield Medicine',cost:6,requirements:'Med Kit proficiency',category:'General',description:'When you use a Med Kit to heal a target during a rest, they also heal 1 point of Strength, Dexterity, or Constitution damage in addition to the HP damage healed.'},
                {name:'Casual Genius',cost:6,requirements:'Eureka ability',category:'General',description:'You begin each mission with a number of Eureka points equal to half your Proficiency Bonus (rounding down).'},
                {name:'Chaplain School',cost:3,requirements:'Insight',category:'General',description:'During a Convince encounter, you do not automatically fail on a roll of 1, and you do not increase the threshold.'},
                {name:'Convincing',cost:9,requirements:'Inspire ability',category:'General',description:'You add your Charisma modifier to the temporary hit points granted by Inspire.'},
                {name:'Cross-Discipline Study',cost:9,requirements:'Intelligence 13+',category:'General',description:'You add half your Proficiency bonus, rounded down, to any Intelligence, Wisdom, or Charisma skill check that doesn\'t already include your Proficiency bonus.'},
                {name:'De-Escalate',cost:5,requirements:'Persuasion',category:'General',description:'Once per long rest you may spend a DP to reduce the tension die by 1 step for the duration of a single encounter or scene.'},
                {name:'Determined',cost:9,requirements:'Wisdom 13+',category:'General',description:'When you roll a 5 or less on a d20 roll and before learning the result, you may choose to spend a Determination Point to re-roll the d20. You can only benefit from this once per long rest.'},
                {name:'Dive School',cost:3,requirements:'Athletics',category:'General',description:'You can hold your breath for twice as long as normal and you gain a swim speed of 3m. This speed increases to 6m when you are equipped with swimming and diving equipment.'},
                {name:'Escalate',cost:5,requirements:'Intimidation',category:'General',description:'Once per long rest you may spend a DP to increase the tension die by 1 step for the duration of a single encounter or scene.'},
                {name:'Exceptional Expertise',cost:9,requirements:'Proficiency with chosen skill',category:'General',description:'Choose a skill in which you are proficient. Your Proficiency bonus is doubled for any ability check you make that uses the chosen proficiency. You may select this ability multiple times, applying its effect to a different skill each time.'},
                {name:'Fighter Ace',cost:5,requirements:'Pilot',category:'General',description:'When aerial combat begins, you add an additional d6 to your position pool. You may purchase this ability up to three times and its effects stack.'},
                {name:'First Response',cost:9,requirements:'First Aid ability',category:'General',description:'You may add your Wisdom modifier to the damage you heal with a Med Kit. In addition, you may use a Med Kit to heal a scuffed team member as an action.'},
                {name:'For Science!',cost:5,requirements:'Eureka ability, Science',category:'General',description:'You may spend a Eureka point to gain advantage on Charisma checks in addition to Intelligence and Wisdom checks.'},
                {name:'Hardy',cost:5,requirements:'Constitution 13+',category:'General',description:'Your maximum HP increases by your level.'},
                {name:'Heavy Armor Proficiency',cost:5,requirements:'Light Armor Proficiency',category:'General',description:'Gain proficiency in heavy armor.'},
                {name:'Improved Initiative',cost:6,requirements:'None',category:'General',description:'You may add your Proficiency bonus to Initiative checks.'},
                {name:'Improved Moxie',cost:6,requirements:'None',category:'General',description:'You may add your Proficiency bonus to Moxie checks.'},
                {name:'Light Armor Proficiency',cost:3,requirements:'None',category:'General',description:'Gain proficiency in light armor.'},
                {name:'Linguist',cost:5,requirements:'Charisma 13+, Culture',category:'General',description:'You can decipher the basics of an unknown language with a DC 20 Culture check and one week with a friendly speaker of the language.'},
                {name:'Man Down',cost:5,requirements:'First Aid ability',category:'General',description:'While you are conscious and within 1m of a dying team member, they require one fewer death saves to stabilize.'},
                {name:'Martial Arts Proficiency',cost:5,requirements:'None',category:'General',description:'You gain proficiency in a martial art and may make Martial Arts attacks, which deals 1d6 + Strength modifier damage.'},
                {name:'Martial Training',cost:5,requirements:'Proficient in 3 weapon types (except Common)',category:'Combat',description:'Your minimum damage die for melee weapons and Martial Arts is 1d8.'},
                {name:'Night Owl',cost:3,requirements:'None',category:'General',description:'When you go without rest you may make an Intelligence or Wisdom save in place of a Constitution save to resist exhaustion.'},
                {name:'Pathfinder',cost:3,requirements:'Survival',category:'General',description:'When your team becomes lost during a Traversal encounter, your team returns one fewer cards to the Journey deck (minimum 1).'},
                {name:'Pep Talk',cost:5,requirements:'Charisma 13+',category:'General',description:'As an action once per mission, you can restore 1d4 Determination points to each member of your team (including yourself).'},
                {name:'Physician Heal Thyself',cost:5,requirements:'First Aid ability',category:'General',description:'You may use a Med Kit on yourself as a bonus action.'},
                {name:'Rapid Recuperation',cost:5,requirements:'Constitution 13+',category:'General',description:'When you take a long rest, you heal 1d4 levels of exhaustion instead of 1.'},
                {name:'Resilient Mind',cost:5,requirements:'Intelligence 13+',category:'General',description:'When you suffer Intelligence, Wisdom, or Charisma damage, reduce the amount of damage suffered by 1 point (minimum 1).'},
                {name:'Resonant Words',cost:5,requirements:'Level 5, Word In An Ear ability',category:'General',description:'When you inspire a friendly character using Word In An Ear, you roll an additional Inspire die to determine how many Inspire HP the character gains.'},
                {name:'Skill Proficiency (1st)',cost:3,requirements:'None',category:'General',description:'Gain proficiency in a skill of your choice.'},
                {name:'Skill Proficiency (2nd)',cost:6,requirements:'Skill Proficiency (1st)',category:'General',description:'Gain proficiency in a second skill of your choice.'},
                {name:'Skill Proficiency (3rd)',cost:9,requirements:'Skill Proficiency (2nd)',category:'General',description:'Gain proficiency in a third skill of your choice.'},
                {name:'Strong Personality',cost:6,requirements:'Inspire ability',category:'General',description:'Your Inspire die increases one die size (1d6 to 1d8, 1d8 to 1d10, 1d10 to 1d12). Maximum 1d12.'},
                {name:'Team Player',cost:3,requirements:'Improved Initiative or Improved Moxie',category:'General',description:'When you roll Initiative or Moxie, you may exchange your result with a team member who has a lower value than you, if they wish.'},
                {name:'Tool Proficiency',cost:3,requirements:'None',category:'General',description:'Gain proficiency in a tool of your choice. You may select this ability multiple times, choosing a different tool each time.'},
                {name:'Tranquilizer Concoction',cost:5,requirements:'First Aid ability',category:'General',description:'Increase the Constitution save DC of your tranquilizer weapons or sedatives by your Proficiency bonus.'},
                {name:'Triage',cost:9,requirements:'First Aid ability',category:'General',description:'You can observe a character\'s current physical condition as a bonus action with a DC 20 Medicine check.'},
                {name:'Tune-Up',cost:5,requirements:'Engineering',category:'General',description:'You add your Intelligence modifier to the amount repaired whenever you repair a machine or grant a machine temporary HP.'},
                {name:'Unnoticed Field Medic',cost:9,requirements:'First Aid',category:'General',description:'When you heal a team member using first aid, attacks against you suffer disadvantage until your next turn.'},
                {name:'Unwavering',cost:3,requirements:'None',category:'General',description:'You increase your base Determination Points by +1. This feat may be purchased a number of times equal to your Proficiency bonus.'},
                {name:'Veil of Distractions',cost:5,requirements:'Stealth',category:'General',description:'Once per Infiltration encounter, when the Alertness track increases, you may reduce the current tension level by one step.'},
                {name:'Weapon Proficiency',cost:3,requirements:'None',category:'General',description:'Choose one type of weapon and gain proficiency in that weapon. You may select this ability multiple times, choosing a different weapon type each time.'},
                {name:'Whack-It',cost:9,requirements:'Engineering',category:'General',description:'As a bonus action you can give one adjacent machine +1d6 temporary hit points. You may only maintain these temporary HP on one machine at a time.'},
                {name:'Word In An Ear',cost:9,requirements:'Inspire ability',category:'General',description:'You can inspire a single team member within 1m as an action. Roll your Inspire HP die and grant the target Inspire HP as normal.'},
                {name:'Attack Specialist',cost:4,requirements:'Level 5',category:'Combat',description:'Choose one weapon proficiency. When making attacks with that proficiency you roll twice as many weapon damage dice for damage.'},
                {name:'Attack Veteran',cost:4,requirements:'Level 11, Attack Specialist',category:'Combat',description:'Choose one weapon proficiency with the Attack Specialist feat. When making attacks with that proficiency you roll triple weapon damage dice.'},
                {name:'Attack Ace',cost:4,requirements:'Level 17, Attack Veteran',category:'Combat',description:'Choose one weapon proficiency with the Attack Veteran feat. When making attacks with that proficiency you roll quadruple weapon damage dice.'},
                {name:'Critical Focus',cost:5,requirements:'Proficient with chosen weapon',category:'Combat',description:'Choose a weapon proficiency. When you score a critical hit with that weapon, add your Proficiency bonus to the damage dealt.'},
                {name:'Die Hard (1st)',cost:3,requirements:'Constitution 13+',category:'Combat',description:'You require 1 fewer successful saves to avoid dying. If you reduce the number of required saves to 0 you automatically stabilize.'},
                {name:'Die Hard (2nd)',cost:6,requirements:'Die Hard (1st)',category:'Combat',description:'You require 2 fewer successful saves to avoid dying.'},
                {name:'Die Hard (3rd)',cost:9,requirements:'Die Hard (2nd)',category:'Combat',description:'You require 3 fewer successful saves to avoid dying.'},
                {name:'Dodge',cost:5,requirements:'Dexterity 13',category:'Combat',description:'You add +1 to your AC when wearing light or no armor.'},
                {name:'Hip Fire',cost:5,requirements:'None',category:'Combat',description:'When you make ranged attacks while an enemy is within 1m, you do not suffer disadvantage on the attack.'},
                {name:'Improved Critical',cost:5,requirements:'Critical Focus',category:'Combat',description:'Your critical hit range increases by 1 (normally 19-20) with your chosen weapon.'},
                {name:'Martial Mastery',cost:7,requirements:'Proficient in 3 weapon types (except Common)',category:'Combat',description:'When making melee attacks with melee weapons or Martial Arts, increase the damage die one step (d4→d6, d6→d8, d8→d10, d10→d12). Maximum d12.'},
                {name:'Power Attack',cost:5,requirements:'Athletics',category:'Combat',description:'When you make a single melee attack during your turn with a weapon you are proficient with, you may take disadvantage on the attack roll to add +TD to the damage dealt.'},
                {name:'Precise Shot',cost:5,requirements:'None',category:'Combat',description:'When you make ranged attacks, the target does not gain the benefits of cover granted by creatures.'},
                {name:'Precision Strikes',cost:3,requirements:'Martial Arts Proficiency',category:'Combat',description:'Your Martial Arts attacks have the Finesse quality.'},
                {name:'Rapid Shot',cost:3,requirements:'None',category:'Combat',description:'You may treat Sidearms and Longarms you wield as if they had the burst quality. You may treat firearms with the burst quality as if they had the automatic quality.'},
                {name:'Trap Rigging',cost:5,requirements:'Survivalist ability',category:'General',description:'You can use excess equipment to booby trap a 1m area as an action. You can scavenge parts for a number of traps equal to your Proficiency bonus, refilling these parts during any long rest.'},
            ],

            // [Previous race, class, and origin data remains the same - I'll truncate here for space]
            races: {
                'Human': {
                    subraces: {
                        'Standard Human (Tau\'ri)': {hitPoints:10,abilityIncrease:{type:'choice',options:['intelligence','charisma'],value:2},abilities:['Recovery: Regain +TD HP on short rest','Galactic Seeds: Advantage on Persuasion/Deception during first contact'],proficiencies:{skills:{type:'choice',count:2}}},
                        'Abydonian': {hitPoints:10,abilityIncrease:{type:'choice',options:['constitution','charisma'],value:2},abilities:['Recovery: Regain +TD HP on short rest','Free from Ra: Advantage on saves against Goa\'uld technology'],proficiencies:{skills:{type:'choice',count:1},weapons:{type:'choice',count:1}}},
                        'Tollan': {hitPoints:8,abilityIncrease:{type:'choice',options:['intelligence','wisdom'],value:2},abilities:['Phase-Shift: Add phase device to base kit','Advanced Technology: +TD to Engineering checks for Tech Level 4+'],proficiencies:{skills:{type:'mixed',fixed:['Science'],additionalChoice:{count:1}}}}
                    }
                },
                'Jaffa': {
                    subraces: {
                        'Jaffa (With Symbiote)': {hitPoints:12,abilityIncrease:{type:'choice',options:['strength','dexterity'],value:2},abilities:['Symbiote: Advantage on physical saves (once per Proficiency bonus per long rest)','Kelno\'reem: Heal damage as if HD rolled max during long rest'],proficiencies:{weapons:{type:'fixed',list:['Jaffa Weapons']},skills:{type:'choice',count:1}}},
                        'Free Jaffa (Tretonin)': {hitPoints:10,abilityIncrease:{type:'choice',options:['dexterity','wisdom'],value:2},abilities:['Resistance Training: Half proficiency bonus to attack rolls with non-proficient weapons','Tretonin Prescription: Advantage on saves vs disease, suffer 1d4 Con damage daily without drug'],proficiencies:{weapons:{type:'fixed',list:['Jaffa Weapons']},skills:{type:'choice',count:1}}}
                    }
                },
                'Aturen': {
                    subraces: {
                        'Standard Aturen': {hitPoints:10,abilityIncrease:{type:'choice',options:['wisdom','charisma'],value:2},abilities:['Natural Resilience: Advantage on saves against disease or poison','Naturalist: Add +TD to Science checks involving ecosystems and creatures'],proficiencies:{skills:{type:'choice',count:2}}},
                        'Noxian Pacifist': {hitPoints:8,abilityIncrease:{type:'choice',options:['constitution','charisma'],value:2},abilities:['Natural Resilience: Advantage on saves against disease or poison','Invisibility: Become invisible for 1 minute as action (Prof bonus times per long rest)','Pacifist: Cannot willingly harm living creatures or take attack actions'],proficiencies:{skills:{type:'choice',count:2}}}
                    }
                },
                'Tok\'ra': {
                    subraces: {
                        'Tok\'ra (Egeria\'s Line)': {hitPoints:10,abilityIncrease:{type:'choice',options:['intelligence','wisdom'],value:2},abilities:['Synergistic Symbiote: Advantage on mental saves (once per Wis mod per long rest)','Regeneration: Heal to full HP during long rest','Genetic Memory: Access to centuries of knowledge','Naquadah in blood: Can use Goa\'uld/Tok\'ra technology'],proficiencies:{skills:{type:'choice',count:2}}},
                        'Pangaran Tok\'ra': {hitPoints:10,abilityIncrease:{type:'choice',options:['charisma','wisdom'],value:2},abilities:['Shrewd Diplomats: Use Int or Wis instead of Cha for Persuasion','Regeneration: Heal to full HP during long rest','No genetic memory (created with flaw)'],proficiencies:{skills:{type:'choice',count:2}}}
                    }
                },
                'Unas': {
                    subraces: {
                        'Standard Unas': {hitPoints:14,abilityIncrease:{type:'choice',options:['strength','constitution'],value:2},abilities:['Impressive Resilience: Gain damage resistance for TD rounds (once per long rest)','Robust: +4 Str for lifting/carrying, advantage on related Str checks','Claws: Natural weapons deal 1d6 damage'],proficiencies:{skills:{type:'choice',count:2}}},
                        'Unchained Unas': {hitPoints:14,abilityIncrease:{type:'choice',options:['strength','constitution'],value:2},abilities:['Impressive Resilience: Gain damage resistance for TD rounds (once per long rest)','Underestimated: Advantage on checks to conceal truth from non-Unas','Claws: Natural weapons deal 1d6 damage'],proficiencies:{skills:{type:'choice',count:2}}}
                    }
                },
            },

            classes: {
                'Diplomat': {hitDie:8,hpPerLevel:5,determinationBonus:2,proficiencies:{armor:['Light Armor'],weapons:['Common Weapons','Sidearms'],tools:['Research Kit'],saves:['Wisdom','Charisma'],skills:['Culture','Deception','Insight','Persuasion']},abilities:{1:['Inspire (1d6 temp HP to team during long rest)','Choose Inspiration feat'],2:['Pep Talk (restore 1d4 DP to team once per mission)','Word In An Ear (inspire single target)'],3:['Force of Will (use Inspire on short/long rest)','Choose 2nd Inspiration feat'],4:['Diplomatic Expertise (double proficiency on chosen skill)','Ability Score Improvement'],5:['Strong Personality (Inspire die to 1d8)','Choose 3rd Inspiration feat']},featChoices:{1:{type:'inspiration',count:1},3:{type:'inspiration',count:1},5:{type:'inspiration',count:1}}},
                'Engineer': {hitDie:8,hpPerLevel:5,determinationBonus:2,proficiencies:{armor:['Light Armor'],weapons:['Common Weapons','Sidearms','Longarms'],tools:['Engineering Kit','Explosives','Fabrication Kit'],saves:['Dexterity','Intelligence'],skills:['Engineering','Pilot','Perception']},abilities:{1:['Jury Rig (2d8 repair, action repair)','Choose Modification feat'],2:['Hold Together (resistance with cover)','Whack-It (1d6 temp HP bonus action)'],3:['Tune-Up (+Int to repairs)','Choose 2nd Modification feat'],4:['Broad Spectrum Scanners (Int for Perception)','Ability Score Improvement'],5:['Xeno-Tech Specialist (reduce R&D time)','Choose 3rd Modification feat']},featChoices:{1:{type:'modification',count:1},3:{type:'modification',count:1},5:{type:'modification',count:1}}},
                'Medic': {hitDie:8,hpPerLevel:5,determinationBonus:2,proficiencies:{armor:['Light Armor'],weapons:['Common Weapons','Sidearms','Shotguns'],tools:['Med Kit','Outbreak Kit'],saves:['Dexterity','Wisdom'],skills:['Athletics','Insight','Medicine','Science']},abilities:{1:['First Aid (add proficiency to healing, heal as action)','Choose Procedure feat'],2:['Triage (learn target HP with Medicine check)','Unnoticed Field Medic (disadvantage on attacks after healing)'],3:['Man Down (dying allies need fewer death saves)','Choose 2nd Procedure feat'],4:['Physician Heal Thyself (use med kit on self as bonus action)','Ability Score Improvement'],5:['First Response (add WIS modifier to healing)','Choose 3rd Procedure feat']},featChoices:{1:{type:'procedure',count:1},3:{type:'procedure',count:1},5:{type:'procedure',count:1}}},
                'Scientist': {hitDie:8,hpPerLevel:5,determinationBonus:2,proficiencies:{armor:['Light Armor'],weapons:['Common Weapons','Sidearms'],tools:['Explosives','Research Kit','Translator'],saves:['Intelligence','Wisdom'],skills:['Culture','Investigation','Nature','Science']},abilities:{1:['Eureka (gain points on Int/Wis failures)','Choose Discovery feat'],2:['Apt Analogy (+TD to ally checks)','Great Mind (immune to charm, advantage vs lies)'],3:['Cross-discipline Studies (half prof to non-proficient)','Choose 2nd Discovery feat'],4:['Resilient Mind (reduce mental damage)','Ability Score Improvement'],5:['Casual Genius (start with Eureka points)','For Science! (Eureka for Cha)','Choose 3rd Discovery feat']},featChoices:{1:{type:'discovery',count:1},3:{type:'discovery',count:1},5:{type:'discovery',count:1}}},
                'Scout': {hitDie:10,hpPerLevel:6,determinationBonus:1,proficiencies:{armor:['Light Armor'],weapons:['Common Weapons','Martial Arts','Bows','Sidearms','Longarms'],tools:['Camo Kit','Explosives'],saves:['Constitution','Dexterity'],skills:['Perception','Stealth','Survival']},abilities:{1:['Survivalist (resistance to environmental damage)','Choose Field Hack feat'],2:['Vanguard (+1d6 damage within 5m)','Trap Rigging (set traps as action)'],3:['Uncanny Dodge (reaction for resistance)','Scout\'s Cunning (bonus action dash/disengage/hide)'],4:['Ability Score Improvement','Choose 2nd Field Hack feat'],5:['Evasion (half damage on Dex saves)']},featChoices:{1:{type:'fieldHack',count:1},4:{type:'fieldHack',count:1}}},
                'Soldier': {hitDie:10,hpPerLevel:6,determinationBonus:1,proficiencies:{armor:['Light Armor','Heavy Armor'],weapons:['Common Weapons','Martial Arts','Sidearms','Longarms'],tools:['Camo Kit','Explosives'],saves:['Strength','Constitution'],skills:['Athletics','Intimidation','Pilot']},abilities:{1:['Tactical Flexibility (activate unknown tactic)','Choose Tactic feat'],2:['Surge (extra action, once per rest)','Rally (heal TD HP when wounded at combat start)'],3:['Martial Training (min d8 melee damage)','Improved Critical (19-20 with chosen weapon)'],4:['Ability Score Improvement','Choose 2nd Tactic feat'],5:['Tactical Superiority (two tactics active)']},featChoices:{1:{type:'tactic',count:1},4:{type:'tactic',count:1}}}
            },

            origins: {
                biome: [
                    {name:'Lunar',attribute:'Dexterity +1',ability:'Eager Astronomer: Advantage on Science checks pertaining to astronomy',description:'Your homeland was on a moon. You grew up in slightly lighter gravity.'},
                    {name:'Arboreal',attribute:'Strength +1',ability:'Natural Climber: Climb speed of 6m',description:'A forest or densely wooded area. You\'re an expert climber.'},
                    {name:'Mountainous',attribute:'Strength +1',ability:'Vertical Drop: Half falling damage',description:'Steep cliffs, fjords, and high altitudes. You\'ve got a strong physical core.'},
                    {name:'Artificial',attribute:'Wisdom +1',ability:'Life or Death Repairs: Advantage on engineering when failure would deal damage',description:'Your entire life was within a created environment like a space station.'},
                    {name:'Oceanic',attribute:'Wisdom +1',ability:'Gifted Swimmer: Swim speed of 6m',description:'Your homeworld\'s vast oceans gave rise to people who knew its tides and currents.'},
                    {name:'Desert',attribute:'Charisma +1',ability:'Heat Acclimated: Resistance to fire damage',description:'Your homeland was known for its water scarcity and high temperatures.'},
                    {name:'Rainforest',attribute:'Charisma +1',ability:'Tropics Adept: No disadvantage from rain or fog',description:'The forest canopy blocked out the skies of your world.'},
                    {name:'Grasslands',attribute:'Constitution +1',ability:'Natural Sprinter: +1m movement speed',description:'The rolling savannahs or tilled fields were a bounty for your people.'},
                    {name:'Starship',attribute:'Dexterity +1',ability:'Void Adept: Use Wis for Science checks',description:'You were raised aboard a vessel that travels the void of space.'},
                    {name:'Terraformed',attribute:'Intelligence +1',ability:'Strange World: 1/day reaction for advantage on save',description:'Your world was drastically altered by artificial means.'},
                    {name:'Swamp',attribute:'Wisdom +1',ability:'Patient Hunter: Use Wis for Stealth checks',description:'High water lines and dense foliage. You\'ve learned the value of being unseen.'},
                    {name:'Toxic',attribute:'Constitution +1',ability:'Toxic Resistance: Resist poison or necrotic (choose one)',description:'Your world\'s environment contains a substance deadly to other people of your species.'},
                    {name:'Urban',attribute:'Intelligence +1',ability:'Melting Pot: Use Cha for Culture checks',description:'Densely packed buildings and the press of people.'},
                    {name:'Tundra',attribute:'Constitution +1',ability:'Cold Acclimated: Resistance to cold damage',description:'The frozen flatlands of your homeland hid much of their bounty beneath the ground.'},
                    {name:'Volcanic',attribute:'Strength +1',ability:'Heat Acclimated: Resistance to fire damage',description:'Your civilization formed where your world\'s tectonic plates pressed upon one another.'},
                    {name:'Subterranean',attribute:'Dexterity +1',ability:'Improved Vision: Dim light counts as bright',description:'You grew up deep underground in caves, rarely if ever seeing the sky.'}
                ],
                background: [
                    {name:'Enforcement',proficiency:'Intimidation',ability:'Air of Authority: Others have disadvantage to intimidate you',description:'You wielded authority to maintain power.'},
                    {name:'Aviator',proficiency:'Pilot',ability:'Crash Landing: Resistance to damage when vehicle crashes',description:'Most pilots assigned to Phoenix Site are from the US Air Force.'},
                    {name:'Driver',proficiency:'Animal Handling',ability:'Speedster: Vehicles/animals you control gain +1 AC',description:'Controlling vehicles rapidly in various conditions.'},
                    {name:'Enslaved',proficiency:{type:'choice',options:['Tool'],description:'Choose one tool proficiency'},ability:'Friend to Toil: Suffer 1 less exhaustion level (min 1)',description:'Recently freed from slavery.'},
                    {name:'Former Host',ability:'Naquadah Blooded: Can use Goa\'uld tech, advantage vs symbiotes',description:'You once served as a host for a Goa\'uld symbiote.'},
                    {name:'Entertainer',proficiency:'Performance',ability:'Zeitgeist: Use Cha for art/performance understanding',description:'You\'re no stranger to the spotlight.'},
                    {name:'Freedom Fighter',proficiency:'Stealth',ability:'Last Resorts: Disadvantage on Moxie, advantage on Initiative',description:'You fought back against oppression.'},
                    {name:'Healer',proficiency:'Medicine',ability:'Soothe: Team heals +Prof bonus on rest',description:'You dedicated your life to healing.'},
                    {name:'Military',proficiency:{type:'choice',options:['Weapon','Armor'],description:'Choose one weapon or armor proficiency'},ability:'Drills: +1 HP per level',description:'You served in an organized military.'},
                    {name:'Herdsman',proficiency:'Animal Handling',ability:'Beastfriend: Use Cha instead of Wis for Animal Handling',description:'You\'ve learned to care for and train beasts.'},
                    {name:'Preservationist',proficiency:'Nature',ability:'Eye for Nature: Advantage on checks to identify plants',description:'You feel at home in natural environments.'},
                    {name:'Hunter/Gatherer',proficiency:'Survival',ability:'Irongut: Advantage vs poison',description:'You come from a pre-agricultural society.'},
                    {name:'Politician',proficiency:'Persuasion',ability:'Two Faces: Use Int instead of Cha for Deception',description:'You\'re a decision maker in organized government.'},
                    {name:'Liaison',proficiency:'Culture',ability:'Stranger to the Land: Advantage on Cha checks to hide foreign nature',description:'You\'re a go-between and trusted functionary.'},
                    {name:'Refugee',proficiency:'Athletics',ability:'New Environments: Advantage on Athletics in unknown wilderness',description:'You were forced to flee your lands.'},
                    {name:'Merchant',proficiency:'Insight',ability:'Efficient Logistics: +1 bulk capacity',description:'Your skills as a money maker are useful to Phoenix Site.'},
                    {name:'Sailor',proficiency:'Acrobatics',ability:'Sea Legs: Advantage to maintain balance',description:'You\'ve learned to keep your footing aboard a naval vessel.'},
                    {name:'Swindler',proficiency:'Deception',ability:'Low Profile: Use Deception for Stealth in populated areas',description:'You\'ve developed a skilled liar\'s tongue.'},
                    {name:'Scholar',proficiency:'Science',ability:'Preserve Knowledge: Advantage on Persuasion with scholars',description:'You dedicated yourself to collecting knowledge.'},
                    {name:'Teacher',proficiency:'Insight',ability:'Patient Approach: 1/mission use Wis save instead of another',description:'You\'ve spent your life honing minds.'},
                    {name:'Sentry',proficiency:'Perception',ability:'Long Night: Ignore first night without rest',description:'You\'re trained to keep vigilant.'},
                    {name:'Wright',proficiency:'Engineering',ability:'Measure Twice: Half prof bonus on non-proficient tools',description:'You\'ve learned to approach problems pragmatically.'},
                    {name:'Sleuth',proficiency:'Investigation',ability:'The Reveal: Advantage on Persuasion to accuse wrongdoing',description:'You\'ve sought troublesome truths.'},
                    {name:'Underworld',proficiency:'Sleight of Hand',ability:'Black Market: Advantage contacting underworld members',description:'You operated in the shadows of society.'},
                    {name:'Student',proficiency:'Perception',ability:'Quick Study: 1/mission use Int save instead of another',description:'Your eagerness to learn is directed into the unknown cosmos.'}
                ],
                racial: {
                    'Human': [
                        {
                            name:'Tau\'ri Military (Official)',
                            attribute:'None',
                            ability:'Basic Training: Proficient in martial arts, longarms, or heavy armor (pick one)',
                            restrictedTo:['Standard Human (Tau\'ri)'],
                            isHomebrew:false,
                            description:'The majority of personnel assigned to the Phoenix Site are from this background.'
                        },
                        {
                            name:'Tau\'ri Military (Homebrew)',
                            attribute:'choice',
                            attributeOptions:['Strength +1','Constitution +1'],
                            ability:'Never Surrender: You gain +1 to attack rolls for each level of exhaustion you have',
                            restrictedTo:['Standard Human (Tau\'ri)'],
                            isHomebrew:true,
                            description:'Elite soldier from Earth\'s most demanding military programs.'
                        }
                    ],
                    'Jaffa': [
                        {name:'Jaffa Renegade',attribute:'Wisdom +1',ability:'Rebel: Advantage on saves vs Goa\'uld and Jaffa',description:'Your eyes have opened to the Goa\'uld\'s petty nature.'},
                        {name:'Student of Bra\'tac',attribute:'Dexterity +1',ability:'Ma\'tok Mastery: Ma\'tok gains finesse property',description:'You trained under Master Bra\'tac.'}
                    ],
                    'Aturen': [{name:'Aturen Spiritualist',attribute:'None',ability:'Ritual of Life: You can lead a ritual during a short rest to restore the dead to life.',restrictedTo:['Noxian Pacifist'],description:'You have been chosen as a student by the Nox.'}],
                    'Tok\'ra': [{name:'Tok\'ra Spy',attribute:'Charisma +1',ability:'Passing: Advantage on Deception as Human/Goa\'uld/Jaffa',description:'Working endlessly against the Goa\'uld System Lords.'}],
                    'Unas': [{name:'Unas Alpha',attribute:'Charisma +1',ability:'Clan Leader: Other Unas gain advantage on saves/attacks',description:'You were once the alpha of a clan.'}]
                }
            },

            skills: ['Acrobatics','Athletics','Culture','Deception','Engineering','Insight','Intimidation','Investigation','Medicine','Nature','Perception','Performance','Persuasion','Pilot','Science','Sleight of Hand','Stealth','Survival'],
            weapons: ['Common Weapons','Bows','Martial Arts','Sidearms','Longarms','Shotguns','Grenades','Heavy Ordinance'],
            armor: ['Light Armor','Heavy Armor'],
            tools: ['Camo Kit','Explosives','Med Kit','Research Kit','Fabrication Kit','Translator','Engineering Kit','SCUBA','Pan-Cultural Wardrobe','Outbreak Kit']
        };

        // State
        let state = {
            character: {
                name: '',
                race: '',
                subrace: '',
                abilityChoice: '',
                origins: [],
                originChoices: {},
                raceChoices: {},
                class: '',
                level: 1,
                mpEarned: 0,
                mpSpent: 0,
                purchasedFeats: [],
                classFeats: [],
                duplicateProficiencyChoices: [],
                abilityScoreImprovements: {},
                abilityScores: {strength:10,dexterity:10,constitution:10,intelligence:10,wisdom:10,charisma:10},
                hp: 0,
                maxHp: 0,
                determinationPoints: 0,
                armorClass: 10,
                speed: 6,
                initiative: 0,
                moxie: 0,
                proficiencies: {armor:[],weapons:[],tools:[],saves:[],skills:[]},
                bonusFeats: []
            },
            showClassFeats: true,
            showClassAbilities: true,
            showFeatPurchase: false,
            attackSpecialistChoice: '',
            attackVeteranChoice: '',
            attackAceChoice: ''
        };

        // Calculate current level from MP spent (for levels 6+)
        const calculateLevel = () => {
            const c = state.character;
            if (c.level <= 5) return c.level;
            return Math.min(20, 5 + Math.floor(c.mpSpent / 10));
        };

        // Calculate MP needed for next level
        const mpForNextLevel = () => {
            const level = calculateLevel();
            if (level >= 20) return 0;
            if (level < 5) return (level + 1) * 5;
            return (level - 4) * 10;
        };

        // Utility functions
        const getModifier = score => Math.floor((score - 10) / 2);
        const getProficiencyBonus = level => level <= 4 ? 2 : level <= 8 ? 3 : level <= 12 ? 4 : level <= 16 ? 5 : 6;
        const pointBuyCost = {8:0,9:1,10:2,11:3,12:4,13:5,14:7,15:9};
        const getPointsSpent = () => Object.values(state.character.abilityScores).reduce((sum, score) => sum + (pointBuyCost[score] || 0), 0);

        // Helper function to find origin data
        const findOrigin = (name) => {
            for (const type of ['biome', 'background']) {
                const found = gameData.origins[type].find(o => o.name === name);
                if (found) return found;
            }
            for (const race in gameData.origins.racial) {
                const found = gameData.origins.racial[race].find(o => o.name === name);
                if (found) return found;
            }
            return null;
        };

        // Helper to get race data
        const getRaceData = () => gameData.races[state.character.race]?.subraces?.[state.character.subrace];
        const getClassData = () => gameData.classes[state.character.class];

        const isRacialOriginAvailable = (origin) => {
            if (!origin.restrictedTo) return true;
            return origin.restrictedTo.includes(state.character.subrace);
        };

        // Get proficiency display text for origins
        const getOriginProficiencyDisplay = (origin) => {
            if (!origin.proficiency) return '';
            if (typeof origin.proficiency === 'string') return origin.proficiency;
            if (origin.proficiency.type === 'choice') {
                return origin.proficiency.description || 'Choose proficiency';
            }
            return '';
        };

        const getAllSkillProficiencies = () => {
            const skills = [];
            const c = state.character;
            
            const cd = getClassData();
            if (cd) {
                cd.proficiencies.skills.forEach(s => skills.push({skill:s, source:'Class'}));
            }
            
            const rd = getRaceData();
            if (rd?.proficiencies?.skills) {
                if (rd.proficiencies.skills.type === 'mixed' && rd.proficiencies.skills.fixed) {
                    rd.proficiencies.skills.fixed.forEach(s => skills.push({skill:s, source:'Race'}));
                }
                if (c.raceChoices.skills) {
                    c.raceChoices.skills.forEach(s => skills.push({skill:s, source:'Race Choice'}));
                }
                if (c.raceChoices.additionalSkills) {
                    c.raceChoices.additionalSkills.forEach(s => skills.push({skill:s, source:'Race Choice'}));
                }
            }
            
            c.origins.forEach(o => {
                const origin = findOrigin(o);
                if (origin?.proficiency && typeof origin.proficiency === 'string' && gameData.skills.includes(origin.proficiency)) {
                    skills.push({skill:origin.proficiency, source:o});
                }
            });
            
            return skills;
        };

        const getDuplicateAnalysis = () => {
            const allProfs = getAllSkillProficiencies();
            const skillCounts = {};
            
            allProfs.forEach(({skill}) => {
                skillCounts[skill] = (skillCounts[skill] || 0) + 1;
            });
            
            const totalReplacements = Object.values(skillCounts).reduce((sum, count) => sum + Math.max(0, count - 1), 0);
            const duplicateSkills = Object.entries(skillCounts)
                .filter(([_, count]) => count > 1)
                .map(([skill, count]) => ({skill, duplicates: count - 1}));
            
            return { totalReplacements, duplicateSkills, skillCounts };
        };

        const getFinalSkillProficiencies = () => {
            const skills = new Set();
            const { skillCounts } = getDuplicateAnalysis();
            
            Object.keys(skillCounts).forEach(skill => skills.add(skill));
            state.character.duplicateProficiencyChoices.forEach(skill => {
                if (skill) skills.add(skill);
            });
            
            return Array.from(skills);
        };

        const getAbilityBonuses = ability => {
            let racial = 0, origin = 0, asi = 0;
            const c = state.character;
            const rd = getRaceData();
            
            if (rd?.abilityIncrease?.type === 'choice' && c.abilityChoice === ability) {
                racial = rd.abilityIncrease.value;
            }
            
            c.origins.forEach(oName => {
                const orig = findOrigin(oName);
                if (orig?.attribute && orig.attribute !== 'None') {
                    if (orig.attribute === 'choice') {
                        const chosen = c.originChoices[oName];
                        if (chosen) {
                            const [attr, val] = chosen.split(' +');
                            if (attr.toLowerCase() === ability) origin += parseInt(val);
                        }
                    } else {
                        const [attr, val] = orig.attribute.split(' +');
                        if (attr.toLowerCase() === ability) origin += parseInt(val);
                    }
                }
            });
            
            if (c.level >= 4) {
                Object.values(c.abilityScoreImprovements).forEach(imp => {
                    if (imp === ability) asi += 1;
                    else if (imp === `${ability}_2`) asi += 2;
                });
            }
            
            // Add bonuses from purchased Ability Score Increase feats
            c.purchasedFeats.forEach(featName => {
                if (featName.startsWith('Ability Score Increase:')) {
                    const abilityName = featName.split(':')[1].trim();
                    if (abilityName.toLowerCase() === ability) asi += 1;
                }
            });
            
            return {racial, origin, asi};
        };

        const getFinalAbilityScores = () => {
            const scores = {...state.character.abilityScores};
            Object.keys(scores).forEach(a => {
                const {racial, origin, asi} = getAbilityBonuses(a);
                scores[a] += racial + origin + asi;
            });
            return scores;
        };

        const updateDerivedStats = () => {
            const c = state.character;
            const rd = getRaceData();
            const cd = getClassData();
            const fs = getFinalAbilityScores();
            const mods = Object.fromEntries(Object.entries(fs).map(([k,v]) => [k, getModifier(v)]));
            
            // Update level from MP
            c.level = calculateLevel();
            
            if (rd && cd) {
                let bonusHp = c.origins.includes('Military') ? c.level : 0;
                
                // Check for Hardy feat
                const hardyCount = c.purchasedFeats.filter(f => f === 'Hardy').length;
                bonusHp += hardyCount * c.level;
                
                const hpBase = cd.hitDie + mods.constitution + rd.hitPoints + bonusHp;
                c.hp = c.maxHp = Math.max(1, hpBase + (c.level > 1 ? (c.level - 1) * (cd.hpPerLevel + mods.constitution) : 0));
            }
            
            c.armorClass = 10 + mods.dexterity + (c.purchasedFeats.includes('Dodge') ? 1 : 0);
            c.initiative = Math.max(mods.dexterity, mods.wisdom) + (c.purchasedFeats.includes('Improved Initiative') ? getProficiencyBonus(c.level) : 0);
            c.moxie = Math.max(mods.intelligence, mods.charisma) + (c.purchasedFeats.includes('Improved Moxie') ? getProficiencyBonus(c.level) : 0);
            c.speed = c.origins.includes('Grasslands') ? 7 : 6;
            
            let baseDp = Math.floor((c.level + 4) / 5) * 2 + (cd?.determinationBonus || 0);
            const unwaveringsCount = c.purchasedFeats.filter(f => f === 'Unwavering').length;
            c.determinationPoints = baseDp + unwaveringsCount;
            
            // Auto-grant bonus feats at appropriate levels
            c.bonusFeats = [];
            if (c.level >= 5) c.bonusFeats.push('Attack Specialist');
            if (c.level >= 11) c.bonusFeats.push('Attack Veteran');
            if (c.level >= 17) c.bonusFeats.push('Attack Ace');
        };

        const getProficiencyDescription = (proficiencies) => {
            const descriptions = [];
            
            if (proficiencies?.skills) {
                if (proficiencies.skills.type === 'choice') {
                    descriptions.push(`Choose ${proficiencies.skills.count} skill${proficiencies.skills.count > 1 ? 's' : ''}`);
                } else if (proficiencies.skills.type === 'mixed') {
                    const fixedSkills = proficiencies.skills.fixed.join(', ');
                    descriptions.push(`${fixedSkills} (fixed)`);
                    if (proficiencies.skills.additionalChoice) {
                        descriptions.push(`Choose ${proficiencies.skills.additionalChoice.count} additional skill${proficiencies.skills.additionalChoice.count > 1 ? 's' : ''}`);
                    }
                }
            }
            
            if (proficiencies?.weapons) {
                if (proficiencies.weapons.type === 'choice') {
                    descriptions.push(`Choose ${proficiencies.weapons.count} weapon proficiency`);
                } else if (proficiencies.weapons.type === 'fixed') {
                    descriptions.push(`${proficiencies.weapons.list.join(', ')} (fixed)`);
                }
            }
            
            return descriptions;
        };

        // Check if a feat meets requirements
        const meetsFeatRequirements = (feat) => {
            const c = state.character;
            const fs = getFinalAbilityScores();
            
            if (feat.requirements === 'None' || !feat.requirements) return true;
            
            // Check level requirements
            if (feat.requirements.includes('Level')) {
                const levelMatch = feat.requirements.match(/Level (\d+)/);
                if (levelMatch && c.level < parseInt(levelMatch[1])) return false;
            }
            
            // Check ability score requirements
            const abilityMatch = feat.requirements.match(/(Strength|Dexterity|Constitution|Intelligence|Wisdom|Charisma) (\d+)\+/);
            if (abilityMatch) {
                const ability = abilityMatch[1].toLowerCase();
                const required = parseInt(abilityMatch[2]);
                if (fs[ability] < required) return false;
            }
            
            // Check skill/tool/weapon proficiency requirements
            const skills = getFinalSkillProficiencies();
            if (feat.requirements.includes('proficiency') || feat.requirements.includes('Proficiency')) {
                const reqParts = feat.requirements.split(',').map(r => r.trim());
                for (const req of reqParts) {
                    if (gameData.skills.some(s => req.includes(s))) {
                        if (!skills.includes(gameData.skills.find(s => req.includes(s)))) return false;
                    }
                }
            }
            
            // Check base ability requirements (Inspire, Eureka, etc)
            if (feat.baseRequirement) {
                const cd = getClassData();
                if (!cd) return false;
                
                // Check if character has the base ability from their class OR from purchased feats
                const hasFromClass = c.classFeats.length > 0; // Simplified check
                const hasFromAdvanced = c.purchasedFeats.some(f => 
                    f.includes('Advanced Training') && f.includes(feat.baseRequirement)
                );
                
                if (!hasFromClass && !hasFromAdvanced) return false;
            }
            
            // Check prerequisite feats
            if (feat.requirements.includes('Attack Specialist') && !c.bonusFeats.includes('Attack Specialist') && !c.purchasedFeats.some(f => f.includes('Attack Specialist'))) return false;
            if (feat.requirements.includes('Attack Veteran') && !c.bonusFeats.includes('Attack Veteran') && !c.purchasedFeats.some(f => f.includes('Attack Veteran'))) return false;
            
            // Check for Die Hard progression
            if (feat.name.includes('Die Hard (2nd)') && !c.purchasedFeats.includes('Die Hard (1st)')) return false;
            if (feat.name.includes('Die Hard (3rd)') && !c.purchasedFeats.includes('Die Hard (2nd)')) return false;
            
            // Check for Skill Proficiency progression
            if (feat.name.includes('Skill Proficiency (2nd)') && !c.purchasedFeats.some(f => f.includes('Skill Proficiency (1st)'))) return false;
            if (feat.name.includes('Skill Proficiency (3rd)') && !c.purchasedFeats.some(f => f.includes('Skill Proficiency (2nd)'))) return false;
            
            return true;
        };

        // Purchase a feat
        const purchaseFeat = (feat, choice = '') => {
            const c = state.character;
            if (c.mpSpent + feat.cost > c.mpEarned) return false;
            if (!meetsFeatRequirements(feat)) return false;
            
            const featName = choice ? `${feat.name}: ${choice}` : feat.name;
            c.purchasedFeats.push(featName);
            c.mpSpent += feat.cost;
            updateDerivedStats();
            return true;
        };

        // Refund a feat
        const refundFeat = (featName) => {
            const c = state.character;
            const index = c.purchasedFeats.indexOf(featName);
            if (index === -1) return false;
            
            // Find the feat cost
            const baseFeatName = featName.split(':')[0].trim();
            let feat = gameData.generalFeats.find(f => f.name === baseFeatName);
            if (!feat) {
                // Check class feats
                Object.values(gameData.classFeatsByType).forEach(typeFeats => {
                    const found = typeFeats.find(f => f.name === baseFeatName);
                    if (found) feat = found;
                });
            }
            if (!feat) {
                feat = gameData.fieldHackFeats.find(f => f.name === baseFeatName);
            }
            
            if (feat) {
                c.purchasedFeats.splice(index, 1);
                c.mpSpent -= feat.cost;
                updateDerivedStats();
                return true;
            }
            return false;
        };

        const exportCharacter = () => {
            const c = state.character;
            const rd = getRaceData();
            const cd = getClassData();
            const fs = getFinalAbilityScores();
            
            let classAbilities = [];
            if (cd) {
                for (let lvl = 1; lvl <= Math.min(5, c.level); lvl++) {
                    if (cd.abilities[lvl]) {
                        cd.abilities[lvl].forEach(ability => {
                            classAbilities.push(`• Level ${lvl} - ${ability}`);
                        });
                    }
                }
            }
            
            let selectedFeats = [];
            c.classFeats.forEach(featName => {
                let feat = null;
                if (c.class === 'Scout') {
                    feat = gameData.fieldHackFeats.find(f => f.name === featName);
                } else {
                    Object.values(gameData.classFeatsByType).forEach(typeFeats => {
                        const found = typeFeats.find(f => f.name === featName);
                        if (found) feat = found;
                    });
                }
                if (feat) {
                    selectedFeats.push(`• ${feat.name}: ${feat.description}`);
                }
            });
            
            let originsWithEffects = [];
            c.origins.forEach(originName => {
                const origin = findOrigin(originName);
                
                if (origin) {
                    let effects = [];
                    if (origin.attribute && origin.attribute !== 'None') {
                        if (origin.attribute === 'choice' && c.originChoices[originName]) {
                            effects.push(c.originChoices[originName]);
                        } else if (origin.attribute !== 'choice') {
                            effects.push(origin.attribute);
                        }
                    }
                    if (origin.proficiency) {
                        const prof = typeof origin.proficiency === 'string' ? 
                                    `Proficiency: ${origin.proficiency}` : 
                                    origin.proficiency.type === 'choice' ? 
                                    (c.originChoices[originName] ? `Proficiency: ${c.originChoices[originName]}` : `Proficiency: Choice not yet made`) : 
                                    'Special';
                        effects.push(prof);
                    }
                    if (origin.ability) effects.push(origin.ability);
                    originsWithEffects.push(`• ${originName}${origin.isHomebrew ? ' (Homebrew)' : ''}: ${effects.join(', ')}`);
                }
            });
            
            let additionalProfs = [];
            if (c.raceChoices.weapons?.length > 0) {
                additionalProfs.push(`Weapons: ${c.raceChoices.weapons.join(', ')}`);
            }
            
            if (c.origins.includes('Tau\'ri Military (Official)') && c.originChoices['Tau\'ri Military (Official)']) {
                additionalProfs.push(`Basic Training: ${c.originChoices['Tau\'ri Military (Official)']}`);
            }
            
            const sheet = `STARGATE RPG CHARACTER SHEET
${'='.repeat(50)}

## BASIC INFORMATION

Name: ${c.name || 'Unnamed Character'}
Race: ${c.race} (${c.subrace})
Class: ${c.class}
Level: ${c.level}
${c.level > 5 ? `Mission Points: ${c.mpEarned} earned, ${c.mpSpent} spent (${c.mpEarned - c.mpSpent} available)` : ''}

## ABILITY SCORES

Strength:     ${fs.strength} (${getModifier(fs.strength) >= 0 ? '+' : ''}${getModifier(fs.strength)})
Dexterity:    ${fs.dexterity} (${getModifier(fs.dexterity) >= 0 ? '+' : ''}${getModifier(fs.dexterity)})
Constitution: ${fs.constitution} (${getModifier(fs.constitution) >= 0 ? '+' : ''}${getModifier(fs.constitution)})
Intelligence: ${fs.intelligence} (${getModifier(fs.intelligence) >= 0 ? '+' : ''}${getModifier(fs.intelligence)})
Wisdom:       ${fs.wisdom} (${getModifier(fs.wisdom) >= 0 ? '+' : ''}${getModifier(fs.wisdom)})
Charisma:     ${fs.charisma} (${getModifier(fs.charisma) >= 0 ? '+' : ''}${getModifier(fs.charisma)})

## COMBAT STATISTICS

Hit Points: ${c.hp}/${c.maxHp}
Armor Class: ${c.armorClass}
Initiative: ${c.initiative >= 0 ? '+' : ''}${c.initiative}
Speed: ${c.speed}m
Determination Points: ${c.determinationPoints}
Moxie: ${c.moxie >= 0 ? '+' : ''}${c.moxie}
Proficiency Bonus: +${getProficiencyBonus(c.level)}

## SKILL PROFICIENCIES

${getFinalSkillProficiencies().join(', ')}

## CLASS BONUSES

Saving Throws: ${cd ? cd.proficiencies.saves.join(', ') : 'None'}
Armor: ${cd ? cd.proficiencies.armor.join(', ') : 'None'}
Weapons: ${cd ? cd.proficiencies.weapons.join(', ') : 'None'}
Tools: ${cd ? cd.proficiencies.tools.join(', ') : 'None'}

${additionalProfs.length > 0 ? `## ADDITIONAL PROFICIENCIES

${additionalProfs.join('\n')}` : ''}

## CLASS ABILITIES (Levels 1-5)

${classAbilities.length > 0 ? classAbilities.join('\n') : '• None'}

## CLASS FEATS SELECTED (Levels 1-5)

${selectedFeats.length > 0 ? selectedFeats.join('\n') : '• None'}

${c.purchasedFeats.length > 0 ? `## PURCHASED FEATS (Levels 6+)

${c.purchasedFeats.map(f => `• ${f}`).join('\n')}` : ''}

${c.bonusFeats.length > 0 ? `## BONUS FEATS

${c.bonusFeats.map(f => {
    if (f === 'Attack Specialist' && state.attackSpecialistChoice) return `• ${f} (${state.attackSpecialistChoice})`;
    if (f === 'Attack Veteran' && state.attackVeteranChoice) return `• ${f} (${state.attackVeteranChoice})`;
    if (f === 'Attack Ace' && state.attackAceChoice) return `• ${f} (${state.attackAceChoice})`;
    return `• ${f}`;
}).join('\n')}` : ''}

## ORIGINS

${originsWithEffects.join('\n')}

## RACIAL ABILITIES

${rd ? rd.abilities.map(a => `• ${a}`).join('\n') : '• None'}

${c.level >= 4 && Object.keys(c.abilityScoreImprovements).length > 0 ? `## ABILITY SCORE IMPROVEMENTS (Level 4)

${Object.entries(c.abilityScoreImprovements).map(([key, value]) => {
    if (value.endsWith('_2')) return `• ${value.replace('_2', '')} +2`;
    return `• ${value} +1`;
}).join('\n')}` : ''}`;

            const blob = new Blob([sheet], {type: 'text/plain'});
            const a = document.createElement('a');
            a.href = URL.createObjectURL(blob);
            a.download = `${c.name || 'character'}_stargate_rpg_lvl${c.level}.txt`;
            a.click();
        };

        // Rendering helper
        const section = (title, content, highlight = false) => `
            <div class="${highlight ? 'bg-yellow-500/20 border-2 border-yellow-500' : 'bg-gray-700/50'} rounded-lg p-4">
                ${title ? `<label class="block text-sm font-medium ${highlight ? 'text-yellow-300' : 'text-gray-300'} mb-2">${title}</label>` : ''}
                ${content}
            </div>
        `;

        // Button renderer
        const renderButton = (data, selected, disabled = false, classes = '') => {
            const baseClasses = 'p-3 rounded-lg border-2 transition-all';
            const stateClasses = selected ? 'border-blue-500 bg-blue-500/20 text-white' : 
                                disabled ? 'border-gray-600 bg-gray-800 opacity-50 cursor-not-allowed' :
                                'border-gray-600 bg-gray-800 text-gray-300 hover:border-gray-500';
            return `${baseClasses} ${stateClasses} ${classes}`;
        };

        // Main render function
        const render = () => {
            updateDerivedStats();
            
            const { totalReplacements } = getDuplicateAnalysis();
            
            if (totalReplacements !== state.character.duplicateProficiencyChoices.length) {
                state.character.duplicateProficiencyChoices = new Array(totalReplacements).fill('');
            }
            
            document.getElementById('app').innerHTML = `
                <div class="max-w-7xl mx-auto">
                    <div class="bg-gray-800/90 backdrop-blur-sm rounded-lg shadow-2xl border border-blue-500/30">
                        <div class="bg-gradient-to-r from-blue-600 to-purple-600 p-6 rounded-t-lg">
                            <h1 class="text-3xl font-bold text-white flex items-center gap-3">
                                <div class="w-10 h-10 bg-white/20 rounded-full flex items-center justify-center">${icons.target}</div>
                                Stargate RPG Character Builder (Levels 1-20)
                            </h1>
                            <p class="text-blue-100 mt-2">Create your Phoenix Site operative from Level 1 to Level 20</p>
                        </div>
                        
                        <div class="p-6 space-y-6">
                            ${renderSections()}
                        </div>
                    </div>
                </div>
            `;
            
            attachEventListeners();
        };

        const renderSections = () => {
            const c = state.character;
            const rd = getRaceData();
            const cd = getClassData();
            const { totalReplacements, duplicateSkills } = getDuplicateAnalysis();
            const ps = getPointsSpent();
            
            const sections = [];
            
            // Character name
            sections.push(section('Character Name', `
                <input id="character-name" value="${c.name}" class="w-full px-4 py-2 bg-gray-800 border border-gray-600 rounded-lg text-white" placeholder="Enter character name..."/>
            `));

            // [Previous sections for race, subrace, ability choice, etc. remain the same until Level Selection...]
            
            // Race selection
            sections.push(section('Select Race', `
                <div class="grid grid-cols-2 md:grid-cols-3 gap-3">
                    ${Object.keys(gameData.races).map(race => `
                        <button data-race="${race}" class="race-btn ${renderButton(null, c.race === race)}">
                            <div class="font-semibold">${race}</div>
                            <div class="text-xs mt-1 opacity-75">${Object.keys(gameData.races[race].subraces).length} variant(s)</div>
                        </button>
                    `).join('')}
                </div>
            `));
            
            // [Subrace, ability choice, proficiency sections remain the same...]
            
            if (c.race) {
                sections.push(section(`Select ${c.race} Variant`, Object.entries(gameData.races[c.race].subraces).map(([name, data]) => {
                    const profDesc = getProficiencyDescription(data.proficiencies);
                    return `
                        <div data-subrace="${name}" class="subrace-btn p-4 rounded-lg border-2 cursor-pointer transition-all ${
                            c.subrace === name ? 'border-green-500 bg-green-500/20' : 'border-gray-600 bg-gray-800 hover:border-gray-500'
                        }">
                            <div class="font-semibold text-white mb-2">${name}</div>
                            <div class="text-xs text-gray-400 space-y-1">
                                <div>HP Bonus: +${data.hitPoints}</div>
                                <div class="flex items-start gap-1">
                                    <span>Ability Increase:</span>
                                    <span class="${data.abilityIncrease.type === 'choice' ? 'text-yellow-300' : 'text-gray-400'}">
                                        ${data.abilityIncrease.type === 'choice' ? 
                                            `${icons.alertCircle} Choose ONE: +${data.abilityIncrease.value} to ${data.abilityIncrease.options.join(' OR ')}`
                                            : 
                                            'Fixed bonuses'
                                        }
                                    </span>
                                </div>
                                
                                ${profDesc.length > 0 ? `
                                    <div class="mt-2">
                                        <span class="font-semibold text-gray-300">Proficiencies:</span>
                                        <ul class="ml-2 mt-1">
                                            ${profDesc.map(desc => `
                                                <li class="text-xs text-blue-300">• ${desc}</li>
                                            `).join('')}
                                        </ul>
                                    </div>
                                ` : ''}
                                
                                <div class="mt-2">
                                    <span class="font-semibold text-gray-300">Abilities:</span>
                                    <ul class="ml-2 mt-1">
                                        ${data.abilities.map(a => `<li class="text-xs">• ${a}</li>`).join('')}
                                    </ul>
                                </div>
                            </div>
                        </div>
                    `;
                }).join('')));
            }
            
            // Ability choice
            if (rd?.abilityIncrease?.type === 'choice') {
                sections.push(section('Choose ONE Ability Score Increase (+' + rd.abilityIncrease.value + ')', `
                    <div class="grid grid-cols-2 md:grid-cols-3 gap-2">
                        ${rd.abilityIncrease.options.map(a => `
                            <button data-ability-choice="${a}" class="ability-choice-btn p-3 rounded capitalize transition-all font-semibold ${
                                c.abilityChoice === a ? 'bg-purple-500/20 border-2 border-purple-500 text-white' : 'bg-gray-800 border-2 border-gray-600 text-gray-300 hover:border-gray-500'
                            }">
                                ${a}
                                ${c.abilityChoice === a ? '<div class="text-xs mt-1 text-purple-300">✓ Selected</div>' : ''}
                            </button>
                        `).join('')}
                    </div>
                `, !c.abilityChoice));
            }
            
            // [Race proficiencies and origins sections - keeping original code...]
            // Race weapon proficiencies
            if (rd?.proficiencies?.weapons?.type === 'choice') {
                sections.push(section(`Choose ${rd.proficiencies.weapons.count} Weapon Proficienc${rd.proficiencies.weapons.count > 1 ? 'ies' : 'y'}`, `
                    <div class="grid grid-cols-2 md:grid-cols-3 gap-2">
                        ${gameData.weapons.map(w => {
                            const sel = c.raceChoices.weapons?.includes(w);
                            const max = c.raceChoices.weapons?.length >= rd.proficiencies.weapons.count;
                            return `<button data-race-weapon="${w}" class="race-weapon-btn p-2 rounded text-xs transition-all ${
                                sel ? 'bg-green-500/20 border border-green-500 text-white' : 
                                max && !sel ? 'bg-gray-800 border border-gray-600 text-gray-300 opacity-50' : 
                                'bg-gray-800 border border-gray-600 text-gray-300 hover:border-gray-500'
                            }">${w}</button>`;
                        }).join('')}
                    </div>
                `));
            }
            
            // Race proficiencies
            if (rd?.proficiencies?.skills) {
                const skillContent = rd.proficiencies.skills.type === 'choice' ? `
                    <div class="grid grid-cols-3 md:grid-cols-4 gap-2">
                        ${gameData.skills.map(s => {
                            const sel = c.raceChoices.skills?.includes(s);
                            const max = c.raceChoices.skills?.length >= rd.proficiencies.skills.count;
                            return `<button data-race-skill="${s}" class="race-skill-btn p-2 rounded text-xs transition-all ${
                                sel ? 'bg-green-500/20 border border-green-500 text-white' : 
                                max && !sel ? 'bg-gray-800 border border-gray-600 text-gray-300 opacity-50' : 
                                'bg-gray-800 border border-gray-600 text-gray-300 hover:border-gray-500'
                            }">${s}</button>`;
                        }).join('')}
                    </div>
                ` : rd.proficiencies.skills.type === 'mixed' ? `
                    <div class="mb-4">
                        <span class="text-sm font-medium text-gray-300">Fixed Skill Proficiencies</span>
                        <div class="flex gap-2 mt-2">
                            ${rd.proficiencies.skills.fixed.map(skill => `
                                <span class="px-3 py-1 bg-blue-500/20 border border-blue-500 text-blue-300 rounded text-sm">
                                    ${skill} (Automatic)
                                </span>
                            `).join('')}
                        </div>
                    </div>
                    ${rd.proficiencies.skills.additionalChoice ? `
                        <div>
                            <label class="block text-sm font-medium text-gray-300 mb-2">
                                Choose ${rd.proficiencies.skills.additionalChoice.count} Additional Skill Proficienc${rd.proficiencies.skills.additionalChoice.count > 1 ? 'ies' : 'y'}
                            </label>
                            <div class="grid grid-cols-3 md:grid-cols-4 gap-2">
                                ${gameData.skills.filter(s => !rd.proficiencies.skills.fixed.includes(s)).map(s => {
                                    const sel = c.raceChoices.additionalSkills?.includes(s);
                                    const max = c.raceChoices.additionalSkills?.length >= rd.proficiencies.skills.additionalChoice.count;
                                    return `<button data-additional-skill="${s}" class="additional-skill-btn p-2 rounded text-xs transition-all ${
                                        sel ? 'bg-green-500/20 border border-green-500 text-white' : 
                                        max && !sel ? 'bg-gray-800 border border-gray-600 text-gray-300 opacity-50' : 
                                        'bg-gray-800 border border-gray-600 text-gray-300 hover:border-gray-500'
                                    }">${s}</button>`;
                                }).join('')}
                            </div>
                        </div>
                    ` : ''}
                ` : '';
                
                sections.push(section(rd.proficiencies.skills.type === 'choice' ? `Choose ${rd.proficiencies.skills.count} Skill Proficienc${rd.proficiencies.skills.count > 1 ? 'ies' : 'y'}` : 'Skill Proficiencies', skillContent));
            }
            
            // Origins with descriptions
            sections.push(section('Select Origins (Choose 2 from different categories)', `
                ${['biome', 'background'].map(type => `
                    <div class="mb-4">
                        <h3 class="text-sm font-semibold text-gray-400 mb-2">${type[0].toUpperCase() + type.slice(1)} Origins</h3>
                        <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-2 max-h-96 overflow-y-auto p-1">
                            ${gameData.origins[type].map(o => {
                                const sel = c.origins.includes(o.name);
                                const hasType = c.origins.some(x => gameData.origins[type].find(y => y.name === x));
                                const dis = !sel && (c.origins.length >= 2 || hasType);
                                const isIncompatible = o.name === 'Former Host' && c.race === 'Jaffa';
                                const proficiencyDisplay = getOriginProficiencyDisplay(o);
                                
                                return `
                                    <button data-origin="${o.name}" data-origin-type="${type}" class="origin-btn p-3 text-left rounded border transition-all ${
                                        sel ? 'border-blue-500 bg-blue-500/20' : 
                                        isIncompatible ? 'border-red-600 bg-red-900/20 opacity-50 cursor-not-allowed' :
                                        dis ? 'border-gray-600 bg-gray-800 opacity-50' : 
                                        'border-gray-600 bg-gray-800 hover:border-gray-500'
                                    }">
                                        <div class="font-semibold text-sm text-white">
                                            ${o.name}
                                            ${isIncompatible ? '<span class="text-xs text-red-400">(Incompatible with Jaffa)</span>' : ''}
                                        </div>
                                        ${o.description ? `<div class="text-xs text-gray-300 italic mt-1 mb-2">${o.description}</div>` : ''}
                                        <div class="text-xs text-green-400 mt-1">
                                            ${o.attribute !== 'None' && o.attribute ? o.attribute : ''}
                                            ${proficiencyDisplay ? (o.attribute && o.attribute !== 'None' ? ' | ' : '') + proficiencyDisplay : ''}
                                        </div>
                                        <div class="text-xs text-gray-400">${o.ability}</div>
                                    </button>
                                `;
                            }).join('')}
                        </div>
                    </div>
                `).join('')}
                
                ${c.race && gameData.origins.racial[c.race] ? `
                    <div>
                        <h3 class="text-sm font-semibold text-gray-400 mb-2">Racial Origins (${c.race})</h3>
                        <div class="grid grid-cols-1 md:grid-cols-2 gap-2">
                            ${gameData.origins.racial[c.race].map(o => {
                                const sel = c.origins.includes(o.name);
                                const disabled = !sel && c.origins.length >= 2;
                                const notAvailable = !isRacialOriginAvailable(o);
                                const proficiencyDisplay = getOriginProficiencyDisplay(o);
                                
                                return `
                                    <button data-origin="${o.name}" data-origin-type="racial" class="origin-btn p-3 text-left rounded border transition-all ${
                                        sel ? 'border-blue-500 bg-blue-500/20' : 
                                        notAvailable ? 'border-red-600 bg-red-900/20 opacity-50 cursor-not-allowed' :
                                        disabled ? 'border-gray-600 bg-gray-800 opacity-50' : 
                                        'border-gray-600 bg-gray-800 hover:border-gray-500'
                                    }">
                                        <div class="font-semibold text-sm text-white">
                                            ${o.name}
                                            ${o.isHomebrew ? '<span class="text-yellow-300 text-xs">(Homebrew)</span>' : ''}
                                            ${notAvailable ? `<span class="text-xs text-red-400">(Only for ${o.restrictedTo.join(', ')})</span>` : ''}
                                        </div>
                                        ${o.description ? `<div class="text-xs text-gray-300 italic mt-1 mb-2">${o.description}</div>` : ''}
                                        <div class="text-xs text-green-400 mt-1">
                                            ${o.attribute !== 'None' && o.attribute !== 'choice' && o.attribute ? o.attribute : ''}
                                            ${o.attribute === 'choice' && o.attributeOptions ? `Choose: ${o.attributeOptions.join(' OR ')}` : ''}
                                            ${proficiencyDisplay ? (o.attribute && o.attribute !== 'None' ? ' | ' : '') + proficiencyDisplay : ''}
                                        </div>
                                        <div class="text-xs text-gray-400">${o.ability}</div>
                                    </button>
                                `;
                            }).join('')}
                        </div>
                    </div>
                ` : ''}
            `));
            
            // Origin proficiency choices (same as before)
            const originsWithChoices = c.origins.filter(o => {
                const origin = findOrigin(o);
                return origin?.proficiency?.type === 'choice' || origin?.attribute === 'choice' || o === 'Tau\'ri Military (Official)';
            });
            
            if (originsWithChoices.length > 0) {
                sections.push(section('Origin Choices', originsWithChoices.map(originName => {
                    const origin = findOrigin(originName);
                    let content = '';
                    
                    // [Keep original origin choice rendering logic...]
                    if (originName === 'Tau\'ri Military (Official)') {
                        const basicTrainingOptions = ['Martial Arts', 'Longarms', 'Heavy Armor'];
                        content += `
                            <div class="mb-4">
                                <label class="block text-sm font-medium text-gray-300 mb-2">
                                    Tau'ri Military (Official) - Choose Basic Training:
                                </label>
                                <div class="grid grid-cols-3 gap-2">
                                    ${basicTrainingOptions.map(option => `
                                        <button data-origin-choice="${originName}" data-choice="${option}" 
                                            class="origin-choice-btn p-2 rounded text-xs transition-all ${
                                                c.originChoices[originName] === option ? 
                                                'bg-green-500/20 border border-green-500 text-white' : 
                                                'bg-gray-800 border border-gray-600 text-gray-300 hover:border-gray-500'
                                            }">
                                            ${option}
                                        </button>
                                    `).join('')}
                                </div>
                            </div>
                        `;
                    }
                    
                    if (origin?.attribute === 'choice' && origin?.attributeOptions) {
                        content += `
                            <div class="mb-4">
                                <label class="block text-sm font-medium text-gray-300 mb-2">
                                    ${originName} - Choose one attribute:
                                </label>
                                <div class="grid grid-cols-2 gap-2">
                                    ${origin.attributeOptions.map(attr => `
                                        <button data-origin-choice="${originName}" data-choice="${attr}" 
                                            class="origin-choice-btn p-2 rounded text-xs transition-all ${
                                                c.originChoices[originName] === attr ? 
                                                'bg-green-500/20 border border-green-500 text-white' : 
                                                'bg-gray-800 border border-gray-600 text-gray-300 hover:border-gray-500'
                                            }">
                                            ${attr}
                                        </button>
                                    `).join('')}
                                </div>
                            </div>
                        `;
                    }
                    
                    if (origin?.proficiency?.type === 'choice' && origin?.proficiency?.options) {
                        if (originName === 'Military') {
                            const militaryWeapons = ['Common Weapons','Martial Arts','Sidearms','Longarms','Shotguns'];
                            const militaryArmor = ['Light Armor','Heavy Armor'];
                            content += `
                                <div class="mb-4">
                                    <label class="block text-sm font-medium text-gray-300 mb-2">
                                        Military Origin - Choose one weapon or armor proficiency:
                                    </label>
                                    <div class="mb-2">
                                        <div class="text-xs text-gray-400 mb-2">Weapon Proficiencies:</div>
                                        <div class="grid grid-cols-3 gap-2">
                                            ${militaryWeapons.map(weapon => `
                                                <button data-origin-choice="${originName}" data-choice="${weapon}" 
                                                    class="origin-choice-btn p-2 rounded text-xs transition-all ${
                                                        c.originChoices[originName] === weapon ? 
                                                        'bg-green-500/20 border border-green-500 text-white' : 
                                                        'bg-gray-800 border border-gray-600 text-gray-300 hover:border-gray-500'
                                                    }">
                                                    ${weapon}
                                                </button>
                                            `).join('')}
                                        </div>
                                    </div>
                                    <div>
                                        <div class="text-xs text-gray-400 mb-2">Armor Proficiencies:</div>
                                        <div class="grid grid-cols-2 gap-2">
                                            ${militaryArmor.map(armor => `
                                                <button data-origin-choice="${originName}" data-choice="${armor}" 
                                                    class="origin-choice-btn p-2 rounded text-xs transition-all ${
                                                        c.originChoices[originName] === armor ? 
                                                        'bg-green-500/20 border border-green-500 text-white' : 
                                                        'bg-gray-800 border border-gray-600 text-gray-300 hover:border-gray-500'
                                                    }">
                                                    ${armor}
                                                </button>
                                            `).join('')}
                                        </div>
                                    </div>
                                </div>
                            `;
                        } else if (originName === 'Enslaved') {
                            content += `
                                <div class="mb-4">
                                    <label class="block text-sm font-medium text-gray-300 mb-2">
                                        Enslaved Origin - Choose one tool proficiency:
                                    </label>
                                    <div class="grid grid-cols-3 gap-2">
                                        ${gameData.tools.map(tool => `
                                            <button data-origin-choice="${originName}" data-choice="${tool}" 
                                                class="origin-choice-btn p-2 rounded text-xs transition-all ${
                                                    c.originChoices[originName] === tool ? 
                                                    'bg-green-500/20 border border-green-500 text-white' : 
                                                    'bg-gray-800 border border-gray-600 text-gray-300 hover:border-gray-500'
                                                }">
                                                ${tool}
                                            </button>
                                        `).join('')}
                                    </div>
                                </div>
                            `;
                        }
                    }
                    
                    return content;
                }).join('')));
            }
            
            // Class selection
            sections.push(section('Select Class', `
                <div class="grid grid-cols-2 md:grid-cols-3 gap-3">
                    ${Object.entries(gameData.classes).map(([name, data]) => `
                        <button data-class="${name}" class="class-btn ${renderButton(null, c.class === name)}">
                            <div class="font-semibold">${name}</div>
                            <div class="text-xs mt-1 opacity-75">HD: d${data.hitDie}, DP: +${data.determinationBonus}</div>
                        </button>
                    `).join('')}
                </div>
            `));
            
            // Class info
            if (cd) {
                sections.push(section(`${c.class} Class Proficiencies & Bonuses`, `
                    <div class="grid grid-cols-1 md:grid-cols-2 gap-3">
                        <div class="bg-gray-800 rounded p-3">
                            <div class="text-xs font-semibold text-purple-400 mb-2">Combat</div>
                            <div class="space-y-1 text-xs text-gray-300">
                                <div>Hit Die: d${cd.hitDie}</div>
                                <div>HP/Level: ${cd.hpPerLevel} + Con mod</div>
                                <div>Determination: +${cd.determinationBonus}</div>
                            </div>
                        </div>
                        
                        <div class="bg-gray-800 rounded p-3">
                            <div class="text-xs font-semibold text-blue-400 mb-2">Saving Throws</div>
                            <div class="text-xs text-gray-300">${cd.proficiencies.saves.join(', ')}</div>
                        </div>
                        
                        <div class="bg-gray-800 rounded p-3">
                            <div class="text-xs font-semibold text-green-400 mb-2">Armor & Weapons</div>
                            <div class="space-y-1 text-xs text-gray-300">
                                <div><span class="text-gray-500">Armor:</span> ${cd.proficiencies.armor.join(', ')}</div>
                                <div><span class="text-gray-500">Weapons:</span> ${cd.proficiencies.weapons.join(', ')}</div>
                            </div>
                        </div>
                        
                        <div class="bg-gray-800 rounded p-3">
                            <div class="text-xs font-semibold text-yellow-400 mb-2">Tools</div>
                            <div class="text-xs text-gray-300">${cd.proficiencies.tools.join(', ')}</div>
                        </div>
                        
                        <div class="bg-gray-800 rounded p-3 md:col-span-2">
                            <div class="text-xs font-semibold text-cyan-400 mb-2">Skills</div>
                            <div class="text-xs text-gray-300">${cd.proficiencies.skills.join(', ')}</div>
                        </div>
                    </div>
                `));
            }
            
            // ENHANCED Level selection (1-20)
            if (c.level <= 5) {
                sections.push(section('Character Level (1-5: Class Training)', `
                    <div class="grid grid-cols-5 gap-2">
                        ${[1,2,3,4,5].map(lvl => `
                            <button data-level="${lvl}" class="level-btn px-3 py-2 rounded-lg border-2 transition-all text-sm ${
                                c.level === lvl ? 'border-green-500 bg-green-500/20 text-white' : 'border-gray-600 bg-gray-800 text-gray-300 hover:border-gray-500'
                            }">
                                <div>Level ${lvl}</div>
                                <div class="text-xs opacity-75">${lvl * 5} MP</div>
                            </button>
                        `).join('')}
                    </div>
                `));
            }
            
            // NEW: Level 6-20 with MP tracking
            if (c.level >= 5) {
                const currentLevel = calculateLevel();
                const nextLevelMP = mpForNextLevel();
                
                sections.push(section('Mission Points (MP) & Specialist Leveling', `
                    <div class="bg-gray-900/50 rounded-lg p-4 mb-4">
                        <div class="grid grid-cols-1 md:grid-cols-3 gap-4">
                            <div class="bg-gray-800 rounded p-3">
                                <div class="text-xs text-gray-400">Total MP Earned</div>
                                <div class="text-2xl font-bold text-blue-400">${c.mpEarned}</div>
                            </div>
                            <div class="bg-gray-800 rounded p-3">
                                <div class="text-xs text-gray-400">MP Spent on Feats</div>
                                <div class="text-2xl font-bold text-purple-400">${c.mpSpent}</div>
                            </div>
                            <div class="bg-gray-800 rounded p-3">
                                <div class="text-xs text-gray-400">MP Available</div>
                                <div class="text-2xl font-bold text-green-400">${c.mpEarned - c.mpSpent}</div>
                            </div>
                        </div>
                        
                        <div class="mt-4 p-3 bg-gray-800 rounded">
                            <div class="flex items-center justify-between mb-2">
                                <div class="text-sm text-gray-300">Current Level: <span class="text-xl font-bold text-white">${currentLevel}</span></div>
                                ${currentLevel < 20 ? `<div class="text-sm text-gray-400">Next Level: ${currentLevel + 1} (${nextLevelMP} MP total)</div>` : '<div class="text-sm text-yellow-400">MAX LEVEL REACHED!</div>'}
                            </div>
                            <div class="w-full bg-gray-700 rounded-full h-2">
                                <div class="bg-green-500 h-2 rounded-full transition-all" style="width: ${currentLevel < 20 ? (c.mpSpent % 10) * 10 : 100}%"></div>
                            </div>
                            <div class="text-xs text-gray-400 mt-1">${currentLevel < 20 ? `${c.mpSpent % 10} / 10 MP to next level` : 'Level 20 Complete'}</div>
                        </div>
                        
                        <div class="mt-4">
                            <label class="block text-sm font-medium text-gray-300 mb-2">Adjust Total MP Earned (typically 3-5 MP per mission)</label>
                            <div class="flex items-center gap-4">
                                <button id="mp-minus" class="px-4 py-2 bg-gray-700 rounded hover:bg-gray-600">-</button>
                                <input id="mp-earned" type="number" value="${c.mpEarned}" min="20" class="w-32 px-4 py-2 bg-gray-800 border border-gray-600 rounded-lg text-white text-center"/>
                                <button id="mp-plus" class="px-4 py-2 bg-gray-700 rounded hover:bg-gray-600">+</button>
                            </div>
                        </div>
                    </div>
                    
                    <button id="toggle-feat-purchase" class="w-full px-4 py-3 bg-purple-600 hover:bg-purple-700 rounded-lg font-semibold transition-all flex items-center justify-center gap-2">
                        ${icons.sparkles} ${state.showFeatPurchase ? 'Hide' : 'Show'} Feat Purchase Interface
                    </button>
                `));
            }

            // NEW: Feat Purchase Interface
            if (state.showFeatPurchase && c.level >= 5) {
                const availableMP = c.mpEarned - c.mpSpent;
                
                sections.push(section('Purchase Feats with Mission Points', `
                    <div class="space-y-4">
                        <div class="p-3 bg-gray-900/50 rounded-lg">
                            <div class="text-sm text-gray-300 mb-2">
                                <span class="text-green-400 font-bold">${availableMP} MP</span> available to spend
                            </div>
                            ${c.purchasedFeats.length > 0 ? `
                                <div class="text-xs text-gray-400">
                                    Purchased Feats: ${c.purchasedFeats.length}
                                </div>
                            ` : ''}
                        </div>
                        
                        <!-- Purchased Feats -->
                        ${c.purchasedFeats.length > 0 ? `
                            <div class="p-4 bg-gray-900/50 rounded-lg">
                                <h4 class="text-sm font-semibold text-green-400 mb-3">Your Purchased Feats</h4>
                                <div class="space-y-2">
                                    ${c.purchasedFeats.map(featName => {
                                        const baseName = featName.split(':')[0].trim();
                                        let feat = gameData.generalFeats.find(f => f.name === baseName);
                                        if (!feat) {
                                            Object.values(gameData.classFeatsByType).forEach(typeFeats => {
                                                const found = typeFeats.find(f => f.name === baseName);
                                                if (found) feat = found;
                                            });
                                        }
                                        if (!feat) feat = gameData.fieldHackFeats.find(f => f.name === baseName);
                                        
                                        return `
                                            <div class="flex items-center justify-between p-2 bg-gray-800 rounded">
                                                <div class="flex-1">
                                                    <div class="text-sm font-medium text-white">${featName}</div>
                                                    <div class="text-xs text-gray-400">${feat ? `Cost: ${feat.cost} MP` : ''}</div>
                                                </div>
                                                <button data-refund-feat="${featName}" class="refund-btn px-3 py-1 bg-red-600 hover:bg-red-700 rounded text-xs">
                                                    Refund
                                                </button>
                                            </div>
                                        `;
                                    }).join('')}
                                </div>
                            </div>
                        ` : ''}
                        
                        <!-- General Feats -->
                        <div>
                            <h4 class="text-sm font-semibold text-blue-400 mb-3">General Feats</h4>
                            <div class="grid grid-cols-1 md:grid-cols-2 gap-2 max-h-96 overflow-y-auto">
                                ${gameData.generalFeats.filter(f => f.category === 'General' || f.category === 'Combat').map(feat => {
                                    const canAfford = availableMP >= feat.cost;
                                    const meetsReqs = meetsFeatRequirements(feat);
                                    const alreadyPurchased = c.purchasedFeats.some(f => f.startsWith(feat.name));
                                    const canPurchase = canAfford && meetsReqs && !alreadyPurchased;
                                    
                                    return `
                                        <div class="p-3 rounded border ${
                                            alreadyPurchased ? 'border-green-500 bg-green-500/10' :
                                            !meetsReqs ? 'border-red-600/50 bg-red-900/10 opacity-60' :
                                            !canAfford ? 'border-gray-600/50 bg-gray-800 opacity-60' :
                                            'border-gray-600 bg-gray-800 hover:border-gray-500'
                                        }">
                                            <div class="flex items-start justify-between mb-2">
                                                <div class="flex-1">
                                                    <div class="text-sm font-semibold text-white">${feat.name}</div>
                                                    <div class="text-xs text-gray-400 mt-1">${feat.description}</div>
                                                    <div class="text-xs text-purple-400 mt-1">
                                                        Cost: ${feat.cost} MP | ${feat.requirements}
                                                    </div>
                                                </div>
                                                ${canPurchase && (feat.name.includes('Ability Score Increase') || feat.name.includes('Skill Proficiency') || feat.name.includes('Weapon Proficiency') || feat.name.includes('Tool Proficiency')) ? `
                                                    <button data-purchase-feat-choice="${feat.name}" class="purchase-feat-choice-btn ml-2 px-3 py-1 bg-blue-600 hover:bg-blue-700 rounded text-xs">
                                                        Choose & Buy
                                                    </button>
                                                ` : canPurchase ? `
                                                    <button data-purchase-feat="${feat.name}" class="purchase-feat-btn ml-2 px-3 py-1 bg-blue-600 hover:bg-blue-700 rounded text-xs">
                                                        Buy
                                                    </button>
                                                ` : alreadyPurchased ? `
                                                    <span class="ml-2 px-3 py-1 bg-green-600 rounded text-xs">Purchased</span>
                                                ` : !meetsReqs ? `
                                                    <span class="ml-2 px-3 py-1 bg-red-900 rounded text-xs">Locked</span>
                                                ` : `
                                                    <span class="ml-2 px-3 py-1 bg-gray-700 rounded text-xs">Not Enough MP</span>
                                                `}
                                            </div>
                                        </div>
                                    `;
                                }).join('')}
                            </div>
                        </div>
                        
                        <!-- Class-Specific Feats -->
                        ${c.class ? `
                            <div>
                                <h4 class="text-sm font-semibold text-purple-400 mb-3">${c.class} Class Feats</h4>
                                <div class="grid grid-cols-1 md:grid-cols-2 gap-2 max-h-96 overflow-y-auto">
                                    ${(() => {
                                        let classFeats = [];
                                        if (c.class === 'Scout') {
                                            classFeats = gameData.fieldHackFeats;
                                        } else {
                                            const featType = cd?.featChoices ? Object.values(cd.featChoices)[0]?.type : null;
                                            if (featType && gameData.classFeatsByType[featType]) {
                                                classFeats = gameData.classFeatsByType[featType];
                                            }
                                        }
                                        
                                        return classFeats.map(feat => {
                                            const canAfford = availableMP >= feat.cost;
                                            const meetsReqs = meetsFeatRequirements(feat);
                                            const alreadyPurchased = c.purchasedFeats.includes(feat.name);
                                            const canPurchase = canAfford && meetsReqs && !alreadyPurchased;
                                            
                                            return `
                                                <div class="p-3 rounded border ${
                                                    alreadyPurchased ? 'border-green-500 bg-green-500/10' :
                                                    !meetsReqs ? 'border-red-600/50 bg-red-900/10 opacity-60' :
                                                    !canAfford ? 'border-gray-600/50 bg-gray-800 opacity-60' :
                                                    'border-gray-600 bg-gray-800 hover:border-gray-500'
                                                }">
                                                    <div class="flex items-start justify-between mb-2">
                                                        <div class="flex-1">
                                                            <div class="text-sm font-semibold text-white">${feat.name}</div>
                                                            <div class="text-xs text-gray-400 mt-1">${feat.description}</div>
                                                            <div class="text-xs text-purple-400 mt-1">
                                                                Cost: ${feat.cost} MP${feat.requirements ? ` | ${feat.requirements}` : ''}
                                                            </div>
                                                        </div>
                                                        ${canPurchase ? `
                                                            <button data-purchase-feat="${feat.name}" class="purchase-feat-btn ml-2 px-3 py-1 bg-purple-600 hover:bg-purple-700 rounded text-xs">
                                                                Buy
                                                            </button>
                                                        ` : alreadyPurchased ? `
                                                            <span class="ml-2 px-3 py-1 bg-green-600 rounded text-xs">Purchased</span>
                                                        ` : !meetsReqs ? `
                                                            <span class="ml-2 px-3 py-1 bg-red-900 rounded text-xs">Locked</span>
                                                        ` : `
                                                            <span class="ml-2 px-3 py-1 bg-gray-700 rounded text-xs">Not Enough MP</span>
                                                        `}
                                                    </div>
                                                </div>
                                            `;
                                        }).join('');
                                    })()}
                                </div>
                            </div>
                        ` : ''}
                    </div>
                `));
            }
            
            // Class feats for levels 1-5 (keep original rendering)
            if (cd?.featChoices && c.level <= 5) {
                let req = 0, type = null;
                Object.entries(cd.featChoices).forEach(([l, ch]) => {
                    if (parseInt(l) <= c.level) {
                        req += ch.count;
                        type = ch.type;
                    }
                });
                
                if (req) {
                    const feats = type === 'fieldHack' ? gameData.fieldHackFeats : gameData.classFeatsByType[type];
                    sections.push(section('', `
                        <div id="toggle-feats" class="flex items-center justify-between cursor-pointer">
                            <h3 class="text-lg font-semibold text-gray-300 flex items-center gap-2">
                                ${icons.sparkles} Class Feat Selection (Levels 1-5)
                            </h3>
                            <span class="${state.showClassFeats ? 'rotate-180' : ''} transition-transform">${icons.chevronDown}</span>
                        </div>
                        ${state.showClassFeats ? `
                            <p class="text-sm text-gray-400 mb-4 mt-3">Select ${req} ${type === 'fieldHack' ? 'Field Hack' : type} feat${req > 1 ? 's' : ''}</p>
                            <div class="space-y-2">
                                ${feats.map(feat => {
                                    const sel = c.classFeats.includes(feat.name);
                                    const can = c.classFeats.length < req && !sel;
                                    return `
                                        <button data-feat="${feat.name}" class="feat-btn w-full text-left p-3 rounded border transition-all ${
                                            sel ? 'border-purple-500 bg-purple-500/20' :
                                            can ? 'border-gray-600 bg-gray-800 hover:border-gray-500' :
                                            'border-gray-700 bg-gray-900/50 opacity-50 cursor-not-allowed'
                                        }" ${!can && !sel ? 'disabled' : ''}>
                                            <div class="flex justify-between items-start">
                                                <div class="flex-1">
                                                    <div class="font-semibold text-sm text-white">${feat.name}</div>
                                                    <div class="text-xs text-gray-400 mt-1">${feat.description}</div>
                                                </div>
                                                ${sel ? '<div class="ml-2 text-purple-400">✓</div>' : ''}
                                            </div>
                                        </button>
                                    `;
                                }).join('')}
                            </div>
                            <div class="mt-4 text-sm text-gray-400">Selected: ${c.classFeats.length}/${req}</div>
                        ` : ''}
                    `));
                }
            }
            
            // Bonus Feats (Attack Specialist, Veteran, Ace)
            if (c.bonusFeats.length > 0) {
                sections.push(section('Bonus Feats (FREE - No MP Cost)', `
                    <div class="space-y-4">
                        ${c.bonusFeats.map(featName => {
                            let choice = '';
                            let choiceVar = '';
                            if (featName === 'Attack Specialist') {
                                choice = state.attackSpecialistChoice;
                                choiceVar = 'attackSpecialistChoice';
                            } else if (featName === 'Attack Veteran') {
                                choice = state.attackVeteranChoice;
                                choiceVar = 'attackVeteranChoice';
                            } else if (featName === 'Attack Ace') {
                                choice = state.attackAceChoice;
                                choiceVar = 'attackAceChoice';
                            }
                            
                            return `
                                <div class="p-4 bg-yellow-900/20 border-2 border-yellow-500 rounded-lg">
                                    <div class="flex items-center gap-2 mb-2">
                                        <span class="text-yellow-300">${icons.award}</span>
                                        <h4 class="text-sm font-semibold text-yellow-300">${featName}</h4>
                                    </div>
                                    <p class="text-xs text-gray-300 mb-3">
                                        Choose a weapon proficiency. When making attacks with that proficiency you roll ${
                                            featName === 'Attack Specialist' ? 'twice' :
                                            featName === 'Attack Veteran' ? 'triple' :
                                            'quadruple'
                                        } as many weapon damage dice for damage.
                                    </p>
                                    <select id="${choiceVar}" class="w-full px-4 py-2 bg-gray-800 border border-yellow-500 rounded-lg text-white">
                                        <option value="">Select weapon type...</option>
                                        ${gameData.weapons.map(w => `<option value="${w}" ${choice === w ? 'selected' : ''}>${w}</option>`).join('')}
                                    </select>
                                </div>
                            `;
                        }).join('')}
                    </div>
                `));
            }
            
            // Level 4 ASI (keep original)
            if (c.level >= 4) {
                sections.push(section('Level 4 - Ability Score Improvement', `
                    <p class="text-sm text-gray-400 mb-4">Choose either: +2 to one ability score, OR +1 to two different ability scores</p>
                    <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                        <div>
                            <label class="block text-sm font-medium text-gray-300 mb-2">Option 1: +2 to one ability</label>
                            <select id="asi-option1" class="w-full px-4 py-2 bg-gray-800 border border-gray-600 rounded-lg text-white">
                                <option value="">Select ability...</option>
                                ${['strength','dexterity','constitution','intelligence','wisdom','charisma'].map(a => 
                                    `<option value="${a}_2" ${c.abilityScoreImprovements?.option1 === `${a}_2` ? 'selected' : ''}>${a[0].toUpperCase() + a.slice(1)} +2</option>`
                                ).join('')}
                            </select>
                        </div>
                        <div>
                            <label class="block text-sm font-medium text-gray-300 mb-2">Option 2: +1 to two abilities</label>
                            <div class="space-y-2">
                                <select id="asi-option2a" class="w-full px-4 py-2 bg-gray-800 border border-gray-600 rounded-lg text-white">
                                    <option value="">First ability +1...</option>
                                    ${['strength','dexterity','constitution','intelligence','wisdom','charisma'].map(a => 
                                        `<option value="${a}" ${c.abilityScoreImprovements?.option2a === a ? 'selected' : ''}>${a[0].toUpperCase() + a.slice(1)} +1</option>`
                                    ).join('')}
                                </select>
                                <select id="asi-option2b" class="w-full px-4 py-2 bg-gray-800 border border-gray-600 rounded-lg text-white">
                                    <option value="">Second ability +1...</option>
                                    ${['strength','dexterity','constitution','intelligence','wisdom','charisma'].map(a => 
                                        `<option value="${a}" ${c.abilityScoreImprovements?.option2b === a ? 'selected' : ''}>${a[0].toUpperCase() + a.slice(1)} +1</option>`
                                    ).join('')}
                                </select>
                            </div>
                        </div>
                    </div>
                `));
            }
            
            // Ability scores (keep original)
            sections.push(section('Ability Scores (Point Buy) - Base Values', `
                <div class="flex justify-between mb-4">
                    <span class="${ps > 27 ? 'text-red-300' : 'text-green-300'} text-sm">Points: ${ps}/27</span>
                </div>
                <div class="grid grid-cols-2 md:grid-cols-3 gap-4">
                    ${Object.entries(c.abilityScores).map(([ability, score]) => {
                        const {racial, origin, asi} = getAbilityBonuses(ability);
                        const bonus = racial + origin + asi;
                        const final = score + bonus;
                        return `
                            <div class="bg-gray-800 rounded-lg p-3">
                                <div class="flex justify-between mb-2">
                                    <span class="text-xs text-gray-400 capitalize">${ability}</span>
                                    <span class="text-xs text-blue-300">Final: ${final} (${getModifier(final) >= 0 ? '+' : ''}${getModifier(final)})</span>
                                </div>
                                <div class="flex items-center gap-2">
                                    <button data-ability="${ability}" data-action="decrease" class="ability-btn w-8 h-8 bg-gray-700 rounded ${score <= 8 ? 'opacity-50' : 'hover:bg-gray-600'}" ${score <= 8 ? 'disabled' : ''}>-</button>
                                    <div class="flex-1 text-center">
                                        <div class="text-lg font-bold text-white">${score}</div>
                                        ${bonus ? `<div class="text-xs text-green-400">+${bonus}</div>` : ''}
                                    </div>
                                    <button data-ability="${ability}" data-action="increase" class="ability-btn w-8 h-8 bg-gray-700 rounded ${score >= 15 || ps >= 27 ? 'opacity-50' : 'hover:bg-gray-600'}" ${score >= 15 || ps >= 27 ? 'disabled' : ''}>+</button>
                                </div>
                            </div>
                        `;
                    }).join('')}
                </div>
            `));
            
            // Combat stats (keep original)
            sections.push(section('Combat Statistics', `
                <div class="grid grid-cols-2 md:grid-cols-3 gap-4">
                    ${[
                        ['Hit Points', c.hp, icons.heart, 'text-red-400'],
                        ['Armor Class', c.armorClass, icons.shield, 'text-blue-400'],
                        ['Initiative', `${c.initiative >= 0 ? '+' : ''}${c.initiative}`, icons.zap, 'text-yellow-400'],
                        ['Determination', c.determinationPoints, icons.brain, 'text-purple-400'],
                        ['Speed', `${c.speed}m`, icons.activity, 'text-green-400'],
                        ['Moxie', `${c.moxie >= 0 ? '+' : ''}${c.moxie}`, icons.user, 'text-cyan-400']
                    ].map(([label, value, icon, color]) => `
                        <div class="bg-gray-800 rounded-lg p-3">
                            <div class="flex items-center gap-2 ${color} mb-1">
                                <span class="icon icon-md">${icon}</span>
                                <span class="text-xs">${label}</span>
                            </div>
                            <div class="text-2xl font-bold text-white">${value || 0}</div>
                        </div>
                    `).join('')}
                </div>
                <div class="mt-4 p-3 bg-gray-800 rounded-lg">
                    <div class="flex items-center justify-between">
                        <span class="text-sm text-gray-400">Proficiency Bonus</span>
                        <span class="text-lg font-bold text-white">+${getProficiencyBonus(c.level)}</span>
                    </div>
                </div>
            `));
            
            // Duplicate proficiencies (keep original)
            if (totalReplacements > 0) {
                sections.push(section('', `
                    <div class="flex items-center gap-2 mb-4">
                        <span class="text-yellow-300">${icons.sparkles}</span>
                        <h3 class="text-lg font-semibold text-yellow-300">Duplicate Skill Proficiencies</h3>
                    </div>
                    
                    <div class="p-3 bg-yellow-900/20 border border-yellow-600/50 rounded-lg mb-4">
                        <p class="text-sm text-yellow-200">
                            You have duplicate skill proficiencies from multiple sources:
                        </p>
                        <ul class="mt-2 text-xs text-yellow-100">
                            ${duplicateSkills.map(({skill, duplicates}) => 
                                `<li>• <strong>${skill}</strong> appears ${duplicates + 1} times (${duplicates} duplicate${duplicates > 1 ? 's' : ''})</li>`
                            ).join('')}
                        </ul>
                        <p class="text-sm text-yellow-200 mt-3">
                            <strong>Select ${totalReplacements} skill${totalReplacements > 1 ? 's' : ''} to replace the duplicate${totalReplacements > 1 ? 's' : ''}:</strong>
                        </p>
                        <p class="text-xs text-yellow-100 mt-1">
                            Selected: ${c.duplicateProficiencyChoices.filter(s => s).length} / ${totalReplacements}
                        </p>
                    </div>
                    
                    <div class="p-3 bg-gray-800 rounded-lg">
                        <div class="grid grid-cols-3 md:grid-cols-4 lg:grid-cols-6 gap-2">
                            ${gameData.skills.map(skill => {
                                const selectedIndex = c.duplicateProficiencyChoices.indexOf(skill);
                                const isSelected = selectedIndex !== -1;
                                const finalProfs = getFinalSkillProficiencies();
                                const alreadyProficient = finalProfs.includes(skill) && !isSelected;
                                const disabled = alreadyProficient;
                                const canSelect = !disabled && !isSelected && c.duplicateProficiencyChoices.filter(s => s).length < totalReplacements;
                                
                                return `
                                    <button 
                                        data-duplicate-skill="${skill}" 
                                        class="duplicate-btn p-2 rounded text-xs transition-all ${
                                            isSelected ? 'bg-green-500/20 border-2 border-green-500 text-white font-semibold' :
                                            disabled ? 'bg-gray-900 border border-gray-700 text-gray-600 opacity-50 cursor-not-allowed' :
                                            canSelect ? 'bg-gray-800 border border-gray-600 text-gray-300 hover:border-gray-500' :
                                            'bg-gray-800 border border-gray-600 text-gray-400 opacity-70'
                                        }" 
                                        ${disabled ? 'disabled' : ''}
                                    >
                                        ${skill}
                                    </button>
                                `;
                            }).join('')}
                        </div>
                    </div>
                    
                    <div class="mt-4 p-3 bg-gray-800/50 rounded">
                        <div class="text-xs text-gray-300">
                            <strong>Final Skill Proficiencies:</strong>
                            <div class="mt-1 flex flex-wrap gap-1">
                                ${getFinalSkillProficiencies().map(skill => `
                                    <span class="px-2 py-1 bg-gray-700 rounded text-xs">${skill}</span>
                                `).join('')}
                            </div>
                        </div>
                    </div>
                `, true));
            }
            
            // Export button
            sections.push(`
                <div class="flex justify-end">
                    <button id="export-btn" class="px-6 py-3 bg-gradient-to-r from-blue-600 to-purple-600 text-white font-semibold rounded-lg hover:from-blue-700 hover:to-purple-700 flex items-center gap-2">
                        ${icons.download} Export Character Sheet
                    </button>
                </div>
            `);
            
            return sections.join('');
        };

        // Event listeners
        const attachEventListeners = () => {
            const on = (sel, evt, fn) => document.querySelectorAll(sel).forEach(el => el.addEventListener(evt, fn));
            
            document.getElementById('character-name')?.addEventListener('input', e => state.character.name = e.target.value);
            
            on('.race-btn', 'click', e => {
                state.character.race = e.currentTarget.dataset.race;
                state.character.subrace = '';
                state.character.abilityChoice = '';
                state.character.raceChoices = {};
                state.character.duplicateProficiencyChoices = [];
                render();
            });
            
            on('.subrace-btn', 'click', e => {
                state.character.subrace = e.currentTarget.dataset.subrace;
                state.character.abilityChoice = '';
                state.character.raceChoices = {};
                state.character.duplicateProficiencyChoices = [];
                render();
            });
            
            on('.ability-choice-btn', 'click', e => {
                state.character.abilityChoice = e.currentTarget.dataset.abilityChoice;
                render();
            });
            
            on('.race-weapon-btn', 'click', e => {
                const w = e.currentTarget.dataset.raceWeapon;
                const weapons = state.character.raceChoices.weapons || [];
                const max = getRaceData()?.proficiencies?.weapons?.count || 1;
                
                if (weapons.includes(w)) {
                    state.character.raceChoices.weapons = weapons.filter(x => x !== w);
                } else if (weapons.length < max) {
                    state.character.raceChoices.weapons = [...weapons, w];
                }
                render();
            });
            
            on('.race-skill-btn', 'click', e => {
                const s = e.currentTarget.dataset.raceSkill;
                const skills = state.character.raceChoices.skills || [];
                const max = getRaceData()?.proficiencies?.skills?.count || 1;
                
                if (skills.includes(s)) {
                    state.character.raceChoices.skills = skills.filter(x => x !== s);
                } else if (skills.length < max) {
                    state.character.raceChoices.skills = [...skills, s];
                }
                state.character.duplicateProficiencyChoices = [];
                render();
            });
            
            on('.additional-skill-btn', 'click', e => {
                const s = e.currentTarget.dataset.additionalSkill;
                const skills = state.character.raceChoices.additionalSkills || [];
                const max = getRaceData()?.proficiencies?.skills?.additionalChoice?.count || 1;
                
                if (skills.includes(s)) {
                    state.character.raceChoices.additionalSkills = skills.filter(x => x !== s);
                } else if (skills.length < max) {
                    state.character.raceChoices.additionalSkills = [...skills, s];
                }
                state.character.duplicateProficiencyChoices = [];
                render();
            });
            
            on('.origin-choice-btn', 'click', e => {
                const originName = e.currentTarget.dataset.originChoice;
                const choice = e.currentTarget.dataset.choice;
                state.character.originChoices[originName] = choice;
                render();
            });
            
            on('.origin-btn', 'click', e => {
                const name = e.currentTarget.dataset.origin;
                const type = e.currentTarget.dataset.originType;
                const c = state.character;
                
                if (name === 'Former Host' && c.race === 'Jaffa') return;
                
                if (type === 'racial') {
                    const origin = gameData.origins.racial[c.race]?.find(o => o.name === name);
                    if (origin && !isRacialOriginAvailable(origin)) return;
                }
                
                const scrollPositions = {};
                document.querySelectorAll('.max-h-96.overflow-y-auto').forEach((el, index) => {
                    scrollPositions[index] = el.scrollTop;
                });
                
                if (c.origins.includes(name)) {
                    c.origins = c.origins.filter(o => o !== name);
                    delete c.originChoices[name];
                } else if (c.origins.length < 2) {
                    const hasType = type === 'racial' ? 
                        c.origins.some(o => gameData.origins.racial[c.race]?.find(x => x.name === o)) :
                        c.origins.some(o => gameData.origins[type].find(x => x.name === o));
                    if (!hasType) c.origins.push(name);
                }
                state.character.duplicateProficiencyChoices = [];
                
                document.getElementById('app').style.opacity = '0.99';
                
                render();
                
                requestAnimationFrame(() => {
                    document.querySelectorAll('.max-h-96.overflow-y-auto').forEach((el, index) => {
                        if (scrollPositions[index] !== undefined) {
                            el.scrollTop = scrollPositions[index];
                        }
                    });
                    document.getElementById('app').style.opacity = '1';
                });
            });
            
            on('.class-btn', 'click', e => {
                state.character.class = e.currentTarget.dataset.class;
                state.character.classFeats = [];
                state.character.duplicateProficiencyChoices = [];
                render();
            });
            
            on('.level-btn', 'click', e => {
                state.character.level = parseInt(e.currentTarget.dataset.level);
                state.character.mpEarned = state.character.level * 5;
                render();
            });
            
            // MP adjustment
            document.getElementById('mp-earned')?.addEventListener('change', e => {
                state.character.mpEarned = Math.max(20, parseInt(e.target.value) || 20);
                render();
            });
            
            document.getElementById('mp-plus')?.addEventListener('click', () => {
                state.character.mpEarned += 1;
                render();
            });
            
            document.getElementById('mp-minus')?.addEventListener('click', () => {
                state.character.mpEarned = Math.max(20, state.character.mpEarned - 1);
                render();
            });
            
            // Feat purchase
            document.getElementById('toggle-feat-purchase')?.addEventListener('click', () => {
                state.showFeatPurchase = !state.showFeatPurchase;
                render();
            });
            
            on('.purchase-feat-btn', 'click', e => {
                const featName = e.currentTarget.dataset.purchaseFeat;
                let feat = gameData.generalFeats.find(f => f.name === featName);
                if (!feat) {
                    Object.values(gameData.classFeatsByType).forEach(typeFeats => {
                        const found = typeFeats.find(f => f.name === featName);
                        if (found) feat = found;
                    });
                }
                if (!feat) feat = gameData.fieldHackFeats.find(f => f.name === featName);
                
                if (feat && purchaseFeat(feat)) {
                    render();
                }
            });
            
            on('.purchase-feat-choice-btn', 'click', e => {
                const featName = e.currentTarget.dataset.purchaseFeatChoice;
                let choice = prompt(`Enter your choice for ${featName}:`);
                if (choice) {
                    let feat = gameData.generalFeats.find(f => f.name === featName);
                    if (feat && purchaseFeat(feat, choice)) {
                        render();
                    }
                }
            });
            
            on('.refund-btn', 'click', e => {
                const featName = e.currentTarget.dataset.refundFeat;
                if (refundFeat(featName)) {
                    render();
                }
            });
            
            on('.feat-btn', 'click', e => {
                const feat = e.currentTarget.dataset.feat;
                const c = state.character;
                const cd = getClassData();
                let max = 0;
                
                Object.entries(cd.featChoices || {}).forEach(([l, ch]) => {
                    if (parseInt(l) <= c.level) max += ch.count;
                });
                
                if (c.classFeats.includes(feat)) {
                    c.classFeats = c.classFeats.filter(f => f !== feat);
                } else if (c.classFeats.length < max) {
                    c.classFeats.push(feat);
                }
                render();
            });
            
            on('.duplicate-btn', 'click', e => {
                if (e.currentTarget.disabled) return;
                
                const skill = e.currentTarget.dataset.duplicateSkill;
                const { totalReplacements } = getDuplicateAnalysis();
                
                if (!Array.isArray(state.character.duplicateProficiencyChoices)) {
                    state.character.duplicateProficiencyChoices = new Array(totalReplacements).fill('');
                }
                
                const existingIndex = state.character.duplicateProficiencyChoices.indexOf(skill);
                
                if (existingIndex !== -1) {
                    state.character.duplicateProficiencyChoices[existingIndex] = '';
                } else {
                    const emptyIndex = state.character.duplicateProficiencyChoices.indexOf('');
                    if (emptyIndex !== -1) {
                        state.character.duplicateProficiencyChoices[emptyIndex] = skill;
                    }
                }
                
                render();
            });
            
            on('.ability-btn', 'click', e => {
                const ability = e.currentTarget.dataset.ability;
                const action = e.currentTarget.dataset.action;
                const c = state.character;
                const current = c.abilityScores[ability];
                
                if (action === 'increase' && current < 15) {
                    const newCost = getPointsSpent() + (pointBuyCost[current + 1] - pointBuyCost[current]);
                    if (newCost <= 27) c.abilityScores[ability]++;
                } else if (action === 'decrease' && current > 8) {
                    c.abilityScores[ability]--;
                }
                render();
            });
            
            document.getElementById('toggle-feats')?.addEventListener('click', () => {
                state.showClassFeats = !state.showClassFeats;
                render();
            });
            
            // Bonus feat choices
            ['attackSpecialistChoice', 'attackVeteranChoice', 'attackAceChoice'].forEach(choiceVar => {
                document.getElementById(choiceVar)?.addEventListener('change', e => {
                    state[choiceVar] = e.target.value;
                });
            });
            
            document.getElementById('asi-option1')?.addEventListener('change', e => {
                if (e.target.value) {
                    state.character.abilityScoreImprovements = {option1: e.target.value};
                    render();
                }
            });
            
            document.getElementById('asi-option2a')?.addEventListener('change', e => {
                if (e.target.value) {
                    state.character.abilityScoreImprovements = {
                        option2a: e.target.value,
                        option2b: state.character.abilityScoreImprovements?.option2b || ''
                    };
                    render();
                }
            });
            
            document.getElementById('asi-option2b')?.addEventListener('change', e => {
                if (e.target.value) {
                    state.character.abilityScoreImprovements = {
                        option2a: state.character.abilityScoreImprovements?.option2a || '',
                        option2b: e.target.value
                    };
                    render();
                }
            });
            
            document.getElementById('export-btn')?.addEventListener('click', exportCharacter);
        };

        // Initialize
        render();
    </script>
</body>
</html>
