<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Stargate RPG Character Builder</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        .transition-all { transition: all 0.3s ease; }
        .rotate-180 { transform: rotate(180deg); }
        ::-webkit-scrollbar { width: 8px; height: 8px; }
        ::-webkit-scrollbar-track { background: rgba(0, 0, 0, 0.2); border-radius: 4px; }
        ::-webkit-scrollbar-thumb { background: rgba(147, 51, 234, 0.5); border-radius: 4px; }
        ::-webkit-scrollbar-thumb:hover { background: rgba(147, 51, 234, 0.7); }
        .icon { display: inline-block; width: 1em; height: 1em; vertical-align: middle; fill: currentColor; }
        .icon-sm { width: 0.75rem; height: 0.75rem; }
        .icon-md { width: 1rem; height: 1rem; }
        .icon-lg { width: 1.25rem; height: 1.25rem; }
    </style>
</head>
<body class="min-h-screen bg-gradient-to-br from-gray-900 via-blue-900 to-purple-900 p-4">
    <div id="app"></div>
    <script>
        // Icons library
        const icons = {
            chevronDown: '<svg class="icon" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="m6 9 6 6 6-6"/></svg>',
            user: '<svg class="icon" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M19 21v-2a4 4 0 0 0-4-4H9a4 4 0 0 0-4 4v2"/><circle cx="12" cy="7" r="4"/></svg>',
            shield: '<svg class="icon" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M12 22s8-4 8-10V5l-8-3-8 3v7c0 6 8 10 8 10"/></svg>',
            heart: '<svg class="icon" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M19 14c1.49-1.46 3-3.21 3-5.5A5.5 5.5 0 0 0 16.5 3c-1.76 0-3 .5-4.5 2-1.5-1.5-2.74-2-4.5-2A5.5 5.5 0 0 0 2 8.5c0 2.3 1.5 4.05 3 5.5l7 7Z"/></svg>',
            zap: '<svg class="icon" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M13 2 3 14h9l-1 8 10-12h-9l1-8z"/></svg>',
            brain: '<svg class="icon" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M9.5 2A2.5 2.5 0 0 1 12 4.5v15a2.5 2.5 0 0 1-4.96.44 2.5 2.5 0 0 1-2.96-3.08 3 3 0 0 1-.34-5.58 2.5 2.5 0 0 1 1.32-4.24 2.5 2.5 0 0 1 1.44-5A2.5 2.5 0 0 1 9.5 2Z"/><path d="M14.5 2A2.5 2.5 0 0 0 12 4.5v15a2.5 2.5 0 0 0 4.96.44 2.5 2.5 0 0 0 2.96-3.08 3 3 0 0 0 .34-5.58 2.5 2.5 0 0 0-1.32-4.24 2.5 2.5 0 0 0-1.44-5A2.5 2.5 0 0 0 14.5 2Z"/></svg>',
            target: '<svg class="icon" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><circle cx="12" cy="12" r="10"/><circle cx="12" cy="12" r="6"/><circle cx="12" cy="12" r="2"/></svg>',
            activity: '<svg class="icon" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M22 12h-4l-3 9L9 3l-3 9H2"/></svg>',
            download: '<svg class="icon" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4"/><polyline points="7 10 12 15 17 10"/><line x1="12" x2="12" y1="15" y2="3"/></svg>',
            alertCircle: '<svg class="icon icon-sm" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><circle cx="12" cy="12" r="10"/><line x1="12" x2="12" y1="8" y2="12"/><line x1="12" x2="12.01" y1="16" y2="16"/></svg>',
            sparkles: '<svg class="icon" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="m12 3-1.912 5.813a2 2 0 0 1-1.275 1.275L3 12l5.813 1.912a2 2 0 0 1 1.275 1.275L12 21l1.912-5.813a2 2 0 0 1 1.275-1.275L21 12l-5.813-1.912a2 2 0 0 1-1.275-1.275L12 3Z"/><path d="M5 3v4"/><path d="M19 17v4"/><path d="M3 5h4"/><path d="M17 19h4"/></svg>',
            award: '<svg class="icon" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><circle cx="12" cy="8" r="6"/><path d="M15.477 12.89 17 22l-5-3-5 3 1.523-9.11"/></svg>',
            bookOpen: '<svg class="icon" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M2 3h6a4 4 0 0 1 4 4v14a3 3 0 0 0-3-3H2z"/><path d="M22 3h-6a4 4 0 0 0-4 4v14a3 3 0 0 1 3-3h7z"/></svg>',
            refresh: '<svg class="icon" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M21 2v6h-6"/><path d="M3 12a9 9 0 0 1 15-6.7L21 8"/><path d="M3 22v-6h6"/><path d="M21 12a9 9 0 0 1-15 6.7L3 16"/></svg>',
            lock: '<svg class="icon" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><rect width="18" height="11" x="3" y="11" rx="2" ry="2"/><path d="M7 11V7a5 5 0 0 1 10 0v4"/></svg>'
        };

        // Game data (condensed structure)
        const gameData = {
            fieldHackFeats: [
                {n:'Camouflage',r:'Stealth',d:'Create camouflage granting advantage on Stealth in natural terrain'},
                {n:'Camp Security',r:'Perception',d:'Set up camp alarms, advantage on Perception during rest'},
                {n:'Foraging',r:'Survival',d:'Find food/water for 1d4+Wis mod people per day'},
                {n:'Hide Tracks',r:'Stealth',d:'Increase DC to track your party by +5'},
                {n:'Ranger Tricks',r:'Nature',d:'Leave false trails, create natural traps (1d6 damage)'},
                {n:'Ration Optimization',r:'Survival',d:'Make rations last 50% longer'},
                {n:'Rope Tricks',r:'Athletics',d:'Advantage on Athletics checks involving ropes and climbing'},
                {n:'Tracking',r:'Survival',d:'Track creatures, determine numbers and time passed'},
                {n:'Xenosurvival',r:'Science',d:'Identify alien flora/fauna as safe or dangerous'}
            ].map(f => ({name:f.n, requirements:f.r, description:f.d})),
            
            classFeatsByType: {
                inspiration: ['Calm and Collected|During long rest, choose Int/Wis/Cha. Inspired characters gain advantage on chosen save','Clear Focus|During long rest, choose a skill. Inspired characters gain advantage on that skill','Coordinated Fire|After you hit, bonus action to grant inspired ally advantage on next attack vs same target','Defensive Motivation|Inspired characters gain +1 AC','Enduring Inspirations|At combat start, inspired characters gain tension die worth of Inspire HP','Grim Resolve|When inspired character loses last Inspire HP, gain resistance to physical damage until next turn','Hard Days Night|Inspired characters reduce exhaustion from environment/exertion by 1 level (min 1)','Quippy Comebacks|Once per Diplomatic Function, inspired characters halve DP loss from failed checks','Skillful Explanations|Once per short rest, allow inspired character to re-roll failed skill check you are proficient in'].map(s => {const [n,d] = s.split('|'); return {name:n, description:d}}),
                modification: ['Armorer|During long rest, grant one armor +1 AC until next rest','Chem Thrower|During long rest, grant line/cone weapon +5m range','Comms Tech|Team radio range 20km (not 5km), balloon duration 15d6 hours','Grenadier|Your grenades deal +1d6 damage','Longarm Calibrations|During long rest, grant longarm +1d4 to attack at long range','Minefield Expert|Bury explosives as mines, advantage to spot mines','Montage|Reduce R&D successes needed by half proficiency bonus','Percussive Maintenance|Machines you grant temp HP to heal +1d6 additional temp HP','Sidearm Calibrations|During long rest, grant sidearm +1 to attack and damage'].map(s => {const [n,d] = s.split('|'); return {name:n, description:d}}),
                procedure: ['Biohazard Disposal|Team proficient in Constitution saves vs disease/toxins/viruses','Controlled Stimulants|Use Med Kit to heal 1d4 exhaustion (once per rest per character)','Crash Training|Use Med Kit to revive dead character (DC 25 Medicine, once per round)','Embolism|Melee attack deals 1d3 Constitution damage','Improvised Medicine|Heal without Med Kit but target not proficient with','Pharmaceuticals|Heal 1d4 Int/Wis/Cha damage during short rest','Sedatives|Melee attack causes unconsciousness (Con save or 1d6 fatigue levels)','Urgent Care|Replace all healing dice rolled with tension dice','Vital Organ Trauma|Add Wisdom modifier to critical hit damage'].map(s => {const [n,d] = s.split('|'); return {name:n, description:d}}),
                discovery: ['A Moments Thought|During rest, spend Eureka to re-roll failed Int/Wis check','Archaeologist|Action to spend Eureka and find secret rooms, advantage on finding hidden architecture','Astronomer|Bonus action to reduce Stargate activation by 1 round per Eureka','Biologist|Action to spend Eureka points to heal 1d6 per point','Chemist|Research Kit ranged attack deals 1d6 acid per Eureka (increases with level)','Geologist|Reaction to spend Eureka and negate natural cover','Hyper-Focus|Spend Eureka to add tension die to Int/Wis check','Physicist|Spend Eureka to increase weapon range by 50%','Social Sciences|Gain 1 Eureka when losing Determination Points'].map(s => {const [n,d] = s.split('|'); return {name:n, description:d}}),
                tactic: ['Ambush|Team gains advantage on first melee attack after rest','Assault Coordination|Next ranged attack by teammate after you hit deals +1d6','Coordinated Response|Team can use your initiative result','Defensive Posture|Allies within 2m gain +2 AC','Distracting Attacks|Target has disadvantage vs chosen ally not within 2m','Hit and Run|Bonus action to let ally Disengage','Overwatchers|90° overwatch field (not 45°), make 2 attacks','Response Shot|Once per encounter, reaction attack when enemy attacks ally','Rush|Bonus action to let ally Dash'].map(s => {const [n,d] = s.split('|'); return {name:n, description:d}})
            },

            races: {
                'Human': {
                    'Standard Human': {hp:10,ab:{t:'choice',o:['intelligence','charisma'],v:2},a:['Recovery: Regain +TD HP on short rest','Galactic Seeds: Advantage on Persuasion/Deception during first contact'],p:{skills:{t:'choice',c:2}}},
                    'Abydonian': {hp:10,ab:{t:'choice',o:['constitution','charisma'],v:2},a:['Recovery: Regain +TD HP on short rest','Free from Ra: Advantage on saves against Goa\'uld technology'],p:{skills:{t:'choice',c:1},weapons:{t:'choice',c:1}}},
                    'Tollan': {hp:8,ab:{t:'choice',o:['intelligence','wisdom'],v:2},a:['Phase-Shift: Add phase device to base kit','Advanced Technology: +TD to Engineering checks for Tech Level 4+'],p:{skills:{t:'mixed',f:['Science'],ac:{c:1}}}}
                },
                'Jaffa': {
                    'Jaffa (With Symbiote)': {hp:12,ab:{t:'choice',o:['strength','dexterity'],v:2},a:['Symbiote: Advantage on physical saves (once per Proficiency bonus per long rest)','Kelno\'reem: Heal damage as if HD rolled max during long rest','Proficiency with Jaffa weapons'],p:{weapons:{t:'fixed',l:['Jaffa Weapons']},skills:{t:'choice',c:1}}},
                    'Free Jaffa (Tretonin)': {hp:10,ab:{t:'choice',o:['dexterity','wisdom'],v:2},a:['Resistance Training: Half proficiency bonus to attack rolls with non-proficient weapons','Tretonin Prescription: Advantage on saves vs disease, suffer 1d4 Con damage daily without drug','Proficiency with Jaffa weapons'],p:{weapons:{t:'fixed',l:['Jaffa Weapons']},skills:{t:'choice',c:1}}}
                },
                'Aturen': {
                    'Standard Aturen': {hp:10,ab:{t:'choice',o:['wisdom','charisma'],v:2},a:['Natural Resilience: Advantage on saves against disease or poison','Naturalist: Add +TD to Science checks involving ecosystems and creatures'],p:{skills:{t:'choice',c:2}}},
                    'Noxian Pacifist': {hp:8,ab:{t:'choice',o:['constitution','charisma'],v:2},a:['Pacifist: Cannot willingly harm living creatures or take attack actions','Invisibility: Become invisible for 1 minute as action (Prof bonus times per long rest)','Natural Resilience: Advantage on saves against disease or poison','Naturalist: Add +TD to Science checks involving ecosystems and creatures'],p:{skills:{t:'choice',c:2}}}
                },
                'Tok\'ra': {
                    'Tok\'ra (Egeria\'s Line)': {hp:10,ab:{t:'choice',o:['intelligence','wisdom'],v:2},a:['Synergistic Symbiote: Advantage on mental saves (once per Wis mod per long rest)','Regeneration: Heal to full HP during long rest','Genetic Memory: Access to centuries of knowledge','Naquadah in blood: Can use Goa\'uld/Tok\'ra technology'],p:{skills:{t:'choice',c:2}}},
                    'Pangaran Tok\'ra': {hp:10,ab:{t:'choice',o:['charisma','wisdom'],v:2},a:['Shrewd Diplomats: Use Int or Wis instead of Cha for Persuasion','Regeneration: Heal to full HP during long rest','No genetic memory (created with flaw)'],p:{skills:{t:'choice',c:2}}}
                },
                'Unas': {
                    'Standard Unas': {hp:14,ab:{t:'choice',o:['strength','constitution'],v:2},a:['Impressive Resilience: Gain damage resistance for TD rounds (once per long rest)','Robust: +4 Str for lifting/carrying, advantage on related Str checks','Claws: Natural weapons deal 1d6 damage'],p:{skills:{t:'choice',c:2}}},
                    'Unchained Unas': {hp:14,ab:{t:'choice',o:['strength','constitution'],v:2},a:['Impressive Resilience: Gain damage resistance for TD rounds (once per long rest)','Underestimated: Advantage on checks to conceal truth from non-Unas','Claws: Natural weapons deal 1d6 damage'],p:{skills:{t:'choice',c:2}}}
                }
            },

            classes: {
                'Diplomat': {hd:8,hpl:5,db:2,p:{a:['Light Armor'],w:['Common Weapons','Sidearms'],t:['Research Kit'],sv:['Wisdom','Charisma'],sk:['Culture','Deception','Insight','Persuasion']},ab:{1:['Inspire (1d6 temp HP to team during long rest)','Choose Inspiration feat'],2:['Pep Talk (restore 1d4 DP to team once per mission)','Word In An Ear (inspire single target)'],3:['Force of Will (use Inspire on short/long rest)','Choose 2nd Inspiration feat'],4:['Diplomatic Expertise (double proficiency)','Ability Score Improvement'],5:['Strong Personality (Inspire die to 1d8)','Choose 3rd Inspiration feat']},fc:{1:{t:'inspiration',c:1},3:{t:'inspiration',c:1},5:{t:'inspiration',c:1}}},
                'Engineer': {hd:8,hpl:5,db:2,p:{a:['Light Armor'],w:['Common Weapons','Sidearms','Longarms'],t:['Engineering Kit','Explosives','Fabrication Kit'],sv:['Dexterity','Intelligence'],sk:['Engineering','Pilot','Perception']},ab:{1:['Jury Rig (2d8 repair, action repair)','Choose Modification feat'],2:['Hold Together (resistance with cover)','Whack-It (1d6 temp HP bonus action)'],3:['Tune-Up (+Int to repairs)','Choose 2nd Modification feat'],4:['Broad Spectrum Scanners (Int for Perception)','Ability Score Improvement'],5:['Xeno-Tech Specialist (reduce R&D time)','Choose 3rd Modification feat']},fc:{1:{t:'modification',c:1},3:{t:'modification',c:1},5:{t:'modification',c:1}}},
                'Medic': {hd:8,hpl:5,db:2,p:{a:['Light Armor'],w:['Common Weapons','Sidearms','Shotguns'],t:['Med Kit','Outbreak Kit'],sv:['Dexterity','Wisdom'],sk:['Athletics','Insight','Medicine','Science']},ab:{1:['First Aid (add proficiency to healing, heal as action)','Choose Procedure feat'],2:['Triage (learn target HP with Medicine check)','Unnoticed Field Medic (disadvantage on attacks after healing)'],3:['Man Down (dying allies need fewer death saves)','Choose 2nd Procedure feat'],4:['Physician Heal Thyself (use med kit on self as bonus action)','Ability Score Improvement'],5:['First Response (add WIS modifier to healing)','Choose 3rd Procedure feat']},fc:{1:{t:'procedure',c:1},3:{t:'procedure',c:1},5:{t:'procedure',c:1}}},
                'Scientist': {hd:8,hpl:5,db:2,p:{a:['Light Armor'],w:['Common Weapons','Sidearms'],t:['Explosives','Research Kit','Translator'],sv:['Intelligence','Wisdom'],sk:['Culture','Investigation','Nature','Science']},ab:{1:['Eureka (gain points on Int/Wis failures)','Choose Discovery feat'],2:['Apt Analogy (+TD to ally checks)','Great Mind (immune to charm, advantage vs lies)'],3:['Cross-discipline Studies (half prof to non-proficient)','Choose 2nd Discovery feat'],4:['Resilient Mind (reduce mental damage)','Ability Score Improvement'],5:['Casual Genius (start with Eureka points)','For Science! (Eureka for Cha)','Choose 3rd Discovery feat']},fc:{1:{t:'discovery',c:1},3:{t:'discovery',c:1},5:{t:'discovery',c:1}}},
                'Scout': {hd:10,hpl:6,db:1,p:{a:['Light Armor'],w:['Common Weapons','Martial Arts','Bows','Sidearms','Longarms'],t:['Camo Kit','Explosives'],sv:['Constitution','Dexterity'],sk:['Perception','Stealth','Survival']},ab:{1:['Survivalist (resistance to environmental damage)','Choose Field Hack feat'],2:['Vanguard (+1d6 damage within 5m)','Trap Rigging (set traps as action)'],3:['Uncanny Dodge (reaction for resistance)','Scout\'s Cunning (bonus action dash/disengage/hide)'],4:['Ability Score Improvement','Choose 2nd Field Hack feat'],5:['Evasion (half damage on Dex saves)']},fc:{1:{t:'fieldHack',c:1},4:{t:'fieldHack',c:1}}},
                'Soldier': {hd:10,hpl:6,db:1,p:{a:['Light Armor','Heavy Armor'],w:['Common Weapons','Martial Arts','Sidearms','Longarms'],t:['Camo Kit','Explosives'],sv:['Strength','Constitution'],sk:['Athletics','Intimidation','Pilot']},ab:{1:['Tactical Flexibility (activate unknown tactic)','Choose Tactic feat'],2:['Surge (extra action, once per rest)','Rally (heal TD HP when wounded at combat start)'],3:['Martial Training (min d8 melee damage)','Improved Critical (19-20 with chosen weapon)'],4:['Ability Score Improvement','Choose 2nd Tactic feat'],5:['Tactical Superiority (two tactics active)']},fc:{1:{t:'tactic',c:1},4:{t:'tactic',c:1}}}
            },

            origins: {
                biome: ['Lunar|Dexterity +1|Eager Astronomer: Advantage on Science checks pertaining to astronomy','Arboreal|Strength +1|Natural Climber: Climb speed of 6m','Mountainous|Strength +1|Vertical Drop: Half falling damage','Artificial|Wisdom +1|Life or Death Repairs: Advantage on engineering when failure would deal damage','Oceanic|Wisdom +1|Gifted Swimmer: Swim speed of 6m','Desert|Charisma +1|Heat Acclimated: Resistance to fire damage','Rainforest|Charisma +1|Tropics Adept: No disadvantage from rain or fog','Grasslands|Constitution +1|Natural Sprinter: +1m movement speed','Starship|Dexterity +1|Void Adept: Use Wis for Science checks','Terraformed|Intelligence +1|Strange World: 1/day reaction for advantage on save','Swamp|Wisdom +1|Patient Hunter: Use Wis for Stealth checks','Toxic|Constitution +1|Toxic Resistance: Resist poison or necrotic (choose one)','Urban|Intelligence +1|Melting Pot: Use Cha for Culture checks','Tundra|Constitution +1|Cold Acclimated: Resistance to cold damage','Volcanic|Strength +1|Heat Acclimated: Resistance to fire damage','Subterranean|Dexterity +1|Improved Vision: Dim light counts as bright'].map(s => {const [n,at,ab] = s.split('|'); return {name:n,attribute:at,ability:ab}}),
                background: ['Enforcement|Intimidation|Air of Authority: Others have disadvantage to intimidate you','Aviator|Pilot|Crash Landing: Resistance to damage when vehicle crashes','Driver|Animal Handling|Speedster: Vehicles/animals you control gain +1 AC','Enslaved|Tool|Friend to Toil: Suffer 1 less exhaustion level (min 1)','Former Host|None|Naquadah Blooded: Can use Goa\'uld tech, advantage vs symbiotes','Entertainer|Performance|Zeitgeist: Use Cha for art/performance understanding','Freedom Fighter|Stealth|Last Resorts: Disadvantage on Moxie, advantage on Initiative','Healer|Medicine|Soothe: Team heals +Prof bonus on rest','Military|Weapon,Armor|Drills: +1 HP per level','Herdsman|Animal Handling|Beastfriend: Use Cha instead of Wis for Animal Handling','Preservationist|Nature|Eye for Nature: Advantage on checks to identify plants','Hunter/Gatherer|Survival|Irongut: Advantage vs poison','Politician|Persuasion|Two Faces: Use Int instead of Cha for Deception','Liaison|Culture|Stranger to the Land: Advantage on Cha checks to hide foreign nature','Refugee|Athletics|New Environments: Advantage on Athletics in unknown wilderness','Merchant|Insight|Efficient Logistics: +1 bulk capacity','Sailor|Acrobatics|Sea Legs: Advantage to maintain balance','Swindler|Deception|Low Profile: Use Deception for Stealth in populated areas','Scholar|Science|Preserve Knowledge: Advantage on Persuasion with scholars','Teacher|Insight|Patient Approach: 1/mission use Wis save instead of another','Sentry|Perception|Long Night: Ignore first night without rest','Wright|Engineering|Measure Twice: Half prof bonus on non-proficient tools','Sleuth|Investigation|The Reveal: Advantage on Persuasion to accuse wrongdoing','Underworld|Sleight of Hand|Black Market: Advantage contacting underworld members','Student|Perception|Quick Study: 1/mission use Int save instead of another'].map(s => {const [n,p,ab] = s.split('|'); return {name:n,proficiency:p.includes(',') ? {type:'choice',options:p.split(',')} : p,ability:ab}}),
                racial: {
                    'Human': [{name:'Tau\'ri Military',attribute:'None',proficiency:{type:'choice',options:['Martial Arts','Longarms','Heavy Armor']},ability:'Basic Training: Chosen proficiency from military service'}],
                    'Jaffa': [{name:'Jaffa Renegade',attribute:'Wisdom +1',ability:'Rebel: Advantage on saves vs Goa\'uld and Jaffa'},{name:'Student of Bra\'tac',attribute:'Dexterity +1',ability:'Ma\'tok Mastery: Ma\'tok gains finesse property'}],
                    'Aturen': [{name:'Aturen Spiritualist',attribute:'None',ability:'Ritual of Life: DC 20 Culture check to resurrect'}],
                    'Tok\'ra': [{name:'Tok\'ra Spy',attribute:'Charisma +1',ability:'Passing: Advantage on Deception as Human/Goa\'uld/Jaffa'}],
                    'Unas': [{name:'Unas Alpha',attribute:'Charisma +1',ability:'Clan Leader: Other Unas gain advantage on saves/attacks'}]
                }
            },

            skills: ['Acrobatics','Athletics','Culture','Deception','Engineering','Insight','Intimidation','Investigation','Medicine','Nature','Perception','Performance','Persuasion','Pilot','Science','Sleight of Hand','Stealth','Survival'],
            weapons: ['Common Weapons','Bows','Martial Arts','Sidearms','Shotguns','Longarms','Grenades','Heavy Ordinance','Jaffa Weapons'],
            armor: ['Light Armor','Medium Armor','Heavy Armor','Shields'],
            tools: ['Camo Kit','Explosives','Med Kit','Research Kit','Surgical Kit','Translator','Thieves\' Tools','Tok\'ra tunneling crystals','Engineering tools']
        };

        // State
        let state = {
            character: {
                name: '',
                race: '',
                subrace: '',
                abilityChoice: '',
                origins: [],
                originChoices: {},
                raceChoices: {},
                class: '',
                level: 1,
                classFeats: [],
                duplicateProficiencyChoices: {},
                abilityScoreImprovements: {},
                abilityScores: {strength:10,dexterity:10,constitution:10,intelligence:10,wisdom:10,charisma:10},
                hp: 0,
                maxHp: 0,
                determinationPoints: 0,
                armorClass: 10,
                speed: 6,
                initiative: 0,
                moxie: 0,
                proficiencies: {armor:[],weapons:[],tools:[],saves:[],skills:[]},
                bonusFeats: []
            },
            showClassFeats: true,
            showClassAbilities: true,
            attackSpecialistChoice: ''
        };

        // Utility functions
        const getModifier = score => Math.floor((score - 10) / 2);
        const getProficiencyBonus = level => level <= 4 ? 2 : level <= 8 ? 3 : level <= 12 ? 4 : level <= 16 ? 5 : 6;
        const pointBuyCost = {8:0,9:1,10:2,11:3,12:4,13:5,14:7,15:9};
        const getPointsSpent = () => Object.values(state.character.abilityScores).reduce((sum, score) => sum + (pointBuyCost[score] || 0), 0);

        // Template helpers
        const el = (tag, attrs, children) => {
            const attributes = Object.entries(attrs || {}).map(([k, v]) => `${k}="${v}"`).join(' ');
            return `<${tag} ${attributes}>${children || ''}</${tag}>`;
        };

        const btn = (data, classes, content, disabled = false) => {
            const dataAttrs = Object.entries(data || {}).map(([k, v]) => `data-${k}="${v}"`).join(' ');
            return el('button', {
                class: classes,
                ...disabled && {disabled: 'disabled'}
            }, content) + (dataAttrs ? `<script>document.currentScript.previousElementSibling.setAttribute('${dataAttrs.split(' ')[0]}', '${dataAttrs.split('"')[1]}')</script>` : '');
        };

        const btnClasses = (selected, enabled = true, special = '') => {
            const base = 'transition-all';
            if (special) return `${base} ${special}`;
            if (selected) return `${base} border-2 ${enabled ? 'border-blue-500 bg-blue-500/20 text-white' : 'border-gray-600 bg-gray-800 opacity-50'}`;
            return `${base} border-2 ${enabled ? 'border-gray-600 bg-gray-800 text-gray-300 hover:border-gray-500' : 'border-gray-600 bg-gray-800 opacity-50 cursor-not-allowed'}`;
        };

        const section = (title, content, classes = 'bg-gray-700/50') => 
            el('div', {class: `${classes} rounded-lg p-4`}, content);

        const grid = (cols, content, gap = 3) => 
            el('div', {class: `grid grid-cols-${cols.split('/').join(' md:grid-cols-')} gap-${gap}`}, content);

        // Complex utility functions
        const getAllSkillProficiencies = () => {
            const skills = [];
            const c = state.character;
            
            if (c.class) {
                gameData.classes[c.class].p.sk.forEach(s => skills.push({skill:s, source:'Class'}));
            }
            
            const rd = gameData.races[c.race]?.[c.subrace];
            if (rd?.p?.skills) {
                if (rd.p.skills.t === 'mixed' && rd.p.skills.f) {
                    rd.p.skills.f.forEach(s => skills.push({skill:s, source:'Race'}));
                }
                if (c.raceChoices.skills) {
                    c.raceChoices.skills.forEach(s => skills.push({skill:s, source:'Race Choice'}));
                }
                if (c.raceChoices.additionalSkills) {
                    c.raceChoices.additionalSkills.forEach(s => skills.push({skill:s, source:'Race Choice'}));
                }
            }
            
            c.origins.forEach(o => {
                const bg = gameData.origins.background.find(b => b.name === o);
                if (bg?.proficiency && typeof bg.proficiency === 'string' && gameData.skills.includes(bg.proficiency)) {
                    skills.push({skill:bg.proficiency, source:o});
                }
            });
            
            return skills;
        };

        const findDuplicateProficiencies = () => {
            const counts = {};
            const dups = [];
            getAllSkillProficiencies().forEach(({skill, source}) => {
                (counts[skill] = counts[skill] || []).push(source);
            });
            Object.entries(counts).forEach(([skill, sources]) => {
                for (let i = 1; i < sources.length; i++) {
                    dups.push({skill, source: sources[i]});
                }
            });
            return dups;
        };

        const getFinalSkillProficiencies = () => {
            const skills = new Set();
            getAllSkillProficiencies().forEach(({skill}) => skills.add(skill));
            Object.values(state.character.duplicateProficiencyChoices).forEach(s => s && skills.add(s));
            return Array.from(skills);
        };

        const canSelectFieldHack = feat => {
            if (state.character.class !== 'Scout' || !feat.requirements) return true;
            return getFinalSkillProficiencies().includes(feat.requirements);
        };

        const getAbilityBonuses = ability => {
            let racial = 0, origin = 0, asi = 0;
            const c = state.character;
            const rd = gameData.races[c.race]?.[c.subrace];
            
            if (rd?.ab?.t === 'choice' && c.abilityChoice === ability) racial = rd.ab.v;
            
            c.origins.forEach(o => {
                [...gameData.origins.biome, ...Object.values(gameData.origins.racial).flat()].forEach(orig => {
                    if (orig.name === o && orig.attribute !== 'None') {
                        const [attr, val] = orig.attribute.split(' +');
                        if (attr.toLowerCase() === ability) origin += parseInt(val);
                    }
                });
            });
            
            if (c.level >= 4) {
                Object.values(c.abilityScoreImprovements).forEach(imp => {
                    if (imp === ability) asi += 1;
                    else if (imp === `${ability}_2`) asi += 2;
                });
            }
            
            return {racial, origin, asi};
        };

        const getFinalAbilityScores = () => {
            const scores = {...state.character.abilityScores};
            Object.keys(scores).forEach(a => {
                const {racial, origin, asi} = getAbilityBonuses(a);
                scores[a] += racial + origin + asi;
            });
            return scores;
        };

        const updateDerivedStats = () => {
            const c = state.character;
            const rd = gameData.races[c.race]?.[c.subrace];
            const cd = gameData.classes[c.class];
            const fs = getFinalAbilityScores();
            const mods = Object.fromEntries(Object.entries(fs).map(([k,v]) => [k, getModifier(v)]));
            
            if (rd && cd) {
                const hpBase = cd.hd + mods.constitution + rd.hp + (c.origins.includes('Military') ? c.level : 0);
                c.hp = c.maxHp = Math.max(1, hpBase + (c.level > 1 ? (c.level - 1) * (cd.hpl + mods.constitution) : 0));
            }
            
            c.armorClass = 10 + mods.dexterity;
            c.initiative = Math.max(mods.dexterity, mods.wisdom);
            c.moxie = Math.max(mods.intelligence, mods.charisma);
            c.speed = c.origins.includes('Grasslands') ? 7 : 6;
            c.determinationPoints = Math.floor((c.level + 4) / 5) * 2 + (cd?.db || 0);
        };

        // Rendering functions
        const renderSelectionGrid = (items, type, cols = '2/3', selected = () => false, enabled = () => true) => {
            return grid(cols, items.map(item => {
                const data = typeof item === 'object' ? item : {name: item};
                const isSelected = selected(data);
                const isEnabled = enabled(data);
                const attrs = {[`data-${type}`]: data.name};
                
                return el('button', {
                    ...Object.fromEntries(Object.entries(attrs).map(([k,v]) => [k.replace('data-','data-'), v])),
                    class: `${type}-btn p-3 rounded-lg ${btnClasses(isSelected, isEnabled)}`
                }, `
                    <div class="font-semibold">${data.name}</div>
                    ${data.subtitle ? `<div class="text-xs mt-1 opacity-75">${data.subtitle}</div>` : ''}
                `);
            }).join(''));
        };

        const renderSkillGrid = (skills, selectedSkills, max, prefix) => {
            return grid('3/4', skills.map(skill => {
                const isSelected = selectedSkills?.includes(skill);
                const maxReached = (selectedSkills?.length || 0) >= max;
                
                return el('button', {
                    [`data-${prefix}`]: skill,
                    class: `${prefix}-btn p-2 rounded text-xs ${btnClasses(isSelected, !maxReached || isSelected)}`
                }, skill);
            }).join(''), 2);
        };

        const renderFeats = () => {
            const c = state.character;
            const cd = gameData.classes[c.class];
            if (!cd?.fc) return '';
            
            let required = 0, type = null;
            Object.entries(cd.fc).forEach(([lvl, choice]) => {
                if (parseInt(lvl) <= c.level) {
                    required += choice.c;
                    type = choice.t;
                }
            });
            
            if (!required) return '';
            
            const feats = type === 'fieldHack' ? gameData.fieldHackFeats : gameData.classFeatsByType[type];
            
            return section('Class Feat Selection', `
                <div id="toggle-feats" class="flex items-center justify-between cursor-pointer">
                    <h3 class="text-lg font-semibold text-gray-300 flex items-center gap-2">
                        ${icons.sparkles} Class Feat Selection
                    </h3>
                    <span class="${state.showClassFeats ? 'rotate-180' : ''} transition-transform">${icons.chevronDown}</span>
                </div>
                ${state.showClassFeats ? `
                    <p class="text-sm text-gray-400 mb-4 mt-3">
                        Select ${required} ${type === 'fieldHack' ? 'Field Hack' : type} feat${required > 1 ? 's' : ''}
                    </p>
                    <div class="space-y-2">
                        ${feats.map(feat => {
                            const selected = c.classFeats.includes(feat.name);
                            const canSel = c.classFeats.length < required && !selected;
                            const meets = canSelectFieldHack(feat);
                            
                            return el('button', {
                                'data-feat': feat.name,
                                class: `feat-btn w-full text-left p-3 rounded border ${
                                    selected ? 'border-purple-500 bg-purple-500/20' :
                                    !meets ? 'border-red-700 bg-red-900/20 opacity-60 cursor-not-allowed' :
                                    canSel ? 'border-gray-600 bg-gray-800 hover:border-gray-500' :
                                    'border-gray-700 bg-gray-900/50 opacity-50 cursor-not-allowed'
                                }`,
                                ...(!meets || (!canSel && !selected)) && {disabled: 'disabled'}
                            }, `
                                <div class="font-semibold text-sm text-white">
                                    ${feat.name} ${!meets ? `<span class="text-xs text-red-400">${icons.lock} Requires ${feat.requirements}</span>` : ''}
                                </div>
                                <div class="text-xs text-gray-400 mt-1">${feat.description}</div>
                                ${selected ? '<div class="text-purple-400">✓</div>' : ''}
                            `);
                        }).join('')}
                    </div>
                    <div class="mt-4 text-sm text-gray-400">Selected: ${c.classFeats.length}/${required}</div>
                ` : ''}
            `);
        };

        const render = () => {
            updateDerivedStats();
            const c = state.character;
            const rd = gameData.races[c.race]?.[c.subrace];
            const cd = gameData.classes[c.class];
            const fs = getFinalAbilityScores();
            const ps = getPointsSpent();
            const dups = findDuplicateProficiencies();
            
            document.getElementById('app').innerHTML = `
                <div class="max-w-7xl mx-auto">
                    <div class="bg-gray-800/90 backdrop-blur-sm rounded-lg shadow-2xl border border-blue-500/30">
                        <div class="bg-gradient-to-r from-blue-600 to-purple-600 p-6 rounded-t-lg">
                            <h1 class="text-3xl font-bold text-white flex items-center gap-3">
                                <div class="w-10 h-10 bg-white/20 rounded-full flex items-center justify-center">${icons.target}</div>
                                Stargate RPG Character Builder
                            </h1>
                            <p class="text-blue-100 mt-2">Create your Phoenix Site operative (Levels 1-5)</p>
                        </div>
                        
                        <div class="p-6 space-y-6">
                            ${section('Character Name', `
                                <input id="character-name" value="${c.name}" class="w-full px-4 py-2 bg-gray-800 border border-gray-600 rounded-lg text-white" placeholder="Enter character name..."/>
                            `)}
                            
                            ${section('Select Race', renderSelectionGrid(
                                Object.keys(gameData.races).map(r => ({
                                    name: r,
                                    subtitle: `${Object.keys(gameData.races[r]).length} variant(s)`
                                })),
                                'race', '2/3',
                                item => c.race === item.name
                            ))}
                            
                            ${c.race ? section('Select ' + c.race + ' Variant', 
                                Object.entries(gameData.races[c.race]).map(([name, data]) => el('div', {
                                    'data-subrace': name,
                                    class: `subrace-btn p-4 rounded-lg border-2 cursor-pointer ${btnClasses(c.subrace === name)}`
                                }, `
                                    <div class="font-semibold text-white mb-2">${name}</div>
                                    <div class="text-xs text-gray-400">HP: +${data.hp} | ${
                                        data.ab.t === 'choice' ? 
                                        `Choose +${data.ab.v} to ${data.ab.o.join('/')}` : 
                                        'Fixed bonuses'
                                    }</div>
                                    <ul class="text-xs text-gray-400 mt-2">
                                        ${data.a.map(a => `<li>• ${a}</li>`).join('')}
                                    </ul>
                                `)).join('')
                            ) : ''}
                            
                            ${rd?.ab?.t === 'choice' && !c.abilityChoice ? section('Choose Ability Score Increase', 
                                grid('2/3', rd.ab.o.map(a => el('button', {
                                    'data-ability-choice': a,
                                    class: `ability-choice-btn p-3 rounded capitalize ${btnClasses(c.abilityChoice === a)}`
                                }, a)), 2),
                                'bg-yellow-500/20 border-2 border-yellow-500'
                            ) : ''}
                            
                            ${rd?.p?.skills ? section('Choose Skills', 
                                rd.p.skills.t === 'choice' ? 
                                renderSkillGrid(gameData.skills, c.raceChoices.skills, rd.p.skills.c, 'race-skill') :
                                rd.p.skills.t === 'mixed' ? `
                                    <div class="mb-4">Fixed: ${rd.p.skills.f.join(', ')}</div>
                                    ${rd.p.skills.ac ? renderSkillGrid(
                                        gameData.skills.filter(s => !rd.p.skills.f.includes(s)),
                                        c.raceChoices.additionalSkills, rd.p.skills.ac.c, 'additional-skill'
                                    ) : ''}
                                ` : ''
                            ) : ''}
                            
                            ${section('Select Origins', `
                                <p class="text-sm text-gray-400 mb-4">Choose 2 from different categories</p>
                                ${['biome', 'background'].map(type => `
                                    <div class="mb-4">
                                        <h3 class="text-sm font-semibold text-gray-400 mb-2">${type[0].toUpperCase() + type.slice(1)}</h3>
                                        ${grid('1/2/3', gameData.origins[type].map(o => {
                                            const sel = c.origins.includes(o.name);
                                            const hasType = c.origins.some(x => gameData.origins[type].find(y => y.name === x));
                                            const dis = !sel && (c.origins.length >= 2 || hasType);
                                            
                                            return el('button', {
                                                'data-origin': o.name,
                                                'data-origin-type': type,
                                                class: `origin-btn p-3 text-left rounded border ${btnClasses(sel, !dis)}`
                                            }, `
                                                <div class="font-semibold text-sm text-white">${o.name}</div>
                                                <div class="text-xs text-green-400">${o.attribute || o.proficiency}</div>
                                                <div class="text-xs text-gray-400">${o.ability}</div>
                                            `);
                                        }).join(''), 2)}
                                    </div>
                                `).join('')}
                                ${c.race && gameData.origins.racial[c.race] ? `
                                    <h3 class="text-sm font-semibold text-gray-400 mb-2">Racial Origins</h3>
                                    ${grid('1/2', gameData.origins.racial[c.race].map(o => {
                                        const sel = c.origins.includes(o.name);
                                        return el('button', {
                                            'data-origin': o.name,
                                            'data-origin-type': 'racial',
                                            class: `origin-btn p-3 text-left rounded border ${btnClasses(sel, c.origins.length < 2 || sel)}`
                                        }, `
                                            <div class="font-semibold text-sm text-white">${o.name}</div>
                                            <div class="text-xs text-green-400">${o.attribute}</div>
                                            <div class="text-xs text-gray-400">${o.ability}</div>
                                        `);
                                    }).join(''), 2)}
                                ` : ''}
                            `)}
                            
                            ${section('Select Class', renderSelectionGrid(
                                Object.entries(gameData.classes).map(([name, data]) => ({
                                    name,
                                    subtitle: `HD: d${data.hd}, DP: +${data.db}`
                                })),
                                'class', '2/3',
                                item => c.class === item.name
                            ))}
                            
                            ${cd ? section('Class Info', grid('1/2', [
                                ['Combat', `HD: d${cd.hd}, HP/Lvl: ${cd.hpl}+Con, Det: +${cd.db}`],
                                ['Saves', cd.p.sv.join(', ')],
                                ['Armor', cd.p.a.join(', ')],
                                ['Weapons', cd.p.w.join(', ')],
                                ['Tools', cd.p.t.join(', ')],
                                ['Skills', cd.p.sk.join(', ')]
                            ].map(([title, content]) => 
                                el('div', {class: 'bg-gray-800 rounded p-3'}, `
                                    <div class="text-xs font-semibold text-purple-400 mb-1">${title}</div>
                                    <div class="text-xs text-gray-300">${content}</div>
                                `)
                            ).join(''), 3)) : ''}
                            
                            ${section('Character Level', grid('5', [1,2,3,4,5].map(lvl => 
                                el('button', {
                                    'data-level': lvl,
                                    class: `level-btn px-3 py-2 rounded-lg border-2 text-sm ${btnClasses(c.level === lvl)}`
                                }, lvl)
                            ).join(''), 2))}
                            
                            ${renderFeats()}
                            
                            ${dups.length ? section('Duplicate Proficiencies', 
                                dups.map((dup, i) => `
                                    <div class="mb-4">
                                        <label class="text-sm text-yellow-100">Replace ${dup.skill} (from ${dup.source})</label>
                                        ${renderSkillGrid(
                                            gameData.skills.filter(s => !getFinalSkillProficiencies().includes(s) || c.duplicateProficiencyChoices[`dup_${i}`] === s),
                                            [c.duplicateProficiencyChoices[`dup_${i}`]],
                                            1,
                                            `duplicate-${i}`
                                        )}
                                    </div>
                                `).join(''),
                                'bg-yellow-500/20 border-2 border-yellow-500'
                            ) : ''}
                            
                            ${section('Ability Scores', `
                                <div class="flex justify-between mb-4">
                                    <span class="text-sm text-gray-300">Point Buy</span>
                                    <span class="${ps > 27 ? 'text-red-300' : 'text-green-300'} text-sm">Points: ${ps}/27</span>
                                </div>
                                ${grid('2/3', Object.entries(c.abilityScores).map(([ability, score]) => {
                                    const {racial, origin, asi} = getAbilityBonuses(ability);
                                    const bonus = racial + origin + asi;
                                    const final = score + bonus;
                                    return el('div', {class: 'bg-gray-800 rounded-lg p-3'}, `
                                        <div class="flex justify-between mb-2">
                                            <span class="text-xs text-gray-400 capitalize">${ability}</span>
                                            <span class="text-xs text-blue-300">Final: ${final} (${getModifier(final) >= 0 ? '+' : ''}${getModifier(final)})</span>
                                        </div>
                                        <div class="flex items-center gap-2">
                                            <button data-ability="${ability}" data-action="decrease" class="ability-btn w-8 h-8 bg-gray-700 rounded ${score <= 8 ? 'opacity-50' : 'hover:bg-gray-600'}" ${score <= 8 ? 'disabled' : ''}>-</button>
                                            <div class="flex-1 text-center">
                                                <div class="text-lg font-bold text-white">${score}</div>
                                                ${bonus ? `<div class="text-xs text-green-400">+${bonus}</div>` : ''}
                                            </div>
                                            <button data-ability="${ability}" data-action="increase" class="ability-btn w-8 h-8 bg-gray-700 rounded ${score >= 15 || ps >= 27 ? 'opacity-50' : 'hover:bg-gray-600'}" ${score >= 15 || ps >= 27 ? 'disabled' : ''}>+</button>
                                        </div>
                                    `);
                                }).join(''), 4)}
                            `)}
                            
                            ${section('Combat Stats', grid('2/3', [
                                ['Hit Points', c.hp, icons.heart, 'text-red-400'],
                                ['Armor Class', c.armorClass, icons.shield, 'text-blue-400'],
                                ['Initiative', `${c.initiative >= 0 ? '+' : ''}${c.initiative}`, icons.zap, 'text-yellow-400'],
                                ['Determination', c.determinationPoints, icons.brain, 'text-purple-400'],
                                ['Speed', `${c.speed}m`, icons.activity, 'text-green-400'],
                                ['Moxie', `${c.moxie >= 0 ? '+' : ''}${c.moxie}`, icons.user, 'text-cyan-400']
                            ].map(([label, value, icon, color]) => 
                                el('div', {class: 'bg-gray-800 rounded-lg p-3'}, `
                                    <div class="flex items-center gap-2 ${color} mb-1">
                                        <span class="icon icon-md">${icon}</span>
                                        <span class="text-xs">${label}</span>
                                    </div>
                                    <div class="text-2xl font-bold text-white">${value}</div>
                                `)
                            ).join(''), 4))}
                            
                            <div class="flex justify-end">
                                <button id="export-btn" class="px-6 py-3 bg-gradient-to-r from-blue-600 to-purple-600 text-white font-semibold rounded-lg hover:from-blue-700 hover:to-purple-700 flex items-center gap-2">
                                    ${icons.download} Export Character Sheet
                                </button>
                            </div>
                        </div>
                    </div>
                </div>
            `;
            
            attachEventListeners();
        };

        // Event listeners
        const attachEventListeners = () => {
            const on = (selector, event, handler) => {
                document.querySelectorAll(selector).forEach(el => el.addEventListener(event, handler));
            };
            
            document.getElementById('character-name')?.addEventListener('input', e => {
                state.character.name = e.target.value;
            });
            
            on('.race-btn', 'click', e => {
                state.character.race = e.currentTarget.dataset.race;
                state.character.subrace = '';
                state.character.abilityChoice = '';
                state.character.raceChoices = {};
                render();
            });
            
            on('.subrace-btn', 'click', e => {
                state.character.subrace = e.currentTarget.dataset.subrace;
                state.character.abilityChoice = '';
                state.character.raceChoices = {};
                render();
            });
            
            on('.ability-choice-btn', 'click', e => {
                state.character.abilityChoice = e.currentTarget.dataset.abilityChoice;
                render();
            });
            
            on('.race-skill-btn', 'click', e => {
                const skill = e.currentTarget.dataset.raceSkill;
                const skills = state.character.raceChoices.skills || [];
                const rd = gameData.races[state.character.race]?.[state.character.subrace];
                const max = rd?.p?.skills?.c || 1;
                
                if (skills.includes(skill)) {
                    state.character.raceChoices.skills = skills.filter(s => s !== skill);
                } else if (skills.length < max) {
                    state.character.raceChoices.skills = [...skills, skill];
                }
                render();
            });
            
            on('.additional-skill-btn', 'click', e => {
                const skill = e.currentTarget.dataset.additionalSkill;
                const skills = state.character.raceChoices.additionalSkills || [];
                const rd = gameData.races[state.character.race]?.[state.character.subrace];
                const max = rd?.p?.skills?.ac?.c || 1;
                
                if (skills.includes(skill)) {
                    state.character.raceChoices.additionalSkills = skills.filter(s => s !== skill);
                } else if (skills.length < max) {
                    state.character.raceChoices.additionalSkills = [...skills, skill];
                }
                render();
            });
            
            on('.origin-btn', 'click', e => {
                const name = e.currentTarget.dataset.origin;
                const type = e.currentTarget.dataset.originType;
                const c = state.character;
                
                if (c.origins.includes(name)) {
                    c.origins = c.origins.filter(o => o !== name);
                    delete c.originChoices[name];
                } else if (c.origins.length < 2) {
                    const hasType = c.origins.some(o => 
                        gameData.origins[type].find(x => x.name === o)
                    );
                    if (!hasType) c.origins.push(name);
                }
                render();
            });
            
            on('.class-btn', 'click', e => {
                state.character.class = e.currentTarget.dataset.class;
                state.character.classFeats = [];
                render();
            });
            
            on('.level-btn', 'click', e => {
                state.character.level = parseInt(e.currentTarget.dataset.level);
                render();
            });
            
            on('.feat-btn', 'click', e => {
                const feat = e.currentTarget.dataset.feat;
                const c = state.character;
                const cd = gameData.classes[c.class];
                let max = 0;
                
                Object.entries(cd.fc || {}).forEach(([lvl, choice]) => {
                    if (parseInt(lvl) <= c.level) max += choice.c;
                });
                
                if (c.classFeats.includes(feat)) {
                    c.classFeats = c.classFeats.filter(f => f !== feat);
                } else if (c.classFeats.length < max) {
                    c.classFeats.push(feat);
                }
                render();
            });
            
            on('.ability-btn', 'click', e => {
                const ability = e.currentTarget.dataset.ability;
                const action = e.currentTarget.dataset.action;
                const c = state.character;
                const current = c.abilityScores[ability];
                
                if (action === 'increase' && current < 15) {
                    const newCost = getPointsSpent() + (pointBuyCost[current + 1] - pointBuyCost[current]);
                    if (newCost <= 27) c.abilityScores[ability]++;
                } else if (action === 'decrease' && current > 8) {
                    c.abilityScores[ability]--;
                }
                render();
            });
            
            [...Array(10)].forEach((_, i) => {
                on(`.duplicate-${i}-btn`, 'click', e => {
                    const skill = e.currentTarget.dataset[`duplicate${i}`];
                    state.character.duplicateProficiencyChoices[`dup_${i}`] = skill;
                    render();
                });
            });
            
            document.getElementById('toggle-feats')?.addEventListener('click', () => {
                state.showClassFeats = !state.showClassFeats;
                render();
            });
            
            document.getElementById('export-btn')?.addEventListener('click', () => {
                const c = state.character;
                const sheet = `STARGATE RPG CHARACTER SHEET\n${'='.repeat(30)}\n` +
                    `Name: ${c.name}\nRace: ${c.race} (${c.subrace})\n` +
                    `Origins: ${c.origins.join(', ')}\nClass: ${c.class}\nLevel: ${c.level}\n\n` +
                    `ABILITIES\n${Object.entries(getFinalAbilityScores()).map(([a,v]) => 
                        `${a}: ${v} (${getModifier(v) >= 0 ? '+' : ''}${getModifier(v)})`
                    ).join('\n')}\n\n` +
                    `COMBAT\nHP: ${c.hp}/${c.maxHp}\nAC: ${c.armorClass}\n` +
                    `Initiative: ${c.initiative >= 0 ? '+' : ''}${c.initiative}\n` +
                    `Speed: ${c.speed}m\nDP: ${c.determinationPoints}\nMoxie: ${c.moxie >= 0 ? '+' : ''}${c.moxie}\n\n` +
                    `SKILLS\n${getFinalSkillProficiencies().join(', ')}\n\n` +
                    `CLASS FEATS\n${c.classFeats.join('\n')}`;
                
                const blob = new Blob([sheet], {type: 'text/plain'});
                const a = document.createElement('a');
                a.href = URL.createObjectURL(blob);
                a.download = `${c.name || 'character'}_sheet.txt`;
                a.click();
            });
        };

        // Initialize
        render();
    </script>
</body>
</html>
